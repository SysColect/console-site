import{j as o,r as l,a as j,z as u,q as R,b as N,d as A,C as L,g as m,Q as M,h as S,i as $,k as O}from"./index-DLja3hGy.js";import{T as P}from"./ToolPageLayout-BXICLrQ5.js";import{f as g}from"./dateUtils-Lijm-n4x.js";const q=()=>{const r=!l.useContext(j)?.values?.id;return o.jsxs(o.Fragment,{children:[o.jsx(u,{name:"id",label:"ID do Usuário",formField:!0,disabled:!0}),o.jsx(u,{name:"name",label:"Nome",formField:!0}),o.jsx(u,{name:"email",label:"Email",formField:!0,disabled:!r,required:r}),o.jsx(u,{name:"inclusionDate",label:"Data de Inclusão",type:"date",formField:!0,disabled:!0}),o.jsx(u,{name:"inactivationDate",label:"Data de Inativação",type:"date",formField:!0})]})},z=()=>o.jsx(q,{}),B=n=>{const r={};return n.name||(r.name="O nome é obrigatório"),n.email?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n.email)||(r.email="Email inválido"):r.email="O email é obrigatório",r},G=()=>Math.floor(1e7+Math.random()*9e7).toString(),_=()=>{const[n,r]=l.useState([]),[D,v]=l.useState(!0),[E,x]=l.useState(null),{showConfirmation:U,showAlert:f}=R(),c=l.useMemo(()=>N.getRepository("user",A.Firestore,L.NoCache),[]),h=l.useCallback(async()=>{v(!0),x(null);try{const a=await c.getAll({sort:{field:"name",direction:"asc"}});r(a)}catch(a){m.error("Error fetching users",{error:a}),x("Falha ao carregar usuários. Por favor, tente novamente mais tarde.")}finally{v(!1)}},[c]);l.useEffect(()=>{h()},[h]);const y=[{field:"id",headerName:"ID do Usuário",width:200},{field:"name",headerName:"Nome",width:250},{field:"email",headerName:"Email",width:250},{field:"inclusionDate",headerName:"Data de Inclusão",width:180,valueGetter:a=>g(a)?.toLocaleDateString("pt-BR")||"-"},{field:"inactivationDate",headerName:"Data de Inativação",width:180,valueGetter:a=>a?g(a)?.toLocaleDateString("pt-BR"):"-"}],w=n.map(a=>{const t=a.inclusionDate&&g(a.inclusionDate)?.toISOString().split("T")[0]||null,e=a.inactivationDate&&g(a.inactivationDate)?.toISOString().split("T")[0]||null;return{id:a.id,name:a.name||"",email:a.email||"",inclusionDate:t,inactivationDate:e,_original:a}}),I=async(a,t)=>{const e={...a},s=e.id;if(delete e.id,e.inactivationDate){const i=new Date(e.inactivationDate);isNaN(i.getTime())?e.inactivationDate=null:e.inactivationDate=S.fromDate(i)}else e.inactivationDate=null;try{if(t){const i=G(),p=(await $.getAuthService(void 0,O).createUser(e.email,i)).user.uid;e.inclusionDate=S.now();const F=await c.create({...e,id:p});r(T=>[...T,F]),m.info("Usuário criado",{userId:p,email:e.email,name:e.name});const C=`Email: ${e.email}
Senha: ${i}`;f({title:"Usuário Criado",message:`Usuário criado com sucesso!

Email: ${e.email}
Senha: ${i}

IMPORTANTE: Anote esta senha, ela não será exibida novamente.`,copyText:C})}else{if(!s){f({title:"Erro",message:"ID do usuário não encontrado."});return}delete e.inclusionDate,await c.update(s,e),r(i=>i.map(d=>d.id===s?{...d,...e,id:s}:d)),m.info("Usuário alterado",{userId:s,email:e.email||n.find(i=>i.id===s)?.email,name:e.name,changes:e}),h()}}catch(i){m.error("Error saving user",{error:i,isNew:t,userId:t?void 0:s,email:e.email});const d=i instanceof Error?i.message:"Falha ao salvar o usuário.";f({title:"Erro",message:d})}},b=a=>{const t=a._original||n.find(e=>e.id===a.id);t&&U({title:"Confirmar Exclusão",message:`Tem certeza que deseja excluir o usuário ${t.email}? Esta ação não pode ser desfeita.`,onConfirm:async()=>{try{await c.delete(t.id),r(n.filter(e=>e.id!==t.id)),m.info("Usuário excluído",{userId:t.id,email:t.email,name:t.name})}catch(e){m.error("Error deleting user",{error:e,userId:t.id,email:t.email}),f({title:"Erro",message:"Falha ao excluir usuário. Por favor, tente novamente mais tarde."})}}})};return o.jsx(P,{title:"Gerenciador de Usuários",children:o.jsx(M,{title:"Usuários",rows:w,columns:y,loading:D,error:E,initialValues:{id:"",name:"",email:"",inclusionDate:null,inactivationDate:null},dialogTitle:"Usuário",onSave:I,onDelete:b,onRefresh:h,onValidate:B,hideAddButton:!1,children:z()})})};export{_ as default};
