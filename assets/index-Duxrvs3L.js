import{r as s,g as N,j as e,D as O,a as B,b as q,A as L,T as b,h as z,i as U,k as P,z as Z,s as ee,E as _,H as se,J as te,K as ae,N as ne,O as re,C as G,x as oe,y as le,d as ie,Q as ce,e as de,l as k,m as I,u as ue,B as H,P as he,I as me,n as xe,M as W,o as fe,R as pe,U as ge}from"./index-C-WqZXiD.js";import{T as je,a as Te,b as Ce,c as $,d as E,e as De,M as Se}from"./MoreVert-DQNXZtFB.js";import{T as ye}from"./ToolPageLayout-DiBDpGeg.js";const ve=({open:c,onClose:d,user:n})=>{const[h,g]=s.useState(""),[j,C]=s.useState(""),[u,t]=s.useState(null),[x,S]=s.useState(null),D=N();s.useEffect(()=>{if(n){const r=n.name||(n.email?n.email.split("@")[0].replace(/[._]/g," ").replace(/\b\w/g,o=>o.toUpperCase()):"");g(r),C(n.email||"")}else g(""),C(""),t(null)},[n]);const f=async()=>{if(S(null),!!n)try{const r=P(D,"user",n.id),o=await Z(r),m={name:h,email:j,inactivationDate:u};(!o.exists()||!o.data()?.inclusionDate)&&(m.inclusionDate=new Date),await ee(r,m,{merge:!0}),d({...n,...m,inclusionDate:m.inclusionDate?_.fromDate(m.inclusionDate):n.inclusionDate,inactivationDate:u?_.fromDate(u):void 0})}catch(r){r instanceof Error?S(r.message):S("An unexpected error occurred."),console.error("Error updating user:",r)}},T=(r,o)=>{d()};return e.jsxs(O,{open:c,onClose:T,children:[e.jsx(B,{children:n?"Edit User":"Add User"}),e.jsxs(q,{children:[x&&e.jsx(L,{severity:"error",sx:{mb:2},children:x}),e.jsx(b,{autoFocus:!0,margin:"dense",id:"id",label:"User ID",type:"text",fullWidth:!0,disabled:!0,value:n?.id||""}),e.jsx(b,{margin:"dense",id:"name",label:"Name",type:"text",fullWidth:!0,value:h,onChange:r=>g(r.target.value)}),e.jsx(b,{margin:"dense",id:"email",label:"Email Address",type:"email",fullWidth:!0,disabled:!0,value:j}),e.jsx(b,{margin:"dense",id:"inclusionDate",label:"Inclusion Date",type:"text",fullWidth:!0,disabled:!0,value:n?.inclusionDate?n.inclusionDate instanceof Date?n.inclusionDate.toLocaleDateString():new Date(n.inclusionDate.seconds*1e3).toLocaleDateString():new Date().toLocaleDateString()}),e.jsx(b,{margin:"dense",id:"inactivationDate",label:"Inactivation Date",type:"date",fullWidth:!0,value:u?u.toISOString().split("T")[0]:"",onChange:r=>t(new Date(r.target.value)),InputLabelProps:{shrink:!0}})]}),e.jsxs(z,{children:[e.jsx(U,{onClick:()=>d(),children:"Cancel"}),e.jsx(U,{onClick:f,children:"Save"})]})]})},Ee=({open:c,onClose:d,onUserAdded:n})=>{const[h,g]=s.useState(""),[j,C]=s.useState(""),[u,t]=s.useState(null),x=s.useRef(null);s.useEffect(()=>{c&&setTimeout(()=>{x.current?.focus()},100)},[c]);const S=async()=>{if(t(null),!h||!j){t("Please fill in both email and password.");return}const f=`temp-app-${Date.now()}`,T=se(te,f),r=ae(T);try{const o=await ne(r,h,j);n(o.user.uid,h),d()}catch(o){o instanceof Error?t(o.message):t("An unexpected error occurred."),console.error("Error creating user:",o)}finally{re(T)}},D=()=>{g(""),C(""),t(null),d()};return e.jsxs(O,{open:c,onClose:D,children:[e.jsx(B,{children:"Incluir Novo Usuário"}),e.jsxs(q,{children:[u&&e.jsx(L,{severity:"error",sx:{mb:2},children:u}),e.jsx(b,{inputRef:x,autoFocus:!0,margin:"dense",id:"email",label:"Endereço de E-mail",type:"email",fullWidth:!0,variant:"standard",value:h,onChange:f=>g(f.target.value)}),e.jsx(b,{margin:"dense",id:"password",label:"Senha",type:"password",fullWidth:!0,variant:"standard",value:j,onChange:f=>C(f.target.value)})]}),e.jsxs(z,{children:[e.jsx(U,{onClick:D,children:"Cancelar"}),e.jsx(U,{onClick:S,children:"Salvar"})]})]})},be=({open:c,onClose:d,onSave:n,userId:h})=>{const[g,j]=s.useState([]),[C,u]=s.useState(!0),[t,x]=s.useState(null),[S,D]=s.useState(""),[f,T]=s.useState([]),r=N();s.useEffect(()=>{const l=async()=>{try{const p=k(r,"user",h,"consoleTools"),v=(await I(p)).docs.map(w=>w.id);T(v)}catch(p){console.error("Error fetching user tools:",p),x("Failed to load user tools. Please try again later.")}},y=async()=>{u(!0),x(null);try{const p=k(r,"consoleTool"),v=(await I(p)).docs.map(w=>({id:w.id,name:w.data().name,description:w.data().description}));j(v)}catch(p){console.error("Error fetching tools:",p),x("Failed to load tools. Please try again later.")}finally{u(!1)}};c&&(T([]),y(),l())},[c,r,h]);const o=l=>{T(y=>y.includes(l)?y.filter(p=>p!==l):[...y,l])},m=g.filter(l=>l.name.toLowerCase().includes(S.toLowerCase()));return e.jsxs(O,{open:c,onClose:d,fullWidth:!0,maxWidth:"md",children:[e.jsx(B,{children:"Manage User Tools"}),e.jsxs(q,{children:[e.jsx(b,{autoFocus:!0,margin:"dense",id:"search",label:"Search Tools",type:"text",fullWidth:!0,variant:"standard",onChange:l=>D(l.target.value)}),C?e.jsx(G,{}):t?e.jsx(L,{severity:"error",children:t}):e.jsx(oe,{children:m.map(l=>e.jsxs(le,{onClick:()=>o(l.id),children:[e.jsx(ie,{children:e.jsx(ce,{edge:"start",checked:f.includes(l.id),tabIndex:-1,disableRipple:!0})}),e.jsx(de,{primary:l.name,secondary:l.description})]},l.id))})]}),e.jsxs(z,{children:[e.jsx(U,{onClick:d,children:"Cancel"}),e.jsx(U,{onClick:()=>n(f),children:"Save"})]})]})},ke=()=>{const[c,d]=s.useState([]),[n,h]=s.useState(!0),[g,j]=s.useState(null),[C,u]=s.useState(null),[t,x]=s.useState(null),[S,D]=s.useState(!1),[f,T]=s.useState(!1),[r,o]=s.useState(!1),m=N(),{showConfirmation:l,showAlert:y}=ue(),p=s.useCallback(async()=>{h(!0),j(null);try{const a=k(m,"user"),A=(await I(a)).docs.map(F=>({id:F.id,...F.data()}));d(A)}catch(a){console.error("Error fetching users:",a),j("Falha ao carregar usuários. Tente novamente mais tarde.")}finally{h(!1)}},[m]);s.useEffect(()=>{p()},[p]);const R=(a,i)=>{u(a.currentTarget),x(i)},v=()=>{u(null)},w=()=>{D(!0),v()},J=()=>{v(),t&&l({title:"Confirmar Exclusão",message:`Tem certeza que deseja excluir o usuário ${t.email}? Esta ação não pode ser desfeita.`,onConfirm:async()=>{try{if(!t)return;const a=P(m,"user",t.id);await fe(a),await pe.deleteUser(t.id),d(c.filter(i=>i.id!==t.id))}catch(a){console.error("Error deleting user:",a),y({title:"Erro",message:"Falha ao excluir usuário. Tente novamente mais tarde."})}}})},K=()=>{o(!0),v()},Q=()=>{T(!0)},V=(a,i)=>{const A={id:a,email:i};d([A,...c]),x(A),D(!0)},X=async a=>{if(t)try{const i=ge(m),A=k(m,"user",t.id,"consoleTools");(await I(A)).forEach(M=>{i.delete(M.ref)}),a.forEach(M=>{const Y=P(A,M);i.set(Y,{})}),await i.commit()}catch(i){console.error("Error saving tools:",i),y({title:"Erro",message:"Falha ao salvar ferramentas. Tente novamente mais tarde."})}finally{o(!1)}};return e.jsx(ye,{title:"Gerenciador de Usuários",actions:e.jsx(U,{variant:"contained",color:"secondary",onClick:Q,children:"Incluir Usuário"}),children:n?e.jsx(H,{sx:{display:"flex",justifyContent:"center",mt:4},children:e.jsx(G,{})}):g?e.jsx(L,{severity:"error",children:g}):e.jsxs(H,{sx:{width:"100%",overflowX:"auto"},children:[e.jsx(je,{component:he,children:e.jsxs(Te,{sx:{minWidth:650},"aria-label":"simple table",children:[e.jsx(Ce,{children:e.jsxs($,{children:[e.jsx(E,{children:"ID do Usuário"}),e.jsx(E,{children:"Name"}),e.jsx(E,{children:"Email"}),e.jsx(E,{children:"Ações"})]})}),e.jsx(De,{children:c.map(a=>e.jsxs($,{sx:{"&:last-child td, &:last-child th":{border:0}},children:[e.jsx(E,{component:"th",scope:"row",children:a.id}),e.jsx(E,{children:a.name||"N/A"}),e.jsx(E,{children:a.email||"N/A"}),e.jsx(E,{children:e.jsx(me,{"aria-label":"more","aria-controls":"long-menu","aria-haspopup":"true",onClick:i=>R(i,a),children:e.jsx(Se,{})})})]},a.id))})]})}),e.jsxs(xe,{id:"long-menu",anchorEl:C,open:!!C,onClose:v,children:[e.jsx(W,{onClick:w,children:"Editar"}),e.jsx(W,{onClick:K,children:"Tools"}),e.jsx(W,{onClick:J,children:"Excluir"})]}),e.jsx(ve,{open:S,onClose:a=>{a&&d(c.map(i=>i.id===a.id?a:i)),D(!1)},user:t}),e.jsx(Ee,{open:f,onClose:()=>T(!1),onUserAdded:V}),t&&e.jsx(be,{open:r,onClose:()=>o(!1),onSave:X,userId:t.id})]})})};export{ke as default};
