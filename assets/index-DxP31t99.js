import{r as i,g as R,X as z,j as a,D as L,a as q,b as X,A as P,T as b,I as W,d as G,e as A,f as k,h as F,s as V,z as I,i as B,Y,u as $,k as J,B as N,C as K,P as Q,l as U,M as H,m as Z}from"./index-BowguTbL.js";import{M as _}from"./MoreVert-B2qTNqdA.js";import{I as ee,S as ae}from"./Search-Cayw2jNv.js";import{D as te}from"./DynamicSelectorDialog-DpoPdyz_.js";import{T as ne}from"./ToolPageLayout-CYGWEmfP.js";import{T as ie,a as se,b as oe,c as M,d as c,e as re}from"./TableRow-DeDaSUMP.js";const le=({open:d,onClose:o,organization:n})=>{const[u,g]=i.useState(""),[h,x]=i.useState(""),[S,r]=i.useState(null),[l,C]=i.useState(null),[f,m]=i.useState(void 0),[O,D]=i.useState(""),[E,y]=i.useState(!1),[p,j]=i.useState(null),v=R();i.useEffect(()=>{const e=async t=>{const s=k(v,"organization",t),T=await F(s);T.exists()&&D(T.data().name)};n?(g(n.name||""),x(n.abbreviation||""),r(z(n.inclusionDate)),C(z(n.inactivationDate)),m(n.holding),n.holding?e(n.holding):D("")):(g(""),x(""),r(null),C(null),m(void 0),D(""))},[n,v]);const w=async()=>{if(j(null),!u||!h){j("Please fill in all required fields.");return}try{if(n){const e=k(v,"organization",n.id),t=await F(e),s={name:u,abbreviation:h,inactivationDate:l,holding:f};(!t.exists()||!t.data()?.inclusionDate)&&(s.inclusionDate=new Date),await V(e,s,{merge:!0}),o({...n,...s,inclusionDate:s.inclusionDate?I.fromDate(s.inclusionDate):n.inclusionDate,inactivationDate:l?I.fromDate(l):void 0})}else{const e=B(v,"organization"),t={name:u,abbreviation:h,inclusionDate:new Date,inactivationDate:l,holding:f},s=await Y(e,t);o({id:s.id,...t,inclusionDate:I.fromDate(t.inclusionDate),inactivationDate:t.inactivationDate?I.fromDate(t.inactivationDate):void 0})}}catch(e){e instanceof Error?j(e.message):j("An unexpected error occurred."),console.error("Error saving organization:",e)}};return a.jsxs(L,{open:d,onClose:()=>o(),children:[a.jsx(q,{children:n?"Edit Organization":"Add Organization"}),a.jsxs(X,{children:[p&&a.jsx(P,{severity:"error",sx:{mb:2},children:p}),n&&a.jsx(b,{autoFocus:!0,margin:"dense",id:"id",label:"Organization ID",type:"text",fullWidth:!0,disabled:!0,value:n?.id||""}),a.jsx(b,{margin:"dense",id:"name",label:"Name",type:"text",fullWidth:!0,value:u,onChange:e=>g(e.target.value)}),a.jsx(b,{margin:"dense",id:"abbreviation",label:"Abbreviation",type:"text",fullWidth:!0,value:h,onChange:e=>x(e.target.value)}),a.jsx(b,{margin:"dense",id:"holding",label:"Holding",type:"text",fullWidth:!0,disabled:!0,value:O,InputProps:{endAdornment:a.jsx(ee,{position:"end",children:a.jsx(W,{onClick:()=>y(!0),children:a.jsx(ae,{})})})}}),a.jsx(b,{margin:"dense",id:"inclusionDate",label:"Inclusion Date",type:"text",fullWidth:!0,disabled:!0,value:S?S.toLocaleDateString():""}),a.jsx(b,{margin:"dense",id:"inactivationDate",label:"Inactivation Date",type:"date",fullWidth:!0,value:l?l.toISOString().split("T")[0]:"",onChange:e=>C(new Date(e.target.value)),InputLabelProps:{shrink:!0}})]}),a.jsxs(G,{children:[a.jsx(A,{onClick:()=>o(),children:"Cancel"}),a.jsx(A,{onClick:w,children:"Save"})]}),a.jsx(te,{open:E,onClose:()=>y(!1),onSelect:(e,t)=>{m(e),D(t.name),y(!1)},collectionName:"organization",headerText:"Select Holding Company",searchField:"name",displayFields:{primary:"name",secondary:"abbreviation"},filterFunction:e=>!e.holding||e.holding===e.id})]})},xe=()=>{const[d,o]=i.useState([]),[n,u]=i.useState(!0),[g,h]=i.useState(null),[x,S]=i.useState(null),[r,l]=i.useState(null),[C,f]=i.useState(!1),m=R(),{showConfirmation:O,showAlert:D}=$(),E=i.useCallback(async()=>{u(!0),h(null);try{const e=B(m,"organization"),s=(await J(e)).docs.map(T=>({id:T.id,...T.data()}));o(s)}catch(e){console.error("Error fetching organizations:",e),h("Falha ao carregar organizações. Tente novamente mais tarde.")}finally{u(!1)}},[m]);i.useEffect(()=>{E()},[E]);const y=(e,t)=>{S(e.currentTarget),l(t)},p=()=>{S(null)},j=()=>{f(!0),p()},v=()=>{p(),r&&O({title:"Confirmar Exclusão",message:`Tem certeza que deseja excluir a organização ${r.name}? Esta ação não pode ser desfeita.`,onConfirm:async()=>{try{if(!r)return;const e=k(m,"organization",r.id);await Z(e),o(d.filter(t=>t.id!==r.id))}catch(e){console.error("Error deleting organization:",e),D({title:"Erro",message:"Falha ao excluir organização. Tente novamente mais tarde."})}}})},w=()=>{l(null),f(!0)};return a.jsx(ne,{title:"Gerenciador de Organizações",actions:a.jsx(A,{variant:"contained",color:"secondary",onClick:w,children:"Incluir Organização"}),children:n?a.jsx(N,{sx:{display:"flex",justifyContent:"center",mt:4},children:a.jsx(K,{})}):g?a.jsx(P,{severity:"error",children:g}):a.jsxs(N,{sx:{width:"100%",overflowX:"auto"},children:[a.jsx(ie,{component:Q,children:a.jsxs(se,{sx:{minWidth:650},"aria-label":"simple table",children:[a.jsx(oe,{children:a.jsxs(M,{children:[a.jsx(c,{children:"ID da Organização"}),a.jsx(c,{children:"Nome"}),a.jsx(c,{children:"Abreviação"}),a.jsx(c,{children:"Ações"})]})}),a.jsx(re,{children:d.map(e=>a.jsxs(M,{sx:{"&:last-child td, &:last-child th":{border:0}},children:[a.jsx(c,{component:"th",scope:"row",children:e.id}),a.jsx(c,{children:e.name||"N/A"}),a.jsx(c,{children:e.abbreviation||"N/A"}),a.jsx(c,{children:a.jsx(W,{"aria-label":"more","aria-controls":"long-menu","aria-haspopup":"true",onClick:t=>y(t,e),children:a.jsx(_,{})})})]},e.id))})]})}),a.jsxs(U,{id:"long-menu",anchorEl:x,open:!!x,onClose:p,children:[a.jsx(H,{onClick:j,children:"Editar"}),a.jsx(H,{onClick:v,children:"Excluir"})]}),a.jsx(le,{open:C,onClose:e=>{if(e){const t=d.find(s=>s.id===e.id);o(t?d.map(s=>s.id===e.id?e:s):[e,...d])}f(!1)},organization:r})]})})};export{xe as default};
