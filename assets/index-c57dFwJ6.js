import{r as s,g as O,j as e,D as P,a as q,b as G,A as F,T as E,h as _,i as A,k as B,K as te,s as ae,N as z,O as ne,Q as re,R as oe,U as le,V as ie,C as $,H as ce,J as de,d as ue,W as he,e as xe,l as L,n as R,u as me,m as fe,B as I,o as pe,p as H,I as V,q as ge,t as je,P as Ce,v as Te,M as N,w as De,X as Se,Y as ve}from"./index-CyqIMa5S.js";import{T as ye,a as Ee,b as be,c as X,d as y,e as we,M as Ae}from"./MoreVert-DgwGWb-B.js";const Ue=({open:c,onClose:d,user:n})=>{const[h,g]=s.useState(""),[j,T]=s.useState(""),[u,t]=s.useState(null),[m,v]=s.useState(null),D=O();s.useEffect(()=>{if(n){const r=n.name||(n.email?n.email.split("@")[0].replace(/[._]/g," ").replace(/\b\w/g,o=>o.toUpperCase()):"");g(r),T(n.email||"")}else g(""),T(""),t(null)},[n]);const f=async()=>{if(v(null),!!n)try{const r=B(D,"user",n.id),o=await te(r),x={name:h,email:j,inactivationDate:u};(!o.exists()||!o.data()?.inclusionDate)&&(x.inclusionDate=new Date),await ae(r,x,{merge:!0}),d({...n,...x,inclusionDate:x.inclusionDate?z.fromDate(x.inclusionDate):n.inclusionDate,inactivationDate:u?z.fromDate(u):void 0})}catch(r){r instanceof Error?v(r.message):v("An unexpected error occurred."),console.error("Error updating user:",r)}},C=(r,o)=>{d()};return e.jsxs(P,{open:c,onClose:C,children:[e.jsx(q,{children:n?"Edit User":"Add User"}),e.jsxs(G,{children:[m&&e.jsx(F,{severity:"error",sx:{mb:2},children:m}),e.jsx(E,{autoFocus:!0,margin:"dense",id:"id",label:"User ID",type:"text",fullWidth:!0,disabled:!0,value:n?.id||""}),e.jsx(E,{margin:"dense",id:"name",label:"Name",type:"text",fullWidth:!0,value:h,onChange:r=>g(r.target.value)}),e.jsx(E,{margin:"dense",id:"email",label:"Email Address",type:"email",fullWidth:!0,disabled:!0,value:j}),e.jsx(E,{margin:"dense",id:"inclusionDate",label:"Inclusion Date",type:"text",fullWidth:!0,disabled:!0,value:n?.inclusionDate?n.inclusionDate instanceof Date?n.inclusionDate.toLocaleDateString():new Date(n.inclusionDate.seconds*1e3).toLocaleDateString():new Date().toLocaleDateString()}),e.jsx(E,{margin:"dense",id:"inactivationDate",label:"Inactivation Date",type:"date",fullWidth:!0,value:u?u.toISOString().split("T")[0]:"",onChange:r=>t(new Date(r.target.value)),InputLabelProps:{shrink:!0}})]}),e.jsxs(_,{children:[e.jsx(A,{onClick:()=>d(),children:"Cancel"}),e.jsx(A,{onClick:f,children:"Save"})]})]})},ke=({open:c,onClose:d,onUserAdded:n})=>{const[h,g]=s.useState(""),[j,T]=s.useState(""),[u,t]=s.useState(null),m=s.useRef(null);s.useEffect(()=>{c&&setTimeout(()=>{m.current?.focus()},100)},[c]);const v=async()=>{if(t(null),!h||!j){t("Please fill in both email and password.");return}const f=`temp-app-${Date.now()}`,C=ne(re,f),r=oe(C);try{const o=await le(r,h,j);n(o.user.uid,h),d()}catch(o){o instanceof Error?t(o.message):t("An unexpected error occurred."),console.error("Error creating user:",o)}finally{ie(C)}},D=()=>{g(""),T(""),t(null),d()};return e.jsxs(P,{open:c,onClose:D,children:[e.jsx(q,{children:"Incluir Novo Usuário"}),e.jsxs(G,{children:[u&&e.jsx(F,{severity:"error",sx:{mb:2},children:u}),e.jsx(E,{inputRef:m,autoFocus:!0,margin:"dense",id:"email",label:"Endereço de E-mail",type:"email",fullWidth:!0,variant:"standard",value:h,onChange:f=>g(f.target.value)}),e.jsx(E,{margin:"dense",id:"password",label:"Senha",type:"password",fullWidth:!0,variant:"standard",value:j,onChange:f=>T(f.target.value)})]}),e.jsxs(_,{children:[e.jsx(A,{onClick:D,children:"Cancelar"}),e.jsx(A,{onClick:v,children:"Salvar"})]})]})},Ie=({open:c,onClose:d,onSave:n,userId:h})=>{const[g,j]=s.useState([]),[T,u]=s.useState(!0),[t,m]=s.useState(null),[v,D]=s.useState(""),[f,C]=s.useState([]),r=O();s.useEffect(()=>{const l=async()=>{try{const p=L(r,"user",h,"consoleTools"),U=(await R(p)).docs.map(S=>S.id);C(U)}catch(p){console.error("Error fetching user tools:",p),m("Failed to load user tools. Please try again later.")}},b=async()=>{u(!0),m(null);try{const p=L(r,"consoleTool"),U=(await R(p)).docs.map(S=>({id:S.id,name:S.data().name,description:S.data().description}));j(U)}catch(p){console.error("Error fetching tools:",p),m("Failed to load tools. Please try again later.")}finally{u(!1)}};c&&(C([]),b(),l())},[c,r,h]);const o=l=>{C(b=>b.includes(l)?b.filter(p=>p!==l):[...b,l])},x=g.filter(l=>l.name.toLowerCase().includes(v.toLowerCase()));return e.jsxs(P,{open:c,onClose:d,fullWidth:!0,maxWidth:"md",children:[e.jsx(q,{children:"Manage User Tools"}),e.jsxs(G,{children:[e.jsx(E,{autoFocus:!0,margin:"dense",id:"search",label:"Search Tools",type:"text",fullWidth:!0,variant:"standard",onChange:l=>D(l.target.value)}),T?e.jsx($,{}):t?e.jsx(F,{severity:"error",children:t}):e.jsx(ce,{children:x.map(l=>e.jsxs(de,{onClick:()=>o(l.id),children:[e.jsx(ue,{children:e.jsx(he,{edge:"start",checked:f.includes(l.id),tabIndex:-1,disableRipple:!0})}),e.jsx(xe,{primary:l.name,secondary:l.description})]},l.id))})]}),e.jsxs(_,{children:[e.jsx(A,{onClick:d,children:"Cancel"}),e.jsx(A,{onClick:()=>n(f),children:"Save"})]})]})},Fe=()=>{const[c,d]=s.useState([]),[n,h]=s.useState(!0),[g,j]=s.useState(null),[T,u]=s.useState(null),[t,m]=s.useState(null),[v,D]=s.useState(!1),[f,C]=s.useState(!1),[r,o]=s.useState(!1),x=O(),l=me(),{showConfirmation:b,showAlert:p}=fe(),k=s.useCallback(async()=>{h(!0),j(null);try{const a=L(x,"user"),w=(await R(a)).docs.map(W=>({id:W.id,...W.data()}));d(w)}catch(a){console.error("Error fetching users:",a),j("Falha ao carregar usuários. Tente novamente mais tarde.")}finally{h(!1)}},[x]);s.useEffect(()=>{k()},[k]);const U=(a,i)=>{u(a.currentTarget),m(i)},S=()=>{u(null)},J=()=>{D(!0),S()},K=()=>{S(),t&&b({title:"Confirmar Exclusão",message:`Tem certeza que deseja excluir o usuário ${t.email}? Esta ação não pode ser desfeita.`,onConfirm:async()=>{try{if(!t)return;const a=B(x,"user",t.id);await De(a),await Se.deleteUser(t.id),d(c.filter(i=>i.id!==t.id))}catch(a){console.error("Error deleting user:",a),p({title:"Erro",message:"Falha ao excluir usuário. Tente novamente mais tarde."})}}})},Q=()=>{o(!0),S()},Y=()=>{C(!0)},Z=(a,i)=>{const w={id:a,email:i};d([w,...c]),m(w),D(!0)},ee=async a=>{if(t)try{const i=ve(x),w=L(x,"user",t.id,"consoleTools");(await R(w)).forEach(M=>{i.delete(M.ref)}),a.forEach(M=>{const se=B(w,M);i.set(se,{})}),await i.commit()}catch(i){console.error("Error saving tools:",i),p({title:"Erro",message:"Falha ao salvar ferramentas. Tente novamente mais tarde."})}finally{o(!1)}};return e.jsxs(I,{sx:{display:"flex"},children:[e.jsx(pe,{position:"fixed",children:e.jsxs(H,{children:[e.jsx(V,{edge:"start",color:"inherit","aria-label":"back",onClick:()=>l(-1),sx:{mr:2},children:e.jsx(ge,{})}),e.jsx(je,{variant:"h6",component:"div",sx:{flexGrow:1},children:"Gerenciador de Usuários"}),e.jsx(A,{variant:"contained",color:"secondary",onClick:Y,children:"Incluir Usuário"})]})}),e.jsxs(I,{component:"main",sx:{flexGrow:1,p:3},children:[e.jsx(H,{}),n?e.jsx(I,{sx:{display:"flex",justifyContent:"center",mt:4},children:e.jsx($,{})}):g?e.jsx(F,{severity:"error",children:g}):e.jsxs(I,{sx:{width:"100%",overflowX:"auto"},children:[e.jsx(ye,{component:Ce,children:e.jsxs(Ee,{sx:{minWidth:650},"aria-label":"simple table",children:[e.jsx(be,{children:e.jsxs(X,{children:[e.jsx(y,{children:"ID do Usuário"}),e.jsx(y,{children:"Name"}),e.jsx(y,{children:"Email"}),e.jsx(y,{children:"Ações"})]})}),e.jsx(we,{children:c.map(a=>e.jsxs(X,{sx:{"&:last-child td, &:last-child th":{border:0}},children:[e.jsx(y,{component:"th",scope:"row",children:a.id}),e.jsx(y,{children:a.name||"N/A"}),e.jsx(y,{children:a.email||"N/A"}),e.jsx(y,{children:e.jsx(V,{"aria-label":"more","aria-controls":"long-menu","aria-haspopup":"true",onClick:i=>U(i,a),children:e.jsx(Ae,{})})})]},a.id))})]})}),e.jsxs(Te,{id:"long-menu",anchorEl:T,open:!!T,onClose:S,children:[e.jsx(N,{onClick:J,children:"Editar"}),e.jsx(N,{onClick:Q,children:"Tools"}),e.jsx(N,{onClick:K,children:"Excluir"})]}),e.jsx(Ue,{open:v,onClose:a=>{a&&d(c.map(i=>i.id===a.id?a:i)),D(!1)},user:t}),e.jsx(ke,{open:f,onClose:()=>C(!1),onUserAdded:Z}),t&&e.jsx(Ie,{open:r,onClose:()=>o(!1),onSave:ee,userId:t.id})]})]})]})};export{Fe as default};
