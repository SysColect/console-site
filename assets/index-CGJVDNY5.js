import{j as e,r as i,a as oe,H as T,q as te,W as ne,a3 as le,a4 as de,B as F,K,M as Q,N as J,O as B,P as R,Q as ce,R as X,e as N,a8 as L,h as p,a0 as G,U as ue,g as me,d as H,D as V,C as _,a7 as $,ab as fe,ac as ge,Z as he}from"./index-CpxBzFV8.js";import{T as q}from"./ToolPageLayout-BQ_XzRme.js";import{f as Z}from"./dateUtils-BvssmbZU.js";import{M as xe}from"./ManageAccounts-drzDX-rV.js";const ve=[{label:"User",value:"user"},{label:"Supervisor",value:"supervisor"},{label:"Admin",value:"admin"}],pe=()=>{const d=!i.useContext(oe)?.values?.id;return e.jsxs(e.Fragment,{children:[e.jsx(T,{name:"id",label:"ID do Usuário",formField:!0,disabled:!0,required:!1}),e.jsx(T,{name:"name",label:"Nome",formField:!0}),e.jsx(T,{name:"email",label:"Email",formField:!0,disabled:!d,required:d}),e.jsx(te,{name:"role",label:"Role",options:ve,formField:!0,required:!0}),e.jsx(T,{name:"inactivationDate",label:"Data de Inativação",type:"date",formField:!0}),e.jsx(ne,{name:"allowOwnProfile",label:"Permitir Perfil Próprio",formField:!0})]})},De=()=>e.jsx(pe,{}),Pe=a=>{const d={};return a.name||(d.name="O nome é obrigatório"),a.email?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a.email)||(d.email="Email inválido"):d.email="O email é obrigatório",a.role?["user","supervisor","admin"].includes(a.role)||(d.role="Role inválido. Deve ser: user, supervisor ou admin"):d.role="O role é obrigatório",d},be=({open:a,onClose:d,onSave:n})=>{const[l,D]=i.useState(!1),P=async m=>{const c=m.email?.trim();if(c){D(!0);try{await n(c),d()}finally{D(!1)}}},b=m=>{const c={},v=m.email?.trim();return v?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)||(c.email="E-mail inválido"):c.email="O e-mail é obrigatório",c};return e.jsx(le,{open:a,onClose:d,title:"Adicionar Usuário Existente",children:e.jsx(de,{initialValues:{email:""},onSubmit:P,onCancel:d,onValidate:b,submitLabel:"Adicionar",disabled:l,skipCancelConfirmation:!0,children:e.jsx(F,{sx:{mt:2},children:e.jsx(T,{name:"email",label:"E-mail",formField:!0,required:!0,type:"email",helperText:"Digite o e-mail do usuário existente para adicioná-lo à organização"})})})})},Ue=({open:a,onClose:d,organizationId:n,userId:l,userName:D})=>{const[P,b]=i.useState([]),[m,c]=i.useState([]),[v,O]=i.useState(!0),[U,j]=i.useState(!1),[w,h]=i.useState(null);i.useEffect(()=>{if(!a||!n||!l)return;(async()=>{O(!0),h(null);try{const u=await L.getProfilesByOrganization(n),A=u.filter(E=>!E.userId||E.userId!==l),S=await L.getUserProfileIds(n,l),k=u.filter(E=>S.includes(E.id));b(A.filter(E=>!S.includes(E.id))),c(k)}catch(u){p.error("Error loading user profiles",{organizationId:n,userId:l,error:u}),h("Erro ao carregar perfis. Tente novamente.")}finally{O(!1)}})()},[a,n,l]);const x=async()=>{j(!0),h(null);try{const s=m.map(u=>u.id);await L.setUserProfiles(n,l,s),p.info("User profiles saved",{organizationId:n,userId:l,profileIds:s}),d()}catch(s){p.error("Error saving user profiles",{organizationId:n,userId:l,error:s}),h("Erro ao salvar perfis. Tente novamente.")}finally{j(!1)}},z=()=>{d()},f=i.useMemo(()=>P.map(s=>({id:s.id,label:s.name,description:s.abbreviation})),[P]),y=i.useMemo(()=>m.map(s=>({id:s.id,label:s.name,description:s.abbreviation})),[m]),C=s=>{const u=s.map(S=>S.id),A=P.concat(m).filter(S=>u.includes(S.id));c(A)};return e.jsxs(K,{open:a,onClose:z,maxWidth:"lg",fullWidth:!0,PaperProps:{sx:{height:"90vh",maxHeight:"90vh"}},children:[e.jsxs(Q,{children:["Gerenciar Perfis - ",D]}),e.jsxs(J,{sx:{display:"flex",flexDirection:"column",minHeight:0,p:2},children:[w&&e.jsx(B,{severity:"error",sx:{mb:2},children:w}),v?e.jsx(F,{sx:{display:"flex",justifyContent:"center",alignItems:"center",flex:1},children:e.jsx(R,{})}):e.jsx(F,{sx:{flex:1,minHeight:0,display:"flex",flexDirection:"column"},children:e.jsx(ce,{availableItems:f,selectedItems:y,onSelectionChange:C,searchPlaceholder:"Buscar perfis...",availableTitle:"Perfis Disponíveis",selectedTitle:"Perfis do Usuário",loading:U,onSave:x,onCancel:z,containerHeight:600})})]}),e.jsxs(X,{sx:{p:2},children:[e.jsx(N,{onClick:z,disabled:U,children:"Cancelar"}),e.jsx(N,{onClick:x,variant:"contained",disabled:U||v,startIcon:U?e.jsx(R,{size:16}):null,children:"Salvar"})]})]})},je=({open:a,onClose:d,organizationId:n,userId:l,userName:D,onSave:P})=>{const[b,m]=i.useState(""),[c,v]=i.useState(""),[O,U]=i.useState(!0),[j,w]=i.useState(!1),[h,x]=i.useState(null),[z,f]=i.useState(null);i.useEffect(()=>{if(!a||!n||!l)return;(async()=>{U(!0),x(null);try{const u=await L.getUserOwnProfile(n,l);u?(f(u),m(u.name),v(u.abbreviation)):(m(`${D} - Perfil Próprio`),v(D.substring(0,3).toUpperCase()))}catch(u){p.error("Error loading user own profile",{organizationId:n,userId:l,error:u}),x("Erro ao carregar perfil. Tente novamente.")}finally{U(!1)}})()},[a,n,l,D]);const y=async()=>{if(!b.trim()||!c.trim()){x("Nome e abreviação são obrigatórios.");return}w(!0),x(null);try{await L.saveUserOwnProfile(n,l,{name:b.trim(),abbreviation:c.trim()}),p.info("User own profile saved",{organizationId:n,userId:l,name:b,abbreviation:c}),P?.(),d()}catch(s){p.error("Error saving user own profile",{organizationId:n,userId:l,error:s}),x("Erro ao salvar perfil. Tente novamente.")}finally{w(!1)}},C=()=>{d()};return e.jsxs(K,{open:a,onClose:C,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(Q,{children:[z?"Editar Perfil Próprio":"Criar Perfil Próprio"," - ",D]}),e.jsxs(J,{children:[h&&e.jsx(B,{severity:"error",sx:{mb:2},children:h}),O?e.jsx(F,{sx:{display:"flex",justifyContent:"center",p:4},children:e.jsx(R,{})}):e.jsxs(F,{sx:{display:"flex",flexDirection:"column",gap:2,pt:2},children:[e.jsx(G,{label:"Nome",value:b,onChange:s=>m(s.target.value),fullWidth:!0,required:!0,disabled:j}),e.jsx(G,{label:"Abreviação",value:c,onChange:s=>v(s.target.value),fullWidth:!0,required:!0,disabled:j,inputProps:{maxLength:10}})]})]}),e.jsxs(X,{children:[e.jsx(N,{onClick:C,disabled:j||O,children:"Cancelar"}),e.jsx(N,{onClick:y,variant:"contained",disabled:j||O||!b.trim()||!c.trim(),startIcon:j?e.jsx(R,{size:16}):null,children:"Salvar"})]})]})},we=()=>{const{organizationData:a,isLoading:d}=ue(),[n,l]=i.useState([]),[D,P]=i.useState(!0),[b,m]=i.useState(null),[c,v]=i.useState(!1),[O,U]=i.useState(!1),[j,w]=i.useState(!1),[h,x]=i.useState(null),{showConfirmation:z,showAlert:f}=me(),y=i.useMemo(()=>a?.id?H.getRepository(`organization/${a.id}/users`,V.Firestore,_.NoCache):null,[a?.id]),C=i.useMemo(()=>H.getRepository("user",V.Firestore,_.NoCache),[]),s=i.useCallback(async()=>{if(!a?.id||!y){P(!1);return}P(!0),m(null);try{const r=await y.getAll({}),t=[];for(const o of r)try{const g=await C.getById(o.id);g&&t.push({userData:g,orgUserData:o})}catch{p.warn("User data not found for organization user",{userId:o.id,organizationId:a.id})}t.sort((o,g)=>(o.userData.name||"").localeCompare(g.userData.name||"")),l(t)}catch(r){p.error("Error fetching organization users",{error:r,organizationId:a.id}),m("Falha ao carregar usuários da organização. Por favor, tente novamente mais tarde.")}finally{P(!1)}},[y,C,a?.id]);i.useEffect(()=>{s()},[s]);const u=i.useCallback(async r=>{if(!a?.id){f({title:"Erro",message:"Organização não encontrada."});return}try{const t=await C.getAll({filters:[{field:"email",operator:"==",value:r}]});if(t.length===0){f({title:"Usuário não encontrado",message:`Nenhum usuário encontrado com o e-mail ${r}. Verifique o e-mail e tente novamente.`});return}const o=t[0];if((await y?.getAll({}))?.some(M=>M.id===o.id)){f({title:"Usuário já adicionado",message:`O usuário ${o.email} já está nesta organização.`});return}if(!o.email){f({title:"Erro",message:"O usuário encontrado não possui e-mail válido."});return}await $.saveOrganizationUser({userData:{id:o.id,name:o.name||"",email:o.email,role:"user"},organizationId:a.id},!0),p.info("Usuário adicionado à organização por e-mail",{userId:o.id,email:o.email,organizationId:a.id}),f({title:"Usuário Adicionado",message:`O usuário ${o.email} foi adicionado à organização com sucesso.`}),s()}catch(t){p.error("Error adding user to organization by email",{error:t,email:r,organizationId:a.id});const o=t instanceof Error?t.message:"Falha ao adicionar usuário à organização.";throw f({title:"Erro",message:o}),t}},[a,C,y,f,s]),A=i.useCallback(()=>{v(!0)},[]),S=i.useCallback(r=>{const t=r._original||n.find(o=>o.userData.id===r.id);t&&a&&(x(t),U(!0))},[n,a]),k=i.useCallback(r=>{const t=r._original||n.find(o=>o.userData.id===r.id);t&&a&&(x(t),w(!0))},[n,a]),E=i.useCallback(()=>{U(!1),x(null),s()},[s]),W=i.useCallback(()=>{w(!1),x(null),s()},[s]),Y=i.useMemo(()=>[{icon:e.jsx(xe,{}),description:"Gerenciar Perfis",onClick:S},{icon:e.jsx(fe,{}),description:"Perfil Próprio",onClick:k}],[S,k]),ee=i.useMemo(()=>[{icon:e.jsx(ge,{}),description:"Adicionar Usuário Existente",onClick:A,tooltip:"Adicionar usuário existente a partir do e-mail"}],[A]);if(d)return e.jsx(q,{title:"Gerenciador de Usuários da Organização",children:e.jsx(F,{sx:{display:"flex",justifyContent:"center",p:4},children:"Carregando organização..."})});if(!a)return e.jsx(q,{title:"Gerenciador de Usuários da Organização",children:e.jsx(B,{severity:"warning",children:"Nenhuma organização selecionada. Por favor, selecione uma organização para gerenciar os usuários."})});const ae=[{field:"id",headerName:"ID do Usuário",width:200},{field:"name",headerName:"Nome",width:250},{field:"email",headerName:"Email",width:250},{field:"role",headerName:"Role",width:150,valueGetter:r=>r||"user"},{field:"inactivationDate",headerName:"Data de Inativação",width:180,valueGetter:r=>r?Z(r)?.toLocaleDateString("pt-BR"):"-"}],re=n.map(r=>{const t=r.orgUserData.inactivationDate&&Z(r.orgUserData.inactivationDate)?.toISOString().split("T")[0]||null;return{id:r.userData.id,name:r.userData.name||"",email:r.userData.email||"",role:r.orgUserData.role||"user",inactivationDate:t,allowOwnProfile:r.orgUserData.allowOwnProfile||!1,_original:r}}),ie=async(r,t)=>{if(!a?.id){f({title:"Erro",message:"Organização não encontrada."});return}try{const o=await $.saveOrganizationUser({userData:{id:r.id,name:r.name,email:r.email,role:r.role,inactivationDate:r.inactivationDate,allowOwnProfile:r.allowOwnProfile||!1},organizationId:a.id},t);if(t){const g=o;if(g.userCreated&&g.password){const I=`Email: ${r.email}
Senha: ${g.password}`;f({title:"Usuário Criado",message:`Usuário criado com sucesso!

Email: ${r.email}
Senha: ${g.password}

IMPORTANTE: Anote esta senha, ela não será exibida novamente.`,copyText:I})}s()}else{const g=o;l(I=>I.map(M=>M.userData.id===g.userData.id?g:M)),s()}}catch(o){p.error("Error saving organization user",{error:o,isNew:t,userId:r.id,organizationId:a.id,email:r.email});const g=o instanceof Error?o.message:"Falha ao salvar o usuário da organização.";f({title:"Erro",message:g})}},se=r=>{const t=r._original||n.find(o=>o.userData.id===r.id);!t||!a||z({title:"Confirmar Remoção",message:`Tem certeza que deseja remover o usuário ${t.userData.email} desta organização? Esta ação não pode ser desfeita.`,onConfirm:async()=>{try{await $.removeOrganizationUser(t.userData.id,a.id),l(n.filter(o=>o.userData.id!==t.userData.id))}catch(o){p.error("Error removing user from organization",{error:o,userId:t.userData.id,organizationId:a.id,email:t.userData.email}),f({title:"Erro",message:"Falha ao remover usuário da organização. Por favor, tente novamente mais tarde."})}}})};return e.jsxs(q,{title:`Gerenciador de Usuários - ${a.name}`,children:[e.jsx(he,{title:"Usuários da Organização",rows:re,columns:ae,loading:D,error:b,initialValues:{id:"",name:"",email:"",role:"user",inactivationDate:null,allowOwnProfile:!1},dialogTitle:"Usuário da Organização",onSave:ie,onDelete:se,onRefresh:s,onValidate:Pe,hideAddButton:!1,globalActions:ee,actions:Y,children:De()}),e.jsx(be,{open:c,onClose:()=>v(!1),onSave:u}),h&&a&&e.jsxs(e.Fragment,{children:[e.jsx(Ue,{open:O,onClose:E,organizationId:a.id,userId:h.userData.id,userName:h.userData.name||""}),e.jsx(je,{open:j,onClose:W,organizationId:a.id,userId:h.userData.id,userName:h.userData.name||"",onSave:W})]})]})};export{we as default};
