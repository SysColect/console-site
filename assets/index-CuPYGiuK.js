import{g as ne,j as i,m as U,z as w,ah as oe,r as t,b as _,c as W,C as $,f as m,B as I,T as H,ai as G,aj as re,ak as le,al as se,s as de,am as ce,ad as ue,an as me,ao as ge,ab as fe,d as he,ap as pe,aq as be,U as xe,a as ve,t as ye,q as Te,v as B,ar as De,Q as je}from"./index-B5W6PHBy.js";import{T as ze}from"./ToolPageLayout-DClDsmcM.js";import{f as L}from"./dateUtils-BBQ9qMZq.js";const Se=ne(i.jsx("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"})),Ce=({organizationsMap:d})=>i.jsxs(i.Fragment,{children:[i.jsx(w,{name:"name",label:"Nome",formField:!0,required:!0}),i.jsx(w,{name:"abbreviation",label:"Abreviação",formField:!0,required:!0}),i.jsx(oe,{name:"holding",label:"Holding",optionsMap:d,formField:!0}),i.jsx(w,{name:"inactivationDate",label:"Data de Inativação",type:"date",formField:!0}),i.jsx(w,{name:"inclusionDate",label:"Data de Inclusão",type:"date",formField:!0,disabled:!0})]}),Oe=d=>i.jsx(Ce,{organizationsMap:d}),Fe=d=>{const h={};return h.name=U.required("O nome da organização é obrigatório")(d.name),h.abbreviation=U.required("A abreviação é obrigatória")(d.abbreviation),Object.entries(h).reduce((s,[E,v])=>(v&&(s[E]=v),s),{})},we=({open:d,onClose:h,organizationId:s,organizationName:E})=>{const[v,R]=t.useState([]),[D,y]=t.useState([]),[S,V]=t.useState({}),[M,N]=t.useState(!0),[A,b]=t.useState(!1),[p,T]=t.useState(null),[q,C]=t.useState(!1),[c,O]=t.useState(null),k=t.useMemo(()=>_.getRepository("consoleTool",W.Firestore,$.NoCache),[]),x=t.useMemo(()=>_.getRepository(`organization/${s}/tools`,W.Firestore,$.NoCache),[s]),n=t.useCallback(async()=>{if(!(!d||!s)){N(!0);try{const e=await k.getAll({sort:{field:"name",direction:"asc"}});R(e);const a={};e.forEach(u=>{a[u.id]=u}),V(a);const r=await x.getAll();y(r)}catch(e){m.error("Error fetching organization tools",{error:e,organizationId:s})}finally{N(!1)}}},[d,s,k,x]);t.useEffect(()=>{n()},[n]);const l=t.useMemo(()=>D.map(e=>{const a=S[e.toolId];return a?{id:e.id,toolId:e.toolId,name:e.name??a.name,description:e.description??a.description,billingType:e.billingType??a.billingType??"free",value:e.value??a.value??null,icon:a.icon,_original:e}:{id:e.id,toolId:e.toolId,name:e.name||"Tool não encontrada",description:e.description||"",billingType:e.billingType||"free",value:e.value||null,icon:void 0,_original:e}}),[D,S]),o=t.useMemo(()=>{const e=new Set(D.map(a=>a.toolId));return v.filter(a=>a.allowMultipleInsertions?!0:!e.has(a.id)).map(a=>({id:a.id,label:a.name,tool:a}))},[v,D]),f=t.useMemo(()=>[{field:"name",headerName:"Nome",width:250},{field:"description",headerName:"Descrição",width:300,flex:1},{field:"billingType",headerName:"Tipo de Cobrança",width:150,valueGetter:e=>({free:"Free",monthly:"Mensal","on-demand":"Por Demanda"})[e]||e},{field:"value",headerName:"Valor",width:120,valueGetter:e=>e==null?"-":e.toFixed(2)}],[]),j=t.useMemo(()=>l.map(e=>({id:e.id,name:e.name,description:e.description,billingType:e.billingType,value:e.value,_original:e})),[l]),z=t.useCallback(e=>{if(!e)return;const a=v.find(u=>u.id===e);if(!a)return;if(!a.allowMultipleInsertions&&D.some(g=>g.toolId===e)){m.warn("Tool já adicionada",{toolId:e,organizationId:s});return}const r={toolId:e};y(u=>[...u,{...r,id:`temp-${Date.now()}`}]),T(null),x.create(r).then(u=>{y(g=>g.map(F=>F.id.startsWith("temp-")?u:F)),m.info("Tool adicionada à organização",{toolId:e,organizationId:s})}).catch(u=>{m.error("Error adding tool to organization",{error:u,toolId:e,organizationId:s}),y(g=>g.filter(F=>!F.id.startsWith("temp-")))})},[v,D,s,x]),K=t.useCallback(e=>{const a=e._original;O(a),C(!0)},[]),J=t.useCallback(async e=>{if(c){b(!0);try{const a={},r=S[c.toolId];r?(e.name!==r.name&&(a.name=e.name),e.description!==r.description&&(a.description=e.description),e.billingType!==r.billingType&&(a.billingType=e.billingType),e.value!==r.value&&(a.value=e.value)):(a.name=e.name,a.description=e.description,a.billingType=e.billingType,a.value=e.value),await x.update(c.id,a),y(u=>u.map(g=>g.id===c.id?{...g,...a}:g)),m.info("Organization tool updated",{organizationId:s,toolId:c.id}),C(!1),O(null)}catch(a){m.error("Error updating organization tool",{error:a,organizationId:s,toolId:c.id})}finally{b(!1)}}},[c,S,s,x]),Q=t.useCallback(async e=>{if(e.length===0)return;const a=e.map(r=>r.id);b(!0);try{for(const r of a)await x.delete(r);y(r=>r.filter(u=>!a.includes(u.id))),m.info("Organization tools deleted",{organizationId:s,count:a.length})}catch(r){m.error("Error deleting organization tools",{error:r,organizationId:s})}finally{b(!1)}},[s,x]),X=t.useCallback(e=>{const a={};if(e.name||(a.name="O nome é obrigatório"),e.billingType||(a.billingType="O tipo de cobrança é obrigatório"),e.billingType&&e.billingType!=="free"){const r=e.value;(!r||r===null||r===void 0||isNaN(r)||r<=0)&&(a.value="O valor deve ser maior que zero quando o tipo de cobrança não é Free.")}return a},[]),Y=t.useMemo(()=>[{label:"Excluir Selecionados",icon:i.jsx(Se,{}),onClick:Q,disabled:e=>e.length===0,color:"error",variant:"outlined"}],[Q]),Z=t.useMemo(()=>{const e=l.length,a=l.filter(g=>g.billingType==="free").length,r=e-a,u=l.reduce((g,F)=>g+(F.value||0),0);return i.jsxs(I,{sx:{display:"flex",gap:2},children:[i.jsxs(H,{variant:"body2",color:"text.secondary",children:["Total: ",i.jsx("strong",{children:e})]}),i.jsxs(H,{variant:"body2",color:"text.secondary",children:["Gratuitas: ",i.jsx("strong",{children:a})]}),i.jsxs(H,{variant:"body2",color:"text.secondary",children:["Pagas: ",i.jsx("strong",{children:r})]}),i.jsxs(H,{variant:"body2",color:"text.secondary",children:["Valor Total: ",i.jsx("strong",{children:u.toFixed(2)})]})]})},[l]),P=G.useRef(null),[ee,ae]=G.useState(600);G.useEffect(()=>{const e=()=>{if(P.current){const r=P.current.getBoundingClientRect().height-48;ae(Math.max(400,r))}};if(d){const a=setTimeout(e,100);return window.addEventListener("resize",e),()=>{clearTimeout(a),window.removeEventListener("resize",e)}}},[d]);const ie=t.useMemo(()=>c?{name:c.name,description:c.description,billingType:c.billingType,value:c.value}:{},[c]),te=()=>t.useContext(ve)?.values?.billingType==="free"?null:i.jsx(ye,{name:"value",label:"Valor",formField:!0,decimals:2});return i.jsxs(i.Fragment,{children:[i.jsxs(re,{open:d,onClose:h,maxWidth:"lg",fullWidth:!0,PaperProps:{sx:{height:"90vh",maxHeight:"90vh"}},children:[i.jsxs(le,{children:["Gerenciar Ferramentas - ",E]}),i.jsx(se,{ref:P,sx:{flex:1,display:"flex",flexDirection:"column",minHeight:0,overflow:"hidden"},children:M?i.jsx(I,{sx:{display:"flex",justifyContent:"center",p:4},children:i.jsx(de,{})}):i.jsxs(I,{sx:{flex:1,display:"flex",flexDirection:"column",minHeight:0,width:"100%"},children:[i.jsx(I,{sx:{mb:3},children:i.jsx(ce,{value:p?o.find(e=>e.id===p):null,onChange:(e,a)=>{a&&z(a.id)},options:o,getOptionLabel:e=>e.label,renderInput:e=>i.jsx(ue,{...e,label:"Adicionar Ferramenta",placeholder:"Selecione uma ferramenta para adicionar"}),disabled:A})}),i.jsx(I,{sx:{flex:1,minHeight:0},children:i.jsx(me,{columns:f,rows:j,onEdit:K,globalActions:Y,infoComponent:Z,height:ee-100})})]})}),i.jsx(ge,{sx:{px:3,py:2,flexShrink:0},children:i.jsx(fe,{title:"Pressione 'Esc' para cancelar",children:i.jsx("span",{children:i.jsx(he,{onClick:h,disabled:A,children:"Fechar"})})})})]}),q&&c&&i.jsx(pe,{open:q,onClose:()=>{C(!1),O(null)},title:"Editar Ferramenta da Organização",children:i.jsxs(be,{initialValues:ie,onSubmit:J,onValidate:X,onCancel:()=>{C(!1),O(null)},children:[i.jsx(w,{name:"name",label:"Nome",formField:!0,required:!0}),i.jsx(w,{name:"description",label:"Descrição",multiline:!0,rows:3,formField:!0}),i.jsx(xe,{name:"billingType",label:"Tipo de Cobrança",options:[{value:"free",label:"Free"},{value:"monthly",label:"Mensal"},{value:"on-demand",label:"Por Demanda"}],formField:!0,required:!0}),i.jsx(te,{})]},c.id)})]})},Ae=()=>{const[d,h]=t.useState([]),[s,E]=t.useState({}),[v,R]=t.useState(!0),[D,y]=t.useState(null),[S,V]=t.useState(!1),[M,N]=t.useState(null),{showConfirmation:A,showAlert:b}=Te(),p=t.useMemo(()=>_.getRepository("organization",W.Firestore,$.NoCache),[]),T=t.useCallback(async()=>{R(!0),y(null);try{const n=await p.getAll({sort:{field:"name",direction:"asc"}});h(n);const l=n.reduce((o,f)=>(o[f.id]=f.name,o),{});E(l)}catch(n){m.error("Error fetching organizations",{error:n}),y("Falha ao carregar as organizações. Por favor, tente novamente mais tarde.")}finally{R(!1)}},[p]);t.useEffect(()=>{T()},[T]);const q=t.useMemo(()=>[{field:"name",headerName:"Nome",width:250},{field:"abbreviation",headerName:"Abreviação",width:120},{field:"holding",headerName:"Holding",width:250,valueGetter:n=>s[n]||"-"},{field:"inclusionDate",headerName:"Data de Inclusão",width:180,valueGetter:n=>L(n)?.toLocaleDateString("pt-BR")||"-"},{field:"inactivationDate",headerName:"Data de Inativação",width:180,valueGetter:n=>n?L(n)?.toLocaleDateString("pt-BR"):"-"},{field:"id",headerName:"ID",flex:1}],[s]),C=t.useMemo(()=>d.map(n=>{const l=n.inclusionDate&&L(n.inclusionDate)?.toISOString().split("T")[0]||null,o=n.inactivationDate&&L(n.inactivationDate)?.toISOString().split("T")[0]||null;return{id:n.id,name:n.name||"",abbreviation:n.abbreviation||"",holding:n.holding||"",inclusionDate:l,inactivationDate:o,_original:n}}),[d]),c=t.useCallback(async(n,l)=>{try{const o={...n},f=o.id;if((o.holding===""||o.holding===void 0)&&(o.holding=null),o.inactivationDate){const j=o.inactivationDate instanceof B?o.inactivationDate.toDate():new Date(o.inactivationDate);o.inactivationDate=B.fromDate(j)}else o.inactivationDate=null;if(l){o.inclusionDate=B.now();const j=await p.create(o);h(z=>[...z,j]),m.info("Organização criada",{organizationId:j.id,name:n.name,abbreviation:n.abbreviation})}else{if(!f){b({title:"Erro",message:"ID da organização não encontrado."});return}delete o.inclusionDate,await p.update(f,o),h(j=>j.map(z=>z.id===f?{...z,...o,id:f}:z)),m.info("Organização alterada",{organizationId:f,name:n.name,abbreviation:n.abbreviation})}T()}catch(o){m.error("Error saving organization",{error:o,isNew:l,organizationId:n.id,name:n.name});const f=o instanceof Error?o.message:"Falha ao salvar a organização.";b({title:"Erro",message:f})}},[p,b,T]),O=t.useCallback(n=>{const l=n._original||d.find(o=>o.id===n.id);!l||!p||A({title:"Confirmar Remoção",message:`Tem certeza que deseja remover a organização "${l.name}"? Esta ação não pode ser desfeita.`,onConfirm:async()=>{try{await p.delete(l.id),h(d.filter(o=>o.id!==l.id)),m.info("Organização removida",{organizationId:l.id,name:l.name}),T()}catch(o){m.error("Error removing organization",{error:o,organizationId:l.id,name:l.name}),b({title:"Erro",message:"Falha ao remover organização. Por favor, tente novamente mais tarde."})}}})},[d,p,A,b,T]),k=t.useCallback(n=>{const l=n._original||d.find(o=>o.id===n.id);l&&(N(l),V(!0))},[d]),x=t.useMemo(()=>[{description:"Gerenciar Ferramentas",icon:i.jsx(De,{}),onClick:k}],[k]);return i.jsxs(ze,{title:"Gerenciador de Organizações",children:[i.jsx(je,{title:"Organizações",rows:C,columns:q,loading:v,error:D,initialValues:{id:"",name:"",abbreviation:"",holding:null,inactivationDate:null,inclusionDate:null},dialogTitle:"Organização",onSave:c,onDelete:O,onRefresh:T,onValidate:Fe,hideAddButton:!1,actions:x,children:Oe(s)}),M&&i.jsx(we,{open:S,onClose:()=>{V(!1),N(null)},organizationId:M.id,organizationName:M.name})]})};export{Ae as default};
