import{r as s,g as O,j as e,D as P,a as q,b as G,A as F,T as E,h as _,i as A,k as B,K as se,s as te,N as ae,O as ne,Q as re,R as oe,U as le,C as X,H as ie,J as ce,d as de,V as ue,e as he,l as L,n as R,u as xe,m as me,B as I,o as fe,p as z,I as H,q as pe,t as ge,P as je,v as Ce,M as N,w as Te,W as Se,X as ye}from"./index-CyW68QXl.js";import{T as ve,a as De,b as Ee,c as V,d as D,e as be,M as we}from"./MoreVert-L0x4JGm1.js";const Ae=({open:c,onClose:d,user:n})=>{const[u,p]=s.useState(""),[g,T]=s.useState(""),[h,t]=s.useState(null),[x,v]=s.useState(null),S=O();s.useEffect(()=>{if(n){const r=n.name||(n.email?n.email.split("@")[0].replace(/[._]/g," ").replace(/\b\w/g,o=>o.toUpperCase()):"");p(r),T(n.email||"")}else p(""),T(""),t(null)},[n]);const m=async()=>{if(v(null),!!n)try{const r=B(S,"user",n.id),o=await se(r),C={name:u,email:g,inactivationDate:h};(!o.exists()||!o.data()?.inclusionDate)&&(C.inclusionDate=new Date),await te(r,C,{merge:!0}),d({...n,...C})}catch(r){r instanceof Error?v(r.message):v("An unexpected error occurred."),console.error("Error updating user:",r)}},j=(r,o)=>{d()};return e.jsxs(P,{open:c,onClose:j,children:[e.jsx(q,{children:n?"Edit User":"Add User"}),e.jsxs(G,{children:[x&&e.jsx(F,{severity:"error",sx:{mb:2},children:x}),e.jsx(E,{autoFocus:!0,margin:"dense",id:"id",label:"User ID",type:"text",fullWidth:!0,disabled:!0,value:n?.id||""}),e.jsx(E,{margin:"dense",id:"name",label:"Name",type:"text",fullWidth:!0,value:u,onChange:r=>p(r.target.value)}),e.jsx(E,{margin:"dense",id:"email",label:"Email Address",type:"email",fullWidth:!0,disabled:!0,value:g}),e.jsx(E,{margin:"dense",id:"inclusionDate",label:"Inclusion Date",type:"text",fullWidth:!0,disabled:!0,value:n?.inclusionDate?n.inclusionDate instanceof Date?n.inclusionDate.toLocaleDateString():new Date(n.inclusionDate.seconds*1e3).toLocaleDateString():new Date().toLocaleDateString()}),e.jsx(E,{margin:"dense",id:"inactivationDate",label:"Inactivation Date",type:"date",fullWidth:!0,value:h?h.toISOString().split("T")[0]:"",onChange:r=>t(new Date(r.target.value)),InputLabelProps:{shrink:!0}})]}),e.jsxs(_,{children:[e.jsx(A,{onClick:()=>d(),children:"Cancel"}),e.jsx(A,{onClick:m,children:"Save"})]})]})},Ue=({open:c,onClose:d,onUserAdded:n})=>{const[u,p]=s.useState(""),[g,T]=s.useState(""),[h,t]=s.useState(null),x=s.useRef(null);s.useEffect(()=>{c&&setTimeout(()=>{x.current?.focus()},100)},[c]);const v=async()=>{if(t(null),!u||!g){t("Please fill in both email and password.");return}const m=`temp-app-${Date.now()}`,j=ae(ne,m),r=re(j);try{const o=await oe(r,u,g);n(o.user.uid,u),d()}catch(o){o instanceof Error?t(o.message):t("An unexpected error occurred."),console.error("Error creating user:",o)}finally{le(j)}},S=()=>{p(""),T(""),t(null),d()};return e.jsxs(P,{open:c,onClose:S,children:[e.jsx(q,{children:"Incluir Novo Usuário"}),e.jsxs(G,{children:[h&&e.jsx(F,{severity:"error",sx:{mb:2},children:h}),e.jsx(E,{inputRef:x,autoFocus:!0,margin:"dense",id:"email",label:"Endereço de E-mail",type:"email",fullWidth:!0,variant:"standard",value:u,onChange:m=>p(m.target.value)}),e.jsx(E,{margin:"dense",id:"password",label:"Senha",type:"password",fullWidth:!0,variant:"standard",value:g,onChange:m=>T(m.target.value)})]}),e.jsxs(_,{children:[e.jsx(A,{onClick:S,children:"Cancelar"}),e.jsx(A,{onClick:v,children:"Salvar"})]})]})},ke=({open:c,onClose:d,onSave:n,userId:u})=>{const[p,g]=s.useState([]),[T,h]=s.useState(!0),[t,x]=s.useState(null),[v,S]=s.useState(""),[m,j]=s.useState([]),r=O();s.useEffect(()=>{const l=async()=>{try{const f=L(r,"user",u,"consoleTools"),U=(await R(f)).docs.map(y=>y.id);j(U)}catch(f){console.error("Error fetching user tools:",f),x("Failed to load user tools. Please try again later.")}},b=async()=>{h(!0),x(null);try{const f=L(r,"consoleTool"),U=(await R(f)).docs.map(y=>({id:y.id,name:y.data().name,description:y.data().description}));g(U)}catch(f){console.error("Error fetching tools:",f),x("Failed to load tools. Please try again later.")}finally{h(!1)}};c&&(j([]),b(),l())},[c,r,u]);const o=l=>{j(b=>b.includes(l)?b.filter(f=>f!==l):[...b,l])},C=p.filter(l=>l.name.toLowerCase().includes(v.toLowerCase()));return e.jsxs(P,{open:c,onClose:d,fullWidth:!0,maxWidth:"md",children:[e.jsx(q,{children:"Manage User Tools"}),e.jsxs(G,{children:[e.jsx(E,{autoFocus:!0,margin:"dense",id:"search",label:"Search Tools",type:"text",fullWidth:!0,variant:"standard",onChange:l=>S(l.target.value)}),T?e.jsx(X,{}):t?e.jsx(F,{severity:"error",children:t}):e.jsx(ie,{children:C.map(l=>e.jsxs(ce,{onClick:()=>o(l.id),children:[e.jsx(de,{children:e.jsx(ue,{edge:"start",checked:m.includes(l.id),tabIndex:-1,disableRipple:!0})}),e.jsx(he,{primary:l.name,secondary:l.description})]},l.id))})]}),e.jsxs(_,{children:[e.jsx(A,{onClick:d,children:"Cancel"}),e.jsx(A,{onClick:()=>n(m),children:"Save"})]})]})},Re=()=>{const[c,d]=s.useState([]),[n,u]=s.useState(!0),[p,g]=s.useState(null),[T,h]=s.useState(null),[t,x]=s.useState(null),[v,S]=s.useState(!1),[m,j]=s.useState(!1),[r,o]=s.useState(!1),C=O(),l=xe(),{showConfirmation:b,showAlert:f}=me(),k=s.useCallback(async()=>{u(!0),g(null);try{const a=L(C,"user"),w=(await R(a)).docs.map(W=>({id:W.id,...W.data()}));d(w)}catch(a){console.error("Error fetching users:",a),g("Falha ao carregar usuários. Tente novamente mais tarde.")}finally{u(!1)}},[C]);s.useEffect(()=>{k()},[k]);const U=(a,i)=>{h(a.currentTarget),x(i)},y=()=>{h(null)},$=()=>{S(!0),y()},J=()=>{y(),t&&b({title:"Confirmar Exclusão",message:`Tem certeza que deseja excluir o usuário ${t.email}? Esta ação não pode ser desfeita.`,onConfirm:async()=>{try{if(!t)return;const a=B(C,"user",t.id);await Te(a),await Se.deleteUser(t.id),d(c.filter(i=>i.id!==t.id))}catch(a){console.error("Error deleting user:",a),f({title:"Erro",message:"Falha ao excluir usuário. Tente novamente mais tarde."})}}})},K=()=>{o(!0),y()},Q=()=>{j(!0)},Y=(a,i)=>{const w={id:a,email:i};d([w,...c]),x(w),S(!0)},Z=async a=>{if(t)try{const i=ye(C),w=L(C,"user",t.id,"consoleTools");(await R(w)).forEach(M=>{i.delete(M.ref)}),a.forEach(M=>{const ee=B(w,M);i.set(ee,{})}),await i.commit()}catch(i){console.error("Error saving tools:",i),f({title:"Erro",message:"Falha ao salvar ferramentas. Tente novamente mais tarde."})}finally{o(!1)}};return e.jsxs(I,{sx:{display:"flex"},children:[e.jsx(fe,{position:"fixed",children:e.jsxs(z,{children:[e.jsx(H,{edge:"start",color:"inherit","aria-label":"back",onClick:()=>l(-1),sx:{mr:2},children:e.jsx(pe,{})}),e.jsx(ge,{variant:"h6",component:"div",sx:{flexGrow:1},children:"Gerenciador de Usuários"}),e.jsx(A,{variant:"contained",color:"secondary",onClick:Q,children:"Incluir Usuário"})]})}),e.jsxs(I,{component:"main",sx:{flexGrow:1,p:3},children:[e.jsx(z,{}),n?e.jsx(I,{sx:{display:"flex",justifyContent:"center",mt:4},children:e.jsx(X,{})}):p?e.jsx(F,{severity:"error",children:p}):e.jsxs(I,{sx:{width:"100%",overflowX:"auto"},children:[e.jsx(ve,{component:je,children:e.jsxs(De,{sx:{minWidth:650},"aria-label":"simple table",children:[e.jsx(Ee,{children:e.jsxs(V,{children:[e.jsx(D,{children:"ID do Usuário"}),e.jsx(D,{children:"Name"}),e.jsx(D,{children:"Email"}),e.jsx(D,{children:"Ações"})]})}),e.jsx(be,{children:c.map(a=>e.jsxs(V,{sx:{"&:last-child td, &:last-child th":{border:0}},children:[e.jsx(D,{component:"th",scope:"row",children:a.id}),e.jsx(D,{children:a.name||"N/A"}),e.jsx(D,{children:a.email||"N/A"}),e.jsx(D,{children:e.jsx(H,{"aria-label":"more","aria-controls":"long-menu","aria-haspopup":"true",onClick:i=>U(i,a),children:e.jsx(we,{})})})]},a.id))})]})}),e.jsxs(Ce,{id:"long-menu",anchorEl:T,open:!!T,onClose:y,children:[e.jsx(N,{onClick:$,children:"Editar"}),e.jsx(N,{onClick:K,children:"Tools"}),e.jsx(N,{onClick:J,children:"Excluir"})]}),e.jsx(Ae,{open:v,onClose:a=>{a&&d(c.map(i=>i.id===a.id?a:i)),S(!1)},user:t}),e.jsx(Ue,{open:m,onClose:()=>j(!1),onUserAdded:Y}),t&&e.jsx(ke,{open:r,onClose:()=>o(!1),onSave:Z,userId:t.id})]})]})]})};export{Re as default};
