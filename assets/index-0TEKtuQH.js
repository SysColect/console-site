import{j as n,d as L,L as F,v as G,e as i,g as R,D as N,C as k,r as h,t as P,w as V,x as _,B,z as H,E as W,F as $,h as q,l as J,T as A,S as K,q as Q}from"./index-Cw1vh47c.js";import{T as U}from"./ToolPageLayout-B48a5b2y.js";import{f as I}from"./dateUtils-D2aqTT2t.js";const X=({organizationsMap:r})=>n.jsxs(n.Fragment,{children:[n.jsx(F,{name:"name",label:"Nome",formField:!0,required:!0}),n.jsx(F,{name:"abbreviation",label:"Abreviação",formField:!0,required:!0}),n.jsx(G,{name:"holding",label:"Holding",optionsMap:r,formField:!0}),n.jsx(F,{name:"inactivationDate",label:"Data de Inativação",type:"date",formField:!0}),n.jsx(F,{name:"inclusionDate",label:"Data de Inclusão",type:"date",formField:!0,disabled:!0})]}),Y=r=>n.jsx(X,{organizationsMap:r}),Z=r=>{const l={};return l.name=L.required("O nome da organização é obrigatório")(r.name),l.abbreviation=L.required("A abreviação é obrigatória")(r.abbreviation),Object.entries(l).reduce((s,[z,g])=>(g&&(s[z]=g),s),{})},ee=({open:r,onClose:l,organizationId:s,organizationName:z})=>{const[g,j]=i.useState([]),[m,S]=i.useState([]),[C,x]=i.useState(!0),[v,T]=i.useState(!1),y=i.useMemo(()=>R.getRepository("consoleTool",N.Firestore,k.NoCache),[]),c=i.useMemo(()=>R.getRepository(`organization/${s}/tools`,N.Firestore,k.NoCache),[s]),u=i.useCallback(async()=>{if(!(!r||!s)){x(!0);try{const o=await y.getAll({sort:{field:"name",direction:"asc"}});j(o);const D=(await c.getAll()).map(e=>e.toolId);S(D)}catch(o){h.error("Error fetching organization tools",{error:o,organizationId:s})}finally{x(!1)}}},[r,s,y,c]);i.useEffect(()=>{u()},[u]);const f=i.useMemo(()=>g.filter(o=>!m.includes(o.id)).map(o=>({id:o.id,label:o.name||"",description:o.description||"",icon:o.icon})),[g,m]),w=i.useMemo(()=>g.filter(o=>m.includes(o.id)).map(o=>({id:o.id,label:o.name||"",description:o.description||"",icon:o.icon})),[g,m]),E=i.useCallback(o=>{const b=o.map(D=>D.id);S(b)},[]),M=i.useCallback(async()=>{T(!0);try{const o=await c.getAll(),b=o.map(t=>t.toolId),D=m.filter(t=>!b.includes(t)),e=b.filter(t=>!m.includes(t));for(const t of e){const a=o.find(d=>d.toolId===t);a&&await c.delete(a.id)}for(const t of D)await c.create({toolId:t});h.info("Organization tools updated",{organizationId:s,added:D.length,removed:e.length}),l()}catch(o){h.error("Error saving organization tools",{error:o,organizationId:s})}finally{T(!1)}},[m,s,c,l]);return r?n.jsxs(P,{open:r,onClose:l,maxWidth:"lg",fullWidth:!0,children:[n.jsxs(V,{children:["Gerenciar Ferramentas - ",z]}),n.jsx(_,{children:C?n.jsx(B,{sx:{display:"flex",justifyContent:"center",p:4},children:n.jsx(H,{})}):n.jsx(B,{sx:{mt:2},children:n.jsx(W,{availableItems:f,selectedItems:w,onSelectionChange:E,availableTitle:"Ferramentas Disponíveis",selectedTitle:"Ferramentas da Organização",searchPlaceholder:"Buscar ferramentas...",loading:v})})}),n.jsxs($,{children:[n.jsx(q,{onClick:l,disabled:v,children:"Cancelar"}),n.jsx(q,{onClick:M,variant:"contained",disabled:v||C,children:v?"Salvando...":"Salvar"})]})]}):null},oe=()=>{const[r,l]=i.useState([]),[s,z]=i.useState({}),[g,j]=i.useState(!0),[m,S]=i.useState(null),[C,x]=i.useState(!1),[v,T]=i.useState(null),{showConfirmation:y,showAlert:c}=J(),u=i.useMemo(()=>R.getRepository("organization",N.Firestore,k.NoCache),[]),f=i.useCallback(async()=>{j(!0),S(null);try{const e=await u.getAll({sort:{field:"name",direction:"asc"}});l(e);const t=e.reduce((a,d)=>(a[d.id]=d.name,a),{});z(t)}catch(e){h.error("Error fetching organizations",{error:e}),S("Falha ao carregar as organizações. Por favor, tente novamente mais tarde.")}finally{j(!1)}},[u]);i.useEffect(()=>{f()},[f]);const w=i.useMemo(()=>[{field:"name",headerName:"Nome",width:250},{field:"abbreviation",headerName:"Abreviação",width:120},{field:"holding",headerName:"Holding",width:250,valueGetter:e=>s[e]||"-"},{field:"inclusionDate",headerName:"Data de Inclusão",width:180,valueGetter:e=>I(e)?.toLocaleDateString("pt-BR")||"-"},{field:"inactivationDate",headerName:"Data de Inativação",width:180,valueGetter:e=>e?I(e)?.toLocaleDateString("pt-BR"):"-"},{field:"id",headerName:"ID",flex:1}],[s]),E=i.useMemo(()=>r.map(e=>{const t=e.inclusionDate&&I(e.inclusionDate)?.toISOString().split("T")[0]||null,a=e.inactivationDate&&I(e.inactivationDate)?.toISOString().split("T")[0]||null;return{id:e.id,name:e.name||"",abbreviation:e.abbreviation||"",holding:e.holding||"",inclusionDate:t,inactivationDate:a,_original:e}}),[r]),M=i.useCallback(async(e,t)=>{try{const a={...e},d=a.id;if((a.holding===""||a.holding===void 0)&&(a.holding=null),a.inactivationDate){const p=a.inactivationDate instanceof A?a.inactivationDate.toDate():new Date(a.inactivationDate);a.inactivationDate=A.fromDate(p)}else a.inactivationDate=null;if(t){a.inclusionDate=A.now();const p=await u.create(a);l(O=>[...O,p]),h.info("Organização criada",{organizationId:p.id,name:e.name,abbreviation:e.abbreviation})}else{if(!d){c({title:"Erro",message:"ID da organização não encontrado."});return}delete a.inclusionDate,await u.update(d,a),l(p=>p.map(O=>O.id===d?{...O,...a,id:d}:O)),h.info("Organização alterada",{organizationId:d,name:e.name,abbreviation:e.abbreviation})}f()}catch(a){h.error("Error saving organization",{error:a,isNew:t,organizationId:e.id,name:e.name});const d=a instanceof Error?a.message:"Falha ao salvar a organização.";c({title:"Erro",message:d})}},[u,c,f]),o=i.useCallback(e=>{const t=e._original||r.find(a=>a.id===e.id);!t||!u||y({title:"Confirmar Remoção",message:`Tem certeza que deseja remover a organização "${t.name}"? Esta ação não pode ser desfeita.`,onConfirm:async()=>{try{await u.delete(t.id),l(r.filter(a=>a.id!==t.id)),h.info("Organização removida",{organizationId:t.id,name:t.name}),f()}catch(a){h.error("Error removing organization",{error:a,organizationId:t.id,name:t.name}),c({title:"Erro",message:"Falha ao remover organização. Por favor, tente novamente mais tarde."})}}})},[r,u,y,c,f]),b=i.useCallback(e=>{const t=e._original||r.find(a=>a.id===e.id);t&&(T(t),x(!0))},[r]),D=i.useMemo(()=>[{description:"Gerenciar Ferramentas",icon:n.jsx(K,{}),onClick:b}],[b]);return n.jsxs(U,{title:"Gerenciador de Organizações",children:[n.jsx(Q,{title:"Organizações",rows:E,columns:w,loading:g,error:m,initialValues:{id:"",name:"",abbreviation:"",holding:null,inactivationDate:null,inclusionDate:null},dialogTitle:"Organização",onSave:M,onDelete:o,onRefresh:f,onValidate:Z,hideAddButton:!1,actions:D,children:Y(s)}),v&&n.jsx(ee,{open:C,onClose:()=>{x(!1),T(null)},organizationId:v.id,organizationName:v.name})]})};export{oe as default};
