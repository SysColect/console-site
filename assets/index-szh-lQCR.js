import{j as i,H as L,r as o,K as q,M as V,N as $,O,B as A,P as k,Q as K,R as _,e as N,d as B,D as H,C as G,h as m,U as W,g as Z,V as Q,Z as U}from"./index-CpxBzFV8.js";import{T as R}from"./ToolPageLayout-BQ_XzRme.js";const J=()=>i.jsxs(i.Fragment,{children:[i.jsx(L,{name:"name",label:"Nome",formField:!0,required:!0}),i.jsx(L,{name:"abbreviation",label:"Abreviação",formField:!0,required:!0})]}),X=()=>i.jsx(J,{}),Y=r=>{const p={};return r.name||(p.name="O nome é obrigatório"),r.abbreviation||(p.abbreviation="A abreviação é obrigatória"),p},ee=({open:r,onClose:p,organizationId:s,profileId:f,profileName:T,currentToolIds:u=[],onSave:E})=>{const[x,I]=o.useState([]),[g,l]=o.useState([]),[y,C]=o.useState(!0),[c,t]=o.useState(!1),[h,b]=o.useState(null),v=o.useRef({}),S=o.useRef([]);o.useEffect(()=>{S.current=u||[]},[u]),o.useEffect(()=>{if(!r||!s){r||(v.current={},I([]),l([]),C(!0),b(null));return}const e=[...u||[]].sort().join(",");if(v.current.organizationId===s&&v.current.profileId===f&&v.current.toolIdsKey===e)return;v.current={organizationId:s,profileId:f,toolIdsKey:e},(async()=>{C(!0),b(null);try{const d=await B.getRepository(`organization/${s}/tools`,H.Firestore,G.NoCache).getAll(),M=S.current;I(d.filter(w=>!M.includes(w.id))),l(d.filter(w=>M.includes(w.id)))}catch(a){m.error("Error loading profile tools",{organizationId:s,profileId:f,error:a}),b("Erro ao carregar ferramentas. Tente novamente.")}finally{C(!1)}})()},[r,s,f,u]);const P=async()=>{t(!0),b(null);try{const e=g.map(n=>n.id);await E(e)}catch(e){m.error("Error saving profile tools",{organizationId:s,profileId:f,error:e}),b("Erro ao salvar ferramentas. Tente novamente."),t(!1)}},j=()=>{p()},D=o.useMemo(()=>x.map(e=>({id:e.id,label:e.name||e.toolId,description:e.description||""})),[x]),z=o.useMemo(()=>g.map(e=>({id:e.id,label:e.name||e.toolId,description:e.description||""})),[g]),F=e=>{const n=e.map(d=>d.id),a=x.concat(g).filter(d=>n.includes(d.id));l(a)};return i.jsxs(q,{open:r,onClose:j,maxWidth:"lg",fullWidth:!0,PaperProps:{sx:{height:"90vh",maxHeight:"90vh"}},children:[i.jsxs(V,{children:["Gerenciar Ferramentas - ",T]}),i.jsxs($,{sx:{display:"flex",flexDirection:"column",minHeight:0,p:2},children:[h&&i.jsx(O,{severity:"error",sx:{mb:2},children:h}),y?i.jsx(A,{sx:{display:"flex",justifyContent:"center",alignItems:"center",flex:1},children:i.jsx(k,{})}):i.jsx(A,{sx:{flex:1,minHeight:0,display:"flex",flexDirection:"column"},children:i.jsx(K,{availableItems:D,selectedItems:z,onSelectionChange:F,searchPlaceholder:"Buscar ferramentas...",availableTitle:"Ferramentas Disponíveis",selectedTitle:"Ferramentas do Perfil",loading:c,onSave:P,onCancel:j,containerHeight:600})})]}),i.jsxs(_,{sx:{p:2},children:[i.jsx(N,{onClick:j,disabled:c,children:"Cancelar"}),i.jsx(N,{onClick:P,variant:"contained",disabled:c||y,startIcon:c?i.jsx(k,{size:16}):null,children:"Salvar"})]})]})},ae=()=>{const{organizationData:r,isLoading:p}=W(),[s,f]=o.useState([]),[T,u]=o.useState(!0),[E,x]=o.useState(null),[I,g]=o.useState(!1),[l,y]=o.useState(null),{showConfirmation:C,showAlert:c}=Z(),t=o.useMemo(()=>r?.id?B.getRepository(`organization/${r.id}/profile`,H.Firestore,G.NoCache):null,[r?.id]),h=o.useCallback(async()=>{if(!r?.id||!t){u(!1);return}u(!0),x(null);try{const e=await t.getAll({sort:{field:"name",direction:"asc"}});f(e)}catch(e){m.error("Error fetching profiles",{error:e,organizationId:r.id}),x("Falha ao carregar perfis. Por favor, tente novamente mais tarde.")}finally{u(!1)}},[t,r?.id]);o.useEffect(()=>{h()},[h]);const b=o.useMemo(()=>[{field:"id",headerName:"ID",width:200},{field:"name",headerName:"Nome",width:250},{field:"abbreviation",headerName:"Abreviação",width:150}],[]),v=o.useMemo(()=>s.map(e=>({id:e.id,name:e.name||"",abbreviation:e.abbreviation||"",_original:e})),[s]),S=o.useCallback(async(e,n)=>{if(!r?.id||!t){c({title:"Erro",message:"Organização não encontrada."});return}try{if(n){const a=await t.create({name:e.name,abbreviation:e.abbreviation,toolIds:e.toolIds||[]});f(d=>[...d,a]),m.info("Perfil criado",{profileId:a.id,organizationId:r.id,name:e.name,abbreviation:e.abbreviation})}else{if(!e.id){c({title:"Erro",message:"ID do perfil não encontrado."});return}await t.update(e.id,{name:e.name,abbreviation:e.abbreviation,toolIds:e.toolIds||[]}),f(a=>a.map(d=>d.id===e.id?{...d,name:e.name,abbreviation:e.abbreviation,toolIds:e.toolIds||[]}:d)),m.info("Perfil alterado",{profileId:e.id,organizationId:r.id,name:e.name,abbreviation:e.abbreviation})}h()}catch(a){m.error("Error saving profile",{error:a,isNew:n,profileId:e.id,organizationId:r.id,name:e.name});const d=a instanceof Error?a.message:"Falha ao salvar o perfil.";c({title:"Erro",message:d})}},[r?.id,t,c,h]),P=o.useCallback(e=>{const n=e._original||s.find(a=>a.id===e.id);!n||!r||!t||C({title:"Confirmar Remoção",message:`Tem certeza que deseja remover o perfil "${n.name}"? Esta ação não pode ser desfeita.`,onConfirm:async()=>{try{await t.delete(n.id),f(s.filter(a=>a.id!==n.id)),m.info("Perfil removido",{profileId:n.id,organizationId:r.id,name:n.name})}catch(a){m.error("Error removing profile",{error:a,profileId:n.id,organizationId:r.id,name:n.name}),c({title:"Erro",message:"Falha ao remover perfil. Por favor, tente novamente mais tarde."})}}})},[s,r,t,C,c]),j=o.useCallback(e=>{const n=e._original||s.find(a=>a.id===e.id);n&&r&&(y(n),g(!0))},[s,r]),D=o.useCallback(()=>{g(!1),y(null)},[]),z=o.useCallback(async e=>{if(!(!l||!r?.id||!t))try{await t.update(l.id,{toolIds:e}),f(n=>n.map(a=>a.id===l.id?{...a,toolIds:e}:a)),m.info("Ferramentas do perfil atualizadas",{profileId:l.id,organizationId:r.id,toolIds:e}),g(!1),y(null)}catch(n){m.error("Error updating profile tools",{error:n,profileId:l.id,organizationId:r.id}),c({title:"Erro",message:"Falha ao salvar ferramentas do perfil."})}},[l,r,t,c]),F=o.useMemo(()=>[{icon:i.jsx(Q,{}),description:"Gerenciar Ferramentas",onClick:j}],[j]);return p?i.jsx(R,{title:"Gerenciador de Perfis",children:i.jsx(A,{sx:{display:"flex",justifyContent:"center",p:4},children:"Carregando organização..."})}):r?i.jsxs(R,{title:`Gerenciador de Perfis - ${r.name}`,children:[i.jsx(U,{title:"Perfis da Organização",rows:v,columns:b,loading:T,error:E,initialValues:{id:"",name:"",abbreviation:"",toolIds:[]},dialogTitle:"Perfil",onSave:S,onDelete:P,onRefresh:h,onValidate:Y,hideAddButton:!1,actions:F,children:X()}),l&&r&&i.jsx(ee,{open:I,onClose:D,organizationId:r.id,profileId:l.id,profileName:l.name,currentToolIds:l.toolIds,onSave:z})]}):i.jsx(R,{title:"Gerenciador de Perfis",children:i.jsx(O,{severity:"warning",children:"Nenhuma organização selecionada. Por favor, selecione uma organização para gerenciar os perfis."})})};export{ae as default};
