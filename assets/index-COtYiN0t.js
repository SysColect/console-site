import{c as re,j as e,r as s,q as $,s as G,t as H,u as V,p as M,v as O,w as X,a as A,x as q,y as oe,z as ie,E as K,F as le,G as ce,H as de,I as ue,J as he,K as R,M as F,o as _,l as Y,N as ee,L as se,O as ae,n as te,P as me,b as ge,B as Q,Q as xe,R as fe,S as pe,U as N,V as je,X as Se,Z as ve,$ as Ce}from"./index-BTPhf6Rc.js";import{T as ye}from"./ToolPageLayout-D6VjKgRe.js";import{T as De,a as Te,b as be,c as Z,d as k,e as Ee}from"./TableRow-BbDwb6XJ.js";const we=re(e.jsx("path",{d:"M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2m0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2"})),Ie=({open:l,onClose:c,user:n})=>{const[d,S]=s.useState(""),[v,T]=s.useState(""),[h,a]=s.useState(null),[m,E]=s.useState(null),b=$();s.useEffect(()=>{if(n){const r=n.name||(n.email?n.email.split("@")[0].replace(/[._]/g," ").replace(/\b\w/g,u=>u.toUpperCase()):"");S(r),T(n.email||""),a(n.inactivationDate?n.inactivationDate.toDate():null)}else S(""),T(""),a(null)},[n]);const g=async()=>{if(E(null),!!n)try{const r=q(b,"user",n.id),u=await oe(r),C={name:d,email:v,inactivationDate:h};(!u.exists()||!u.data()?.inclusionDate)&&(C.inclusionDate=new Date),await ie(r,C,{merge:!0}),c({...n,...C,inclusionDate:C.inclusionDate?K.fromDate(C.inclusionDate):n.inclusionDate,inactivationDate:h?K.fromDate(h):void 0})}catch(r){r instanceof Error?E(r.message):E("An unexpected error occurred."),console.error("Error updating user:",r)}},f=(r,u)=>{c()};return e.jsxs(G,{open:l,onClose:f,children:[e.jsx(H,{children:n?"Edit User":"Add User"}),e.jsxs(V,{children:[m&&e.jsx(M,{severity:"error",sx:{mb:2},children:m}),e.jsx(O,{autoFocus:!0,margin:"dense",id:"id",label:"User ID",type:"text",fullWidth:!0,disabled:!0,value:n?.id||""}),e.jsx(O,{margin:"dense",id:"name",label:"Name",type:"text",fullWidth:!0,value:d,onChange:r=>S(r.target.value)}),e.jsx(O,{margin:"dense",id:"email",label:"Email Address",type:"email",fullWidth:!0,disabled:!0,value:v}),e.jsx(O,{margin:"dense",id:"inclusionDate",label:"Inclusion Date",type:"text",fullWidth:!0,disabled:!0,value:n?.inclusionDate?n.inclusionDate instanceof Date?n.inclusionDate.toLocaleDateString():new Date(n.inclusionDate.seconds*1e3).toLocaleDateString():new Date().toLocaleDateString()}),e.jsx(O,{margin:"dense",id:"inactivationDate",label:"Inactivation Date",type:"date",fullWidth:!0,value:h?h.toISOString().split("T")[0]:"",onChange:r=>a(new Date(r.target.value)),InputLabelProps:{shrink:!0}})]}),e.jsxs(X,{children:[e.jsx(A,{onClick:()=>c(),children:"Cancel"}),e.jsx(A,{onClick:g,children:"Save"})]})]})},Oe=({open:l,onClose:c,onUserAdded:n})=>{const[d,S]=s.useState(""),[v,T]=s.useState(""),[h,a]=s.useState(null),m=s.useRef(null);s.useEffect(()=>{l&&setTimeout(()=>{m.current?.focus()},100)},[l]);const E=async()=>{if(a(null),!d||!v){a("Please fill in both email and password.");return}const g=`temp-app-${Date.now()}`,f=le(ce,g),r=de(f);try{const u=await ue(r,d,v);n(u.user.uid,d),c()}catch(u){u instanceof Error?a(u.message):a("An unexpected error occurred."),console.error("Error creating user:",u)}finally{he(f)}},b=()=>{S(""),T(""),a(null),c()};return e.jsxs(G,{open:l,onClose:b,children:[e.jsx(H,{children:"Incluir Novo Usuário"}),e.jsxs(V,{children:[h&&e.jsx(M,{severity:"error",sx:{mb:2},children:h}),e.jsx(O,{inputRef:m,autoFocus:!0,margin:"dense",id:"email",label:"Endereço de E-mail",type:"email",fullWidth:!0,variant:"standard",value:d,onChange:g=>S(g.target.value)}),e.jsx(O,{margin:"dense",id:"password",label:"Senha",type:"password",fullWidth:!0,variant:"standard",value:v,onChange:g=>T(g.target.value)})]}),e.jsxs(X,{children:[e.jsx(A,{onClick:b,children:"Cancelar"}),e.jsx(A,{onClick:E,children:"Salvar"})]})]})},Ae=({open:l,onClose:c,onSave:n,userId:d})=>{const[S,v]=s.useState([]),[T,h]=s.useState(!0),[a,m]=s.useState(null),[E,b]=s.useState(""),[g,f]=s.useState([]),[r,u]=s.useState([]),[C,i]=s.useState(!1),x=$(),p=s.useCallback(async()=>{if(!(!l||!d)){h(!0),m(null);try{const t=R(x,"consoleTool"),w=R(x,"user",d,"consoleTools"),[z,W]=await Promise.all([F(t),F(w)]),P=z.docs.map(y=>({id:y.id,...y.data()}));v(P);const j=W.docs.map(y=>({docId:y.id,toolId:y.data().toolId}));u(j),f(j.map(y=>y.toolId))}catch(t){console.error("Error fetching data:",t),m("Failed to load data. Please try again later.")}finally{h(!1)}}},[l,d,x]);s.useEffect(()=>{p()},[p]);const L=t=>{f(w=>w.includes(t)?w.filter(z=>z!==t):[...w,t])},U=async()=>{i(!0);try{const t=me(x),w=R(x,"user",d,"consoleTools"),z=r.map(j=>j.toolId);r.filter(j=>!g.includes(j.toolId)).forEach(j=>{const y=q(w,j.docId);t.delete(y)}),g.filter(j=>!z.includes(j)).forEach(j=>{const y=q(w);t.set(y,{toolId:j})}),await t.commit(),n(),c()}catch(t){console.error("Error saving user tools:",t),m("Failed to save changes.")}finally{i(!1)}},I=S.filter(t=>t.name.toLowerCase().includes(E.toLowerCase()));return e.jsxs(G,{open:l,onClose:c,fullWidth:!0,maxWidth:"md",children:[e.jsx(H,{children:"Gerenciar Ferramentas do Usuário"}),e.jsxs(V,{children:[e.jsx(O,{autoFocus:!0,margin:"dense",id:"search",label:"Buscar Ferramentas",type:"text",fullWidth:!0,variant:"standard",onChange:t=>b(t.target.value)}),T?e.jsx(_,{}):a?e.jsx(M,{severity:"error",children:a}):e.jsx(Y,{sx:{pt:2},children:I.map(t=>e.jsxs(ee,{onClick:()=>L(t.id),dense:!0,children:[e.jsx(se,{children:e.jsx(ae,{edge:"start",checked:g.includes(t.id),tabIndex:-1,disableRipple:!0})}),e.jsx(te,{primary:t.name,secondary:t.description})]},t.id))})]}),e.jsxs(X,{children:[e.jsx(A,{onClick:c,disabled:C,children:"Cancelar"}),e.jsx(A,{onClick:U,disabled:C,children:C?e.jsx(_,{size:24}):"Salvar"})]})]})},Ue=({open:l,onClose:c,onSave:n,userId:d})=>{const[S,v]=s.useState([]),[T,h]=s.useState(!0),[a,m]=s.useState(null),[E,b]=s.useState(""),[g,f]=s.useState([]),r=$();s.useEffect(()=>{const i=async()=>{try{const p=R(r,"user",d,"organizations"),U=(await F(p)).docs.map(I=>I.id);f(U)}catch(p){console.error("Error fetching user organizations:",p),m("Failed to load user organizations. Please try again later.")}},x=async()=>{h(!0),m(null);try{const p=R(r,"organization"),U=(await F(p)).docs.map(I=>({id:I.id,name:I.data().name,abbreviation:I.data().abbreviation}));v(U)}catch(p){console.error("Error fetching organizations:",p),m("Failed to load organizations. Please try again later.")}finally{h(!1)}};l&&(f([]),x(),i())},[l,r,d]);const u=i=>{f(x=>x.includes(i)?x.filter(p=>p!==i):[...x,i])},C=S.filter(i=>i.name.toLowerCase().includes(E.toLowerCase()));return e.jsxs(G,{open:l,onClose:c,fullWidth:!0,maxWidth:"md",children:[e.jsx(H,{children:"Manage User Organizations"}),e.jsxs(V,{children:[e.jsx(O,{autoFocus:!0,margin:"dense",id:"search",label:"Search Organizations",type:"text",fullWidth:!0,variant:"standard",onChange:i=>b(i.target.value)}),T?e.jsx(_,{}):a?e.jsx(M,{severity:"error",children:a}):e.jsx(Y,{children:C.map(i=>e.jsxs(ee,{onClick:()=>u(i.id),children:[e.jsx(se,{children:e.jsx(ae,{edge:"start",checked:g.includes(i.id),tabIndex:-1,disableRipple:!0})}),e.jsx(te,{primary:i.name,secondary:i.abbreviation})]},i.id))})]}),e.jsxs(X,{children:[e.jsx(A,{onClick:c,children:"Cancel"}),e.jsx(A,{onClick:()=>n(g),children:"Save"})]})]})},Re=()=>{const[l,c]=s.useState([]),[n,d]=s.useState(!0),[S,v]=s.useState(null),[T,h]=s.useState(null),[a,m]=s.useState(null),[E,b]=s.useState(!1),[g,f]=s.useState(!1),[r,u]=s.useState(!1),[C,i]=s.useState(!1),x=$(),{showConfirmation:p,showAlert:L}=ge(),U=s.useCallback(async()=>{d(!0),v(null);try{const o=R(x,"user"),B=(await F(o)).docs.map(J=>({id:J.id,...J.data()}));c(B)}catch(o){console.error("Error fetching users:",o),v("Falha ao carregar usuários. Tente novamente mais tarde.")}finally{d(!1)}},[x]);s.useEffect(()=>{U()},[U]);const I=(o,D)=>{h(o.currentTarget),m(D)},t=()=>{h(null)},w=()=>{b(!0),t()},z=()=>{t(),a&&p({title:"Confirmar Exclusão",message:`Tem certeza que deseja excluir o usuário ${a.email}? Esta ação não pode ser desfeita.`,onConfirm:async()=>{try{if(!a)return;const o=q(x,"user",a.id);await Se(o),await ve.deleteUser(a.id),c(l.filter(D=>D.id!==a.id))}catch(o){console.error("Error deleting user:",o),L({title:"Erro",message:"Falha ao excluir usuário. Tente novamente mais tarde."})}}})},W=()=>{u(!0),t()},P=()=>{i(!0),t()},j=()=>{f(!0)},y=(o,D)=>{const B={id:o,email:D};c([B,...l]),m(B),b(!0)},ne=async o=>{if(a)try{await Ce.updateUserOrganizations(a.id,o)}catch(D){console.error("Error saving organizations:",D),L({title:"Erro",message:"Falha ao salvar organizações. Tente novamente mais tarde."})}finally{i(!1)}};return e.jsx(ye,{title:"Gerenciador de Usuários",actions:e.jsx(A,{variant:"contained",color:"secondary",onClick:j,children:"Incluir Usuário"}),children:n?e.jsx(Q,{sx:{display:"flex",justifyContent:"center",mt:4},children:e.jsx(_,{})}):S?e.jsx(M,{severity:"error",children:S}):e.jsxs(Q,{sx:{width:"100%",overflowX:"auto"},children:[e.jsx(De,{component:xe,children:e.jsxs(Te,{sx:{minWidth:650},"aria-label":"simple table",children:[e.jsx(be,{children:e.jsxs(Z,{children:[e.jsx(k,{children:"ID do Usuário"}),e.jsx(k,{children:"Name"}),e.jsx(k,{children:"Email"}),e.jsx(k,{children:"Ações"})]})}),e.jsx(Ee,{children:l.map(o=>e.jsxs(Z,{sx:{"&:last-child td, &:last-child th":{border:0}},children:[e.jsx(k,{component:"th",scope:"row",children:o.id}),e.jsx(k,{children:o.name||"N/A"}),e.jsx(k,{children:o.email||"N/A"}),e.jsx(k,{children:e.jsx(fe,{"aria-label":"more","aria-controls":"long-menu","aria-haspopup":"true",onClick:D=>I(D,o),children:e.jsx(we,{})})})]},o.id))})]})}),e.jsxs(pe,{id:"long-menu",anchorEl:T,open:!!T,onClose:t,children:[e.jsx(N,{onClick:w,children:"Editar"}),e.jsx(N,{onClick:W,children:"Tools"}),e.jsx(N,{onClick:P,children:"Organizations"}),e.jsx(N,{onClick:z,children:"Excluir"})]}),e.jsx(Ie,{open:E,onClose:o=>{o&&c(l.map(D=>D.id===o.id?o:D)),b(!1)},user:a}),e.jsx(Oe,{open:g,onClose:()=>f(!1),onUserAdded:y}),a&&e.jsx(Ae,{open:r,onClose:()=>u(!1),onSave:()=>{je.remove(`user_tools_${a.id}`)},userId:a.id}),a&&e.jsx(Ue,{open:C,onClose:()=>i(!1),onSave:ne,userId:a.id})]})})};export{Re as default};
