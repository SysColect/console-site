import{g as Q,j as e,r as s,q as _,s as q,t as z,u as G,A as W,v as y,w as H,b as w,x as L,y as X,z as Y,E as $,G as Z,H as ee,J as F,K as O,p as N,m as se,M as te,f as ae,P as ne,o as oe,Q as re,F as le,B as J,R as ie,S as ce,U as de,V as P,W as ue,Y as he}from"./index-BZrIBs07.js";import{T as me}from"./ToolPageLayout-C5UHLxGO.js";import{T as xe,a as fe,b as ge,c as K,d as T,e as je}from"./TableRow-zg8OfqvF.js";const pe=Q(e.jsx("path",{d:"M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2m0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2"})),ve=({open:h,onClose:d,user:a})=>{const[u,g]=s.useState(""),[j,p]=s.useState(""),[m,r]=s.useState(null),[f,C]=s.useState(null),v=_();s.useEffect(()=>{if(a){const l=a.name||(a.email?a.email.split("@")[0].replace(/[._]/g," ").replace(/\b\w/g,D=>D.toUpperCase()):"");g(l),p(a.email||""),r(a.inactivationDate?a.inactivationDate.toDate():null)}else g(""),p(""),r(null)},[a]);const i=async()=>{if(C(null),!!a)try{const l=L(v,"user",a.id),D=await X(l),x={name:u,email:j,inactivationDate:m};(!D.exists()||!D.data()?.inclusionDate)&&(x.inclusionDate=new Date),await Y(l,x,{merge:!0}),d({...a,...x,inclusionDate:x.inclusionDate?$.fromDate(x.inclusionDate):a.inclusionDate,inactivationDate:m?$.fromDate(m):void 0})}catch(l){l instanceof Error?C(l.message):C("An unexpected error occurred."),console.error("Error updating user:",l)}},b=(l,D)=>{d()};return e.jsxs(q,{open:h,onClose:b,children:[e.jsx(z,{children:a?"Edit User":"Add User"}),e.jsxs(G,{children:[f&&e.jsx(W,{severity:"error",sx:{mb:2},children:f}),e.jsx(y,{autoFocus:!0,margin:"dense",id:"id",label:"User ID",type:"text",fullWidth:!0,disabled:!0,value:a?.id||""}),e.jsx(y,{margin:"dense",id:"name",label:"Name",type:"text",fullWidth:!0,value:u,onChange:l=>g(l.target.value)}),e.jsx(y,{margin:"dense",id:"email",label:"Email Address",type:"email",fullWidth:!0,disabled:!0,value:j}),e.jsx(y,{margin:"dense",id:"inclusionDate",label:"Inclusion Date",type:"text",fullWidth:!0,disabled:!0,value:a?.inclusionDate?a.inclusionDate instanceof Date?a.inclusionDate.toLocaleDateString():new Date(a.inclusionDate.seconds*1e3).toLocaleDateString():new Date().toLocaleDateString()}),e.jsx(y,{margin:"dense",id:"inactivationDate",label:"Inactivation Date",type:"date",fullWidth:!0,value:m?m.toISOString().split("T")[0]:"",onChange:l=>r(new Date(l.target.value)),InputLabelProps:{shrink:!0}})]}),e.jsxs(H,{children:[e.jsx(w,{onClick:()=>d(),children:"Cancel"}),e.jsx(w,{onClick:i,children:"Save"})]})]})},De=({open:h,onClose:d,onUserAdded:a})=>{const[u,g]=s.useState(""),[j,p]=s.useState(""),[m,r]=s.useState(null),f=s.useRef(null);s.useEffect(()=>{h&&setTimeout(()=>{f.current?.focus()},100)},[h]);const C=async()=>{if(r(null),!u||!j){r("Please fill in both email and password.");return}try{const i=await Z.getAuthService(void 0,ee).createUser(u,j);a(i.userId,u),d()}catch(i){i instanceof Error?r(i.message):r("An unexpected error occurred."),console.error("Error creating user:",i)}},v=()=>{g(""),p(""),r(null),d()};return e.jsxs(q,{open:h,onClose:v,children:[e.jsx(z,{children:"Incluir Novo Usuário"}),e.jsxs(G,{children:[m&&e.jsx(W,{severity:"error",sx:{mb:2},children:m}),e.jsx(y,{inputRef:f,autoFocus:!0,margin:"dense",id:"email",label:"Endereço de E-mail",type:"email",fullWidth:!0,variant:"standard",value:u,onChange:i=>g(i.target.value)}),e.jsx(y,{margin:"dense",id:"password",label:"Senha",type:"password",fullWidth:!0,variant:"standard",value:j,onChange:i=>p(i.target.value)})]}),e.jsxs(H,{children:[e.jsx(w,{onClick:v,children:"Cancelar"}),e.jsx(w,{onClick:C,children:"Salvar"})]})]})},Se=({open:h,onClose:d,onSave:a,userId:u})=>{const[g,j]=s.useState([]),[p,m]=s.useState(!0),[r,f]=s.useState(null),[C,v]=s.useState(""),[i,b]=s.useState([]),[l,D]=s.useState([]),[x,k]=s.useState(!1),E=_(),A=s.useCallback(async()=>{if(!(!h||!u)){m(!0),f(null);try{const t=F(E,"consoleTool"),S=F(E,"user",u,"consoleTools"),[I,R]=await Promise.all([O(t),O(S)]),n=I.docs.map(c=>({id:c.id,...c.data()}));j(n);const o=R.docs.map(c=>({docId:c.id,toolId:c.data().toolId}));D(o),b(o.map(c=>c.toolId))}catch(t){console.error("Error fetching data:",t),f("Failed to load data. Please try again later.")}finally{m(!1)}}},[h,u,E]);s.useEffect(()=>{A()},[A]);const M=t=>{b(S=>S.includes(t)?S.filter(I=>I!==t):[...S,t])},U=async()=>{k(!0);try{const t=re(E),S=F(E,"user",u,"consoleTools"),I=l.map(o=>o.toolId);l.filter(o=>!i.includes(o.toolId)).forEach(o=>{const c=L(S,o.docId);t.delete(c)}),i.filter(o=>!I.includes(o)).forEach(o=>{const c=L(S);t.set(c,{toolId:o})}),await t.commit(),a(),d()}catch(t){console.error("Error saving user tools:",t),f("Failed to save changes.")}finally{k(!1)}},B=g.filter(t=>t.name.toLowerCase().includes(C.toLowerCase()));return e.jsxs(q,{open:h,onClose:d,fullWidth:!0,maxWidth:"md",children:[e.jsx(z,{children:"Gerenciar Ferramentas do Usuário"}),e.jsxs(G,{children:[e.jsx(y,{autoFocus:!0,margin:"dense",id:"search",label:"Buscar Ferramentas",type:"text",fullWidth:!0,variant:"standard",onChange:t=>v(t.target.value)}),p?e.jsx(N,{}):r?e.jsx(W,{severity:"error",children:r}):e.jsx(se,{sx:{pt:2},children:B.map(t=>e.jsxs(te,{onClick:()=>M(t.id),dense:!0,children:[e.jsx(ae,{children:e.jsx(ne,{edge:"start",checked:i.includes(t.id),tabIndex:-1,disableRipple:!0})}),e.jsx(oe,{primary:t.name,secondary:t.description})]},t.id))})]}),e.jsxs(H,{children:[e.jsx(w,{onClick:d,disabled:x,children:"Cancelar"}),e.jsx(w,{onClick:U,disabled:x,children:x?e.jsx(N,{size:24}):"Salvar"})]})]})},be=()=>{const[h,d]=s.useState([]),[a,u]=s.useState(!0),[g,j]=s.useState(null),[p,m]=s.useState(null),[r,f]=s.useState(null),[C,v]=s.useState(!1),[i,b]=s.useState(!1),[l,D]=s.useState(!1),x=_(),{showConfirmation:k,showAlert:E}=le(),A=s.useCallback(async()=>{u(!0),j(null);try{const n=F(x,"user"),c=(await O(n)).docs.map(V=>({id:V.id,...V.data()}));d(c)}catch(n){console.error("Error fetching users:",n),j("Falha ao carregar usuários. Tente novamente mais tarde.")}finally{u(!1)}},[x]);s.useEffect(()=>{A()},[A]);const M=(n,o)=>{m(n.currentTarget),f(o)},U=()=>{m(null)},B=()=>{v(!0),U()},t=()=>{U(),r&&k({title:"Confirmar Exclusão",message:`Tem certeza que deseja excluir o usuário ${r.email}? Esta ação não pode ser desfeita.`,onConfirm:async()=>{try{if(!r)return;const n=L(x,"user",r.id);await he(n),d(h.filter(o=>o.id!==r.id))}catch(n){console.error("Error deleting user:",n),E({title:"Erro",message:"Falha ao excluir usuário. Tente novamente mais tarde."})}}})},S=()=>{D(!0),U()},I=()=>{b(!0)},R=(n,o)=>{const c={id:n,email:o};d([c,...h]),f(c),v(!0)};return e.jsx(me,{title:"Gerenciador de Usuários",actions:e.jsx(w,{variant:"contained",color:"secondary",onClick:I,children:"Incluir Usuário"}),children:a?e.jsx(J,{sx:{display:"flex",justifyContent:"center",mt:4},children:e.jsx(N,{})}):g?e.jsx(W,{severity:"error",children:g}):e.jsxs(J,{sx:{width:"100%",overflowX:"auto"},children:[e.jsx(xe,{component:ie,children:e.jsxs(fe,{sx:{minWidth:650},"aria-label":"simple table",children:[e.jsx(ge,{children:e.jsxs(K,{children:[e.jsx(T,{children:"ID do Usuário"}),e.jsx(T,{children:"Name"}),e.jsx(T,{children:"Email"}),e.jsx(T,{children:"Ações"})]})}),e.jsx(je,{children:h.map(n=>e.jsxs(K,{sx:{"&:last-child td, &:last-child th":{border:0}},children:[e.jsx(T,{component:"th",scope:"row",children:n.id}),e.jsx(T,{children:n.name||"N/A"}),e.jsx(T,{children:n.email||"N/A"}),e.jsx(T,{children:e.jsx(ce,{"aria-label":"more","aria-controls":"long-menu","aria-haspopup":"true",onClick:o=>M(o,n),children:e.jsx(pe,{})})})]},n.id))})]})}),e.jsxs(de,{id:"long-menu",anchorEl:p,open:!!p,onClose:U,children:[e.jsx(P,{onClick:B,children:"Editar"}),e.jsx(P,{onClick:S,children:"Tools"}),e.jsx(P,{onClick:t,children:"Excluir"})]}),e.jsx(ve,{open:C,onClose:n=>{n&&d(h.map(o=>o.id===n.id?n:o)),v(!1)},user:r}),e.jsx(De,{open:i,onClose:()=>b(!1),onUserAdded:R}),r&&e.jsx(Se,{open:l,onClose:()=>D(!1),onSave:()=>{ue.remove(`user_tools_${r.id}`)},userId:r.id})]})})};export{be as default};
