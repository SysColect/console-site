const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-Cw1vh47c.js","assets/index-xsX0E5NS.css"])))=>i.map(i=>d[i]);
import{G as A,j as d,e as h,f as B,L as C,_ as P,g as w,D,C as U,H as F,n as _,T as E,r as f,p as M,l as k,J as q,o as G,B as V,s as H,q as J}from"./index-Cw1vh47c.js";import{T as x}from"./ToolPageLayout-B48a5b2y.js";import{f as S}from"./dateUtils-D2aqTT2t.js";const K=A(d.jsx("path",{d:"M13 3c-4.97 0-9 4.03-9 9H1l4 4 4-4H6c0-3.86 3.14-7 7-7s7 3.14 7 7-3.14 7-7 7c-1.9 0-3.62-.76-4.88-1.99L6.7 18.42C8.32 20.01 10.55 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9m2 8v-1c0-1.1-.9-2-2-2s-2 .9-2 2v1c-.55 0-1 .45-1 1v3c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-3c0-.55-.45-1-1-1m-1 0h-2v-1c0-.55.45-1 1-1s1 .45 1 1z"})),Q=[{label:"User",value:"user"},{label:"Supervisor",value:"supervisor"},{label:"Admin",value:"admin"}],W=()=>{const s=!h.useContext(B)?.values?.id;return d.jsxs(d.Fragment,{children:[d.jsx(C,{name:"id",label:"ID do Usuário",formField:!0,disabled:!0,required:!1}),d.jsx(C,{name:"name",label:"Nome",formField:!0}),d.jsx(C,{name:"email",label:"Email",formField:!0,disabled:!s,required:s}),d.jsx(P,{name:"role",label:"Role",options:Q,formField:!0,required:!0}),d.jsx(C,{name:"inactivationDate",label:"Data de Inativação",type:"date",formField:!0})]})},X=()=>d.jsx(W,{}),Y=i=>{const s={};return i.name||(s.name="O nome é obrigatório"),i.email?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i.email)||(s.email="Email inválido"):s.email="O email é obrigatório",i.role?["user","supervisor","admin"].includes(i.role)||(s.role="Role inválido. Deve ser: user, supervisor ou admin"):s.role="O role é obrigatório",s},Z=()=>Math.floor(1e7+Math.random()*9e7).toString();class ee{async saveOrganizationUser(s,e){const{userData:a,organizationId:n}=s;return e?await this.createOrganizationUser({userData:{...a,inactivationDate:a.inactivationDate},organizationId:n}):await this.updateOrganizationUser({userId:a.id,userData:{name:a.name,email:a.email,role:a.role,inactivationDate:a.inactivationDate},organizationId:n})}async createOrganizationUser(s){const{userData:e,organizationId:a}=s;if(!e.email)throw new Error("Email é obrigatório para criar novo usuário.");let n,c=!1,y="";const p=w.getRepository("user",D.Firestore,U.NoCache);if(e.id)try{await p.getById(e.id),n=e.id,c=!0}catch{c=!1}if(c){n=e.id;const v=await p.getById(n);v&&(v.name!==e.name||v.email!==e.email)&&await p.update(n,{name:e.name,email:e.email})}else{y=Z();const{firebaseConfig:v}=await F(async()=>{const{firebaseConfig:R}=await import("./index-Cw1vh47c.js").then(I=>I.as);return{firebaseConfig:R}},__vite__mapDeps([0,1]));n=(await _.getAuthService(void 0,v).createUser(e.email,y)).user.uid,await p.create({id:n,email:e.email,name:e.name,inclusionDate:E.now()}),f.info("Usuário criado no Firebase",{userId:n,email:e.email})}const g=w.getRepository(`user/${n}/organizations`,D.Firestore,U.NoCache);try{await g.getById(a)}catch{await g.create({id:a,organizationId:a})}const m=w.getRepository(`organization/${a}/users`,D.Firestore,U.NoCache),z=e.inactivationDate?E.fromDate(new Date(e.inactivationDate)):null;try{await m.getById(n),await m.update(n,{role:e.role||"user",inactivationDate:z})}catch{await m.create({id:n,role:e.role||"user",inclusionDate:E.now(),inactivationDate:z})}return f.info("Usuário adicionado à organização",{userId:n,organizationId:a,email:e.email,name:e.name,role:e.role||"user"}),{userId:n,password:c?void 0:y,userCreated:!c}}async updateOrganizationUser(s){const{userId:e,userData:a,organizationId:n}=s,c=w.getRepository("user",D.Firestore,U.NoCache),y=w.getRepository(`organization/${n}/users`,D.Firestore,U.NoCache);if(a.name!==void 0||a.email!==void 0){const u={};a.name!==void 0&&(u.name=a.name),a.email!==void 0&&(u.email=a.email),await c.update(e,u)}const p=a.inactivationDate?E.fromDate(new Date(a.inactivationDate)):null,g={};a.role!==void 0&&(g.role=a.role),g.inactivationDate=p,await y.update(e,g),f.info("Usuário da organização alterado",{userId:e,organizationId:n,email:a.email,name:a.name,role:a.role,changes:{user:a.name||a.email?{name:a.name,email:a.email}:{},org:g}});const{combineOrganizationUserData:m}=await F(async()=>{const{combineOrganizationUserData:u}=await import("./index-Cw1vh47c.js").then(R=>R.at);return{combineOrganizationUserData:u}},__vite__mapDeps([0,1])),z=await c.getById(e);if(!z)throw new Error(`User ${e} not found`);const v=await y.getById(e);return m(z,v)}async removeOrganizationUser(s,e){await w.getRepository(`organization/${e}/users`,D.Firestore,U.NoCache).delete(s);const n=w.getRepository(`user/${s}/organizations`,D.Firestore,U.NoCache);try{await n.delete(e)}catch{f.warn("Could not remove user-organization link",{userId:s,organizationId:e})}f.info("Usuário removido da organização",{userId:s,organizationId:e})}}const j=new ee,oe=()=>{const{organizationData:i,isLoading:s}=M(),[e,a]=h.useState([]),[n,c]=h.useState(!0),[y,p]=h.useState(null),{showConfirmation:g,showAlert:m}=k(),z=h.useMemo(()=>i?.id?w.getRepository(`organization/${i.id}/users`,D.Firestore,U.NoCache):null,[i?.id]),v=h.useMemo(()=>w.getRepository("user",D.Firestore,U.NoCache),[]),u=h.useCallback(async()=>{if(!i?.id||!z){c(!1);return}c(!0),p(null);try{const r=await z.getAll({}),o=[];for(const t of r)try{const l=await v.getById(t.id);if(l){const O=q(l,t);o.push(O)}}catch{f.warn("User data not found for organization user",{userId:t.id,organizationId:i.id})}o.sort((t,l)=>(t.name||"").localeCompare(l.name||"")),a(o)}catch(r){f.error("Error fetching organization users",{error:r,organizationId:i.id}),p("Falha ao carregar usuários da organização. Por favor, tente novamente mais tarde.")}finally{c(!1)}},[z,v,i?.id]);h.useEffect(()=>{u()},[u]);const R=h.useCallback(r=>{const o=r._original||e.find(t=>t.id===r.id);!o||!o.email||g({title:"Confirmar Reset de Senha",message:`Deseja enviar um email de recuperação de senha para ${o.email}? O usuário receberá um link para redefinir a senha.`,onConfirm:async()=>{try{await _.getAuthService(void 0,G).sendPasswordResetEmail(o.email),f.info("Email de reset de senha enviado",{userId:o.id,email:o.email,organizationId:i?.id}),m({title:"Email Enviado",message:`Um email de recuperação de senha foi enviado para ${o.email}. O usuário deve verificar a caixa de entrada e seguir as instruções.`})}catch(t){f.error("Error sending password reset email",{error:t,userId:o.id,email:o.email,organizationId:i?.id});const l=t instanceof Error?t.message:"Falha ao enviar email de recuperação de senha.";m({title:"Erro",message:l})}}})},[e,i?.id,g,m]),I=h.useMemo(()=>[{icon:d.jsx(K,{}),description:"Resetar Senha",onClick:R}],[R]);if(s)return d.jsx(x,{title:"Gerenciador de Usuários da Organização",children:d.jsx(V,{sx:{display:"flex",justifyContent:"center",p:4},children:"Carregando organização..."})});if(!i)return d.jsx(x,{title:"Gerenciador de Usuários da Organização",children:d.jsx(H,{severity:"warning",children:"Nenhuma organização selecionada. Por favor, selecione uma organização para gerenciar os usuários."})});const N=[{field:"id",headerName:"ID do Usuário",width:200},{field:"name",headerName:"Nome",width:250},{field:"email",headerName:"Email",width:250},{field:"role",headerName:"Role",width:150,valueGetter:r=>r||"user"},{field:"inactivationDate",headerName:"Data de Inativação",width:180,valueGetter:r=>r?S(r)?.toLocaleDateString("pt-BR"):"-"}],$=e.map(r=>{const o=r.inactivationDate&&S(r.inactivationDate)?.toISOString().split("T")[0]||null;return{id:r.id,name:r.name||"",email:r.email||"",role:r.role||"user",inactivationDate:o,_original:r}}),L=async(r,o)=>{if(!i?.id){m({title:"Erro",message:"Organização não encontrada."});return}try{const t=await j.saveOrganizationUser({userData:{id:r.id,name:r.name,email:r.email,role:r.role,inactivationDate:r.inactivationDate},organizationId:i.id},o);if(o){const l=t;if(l.userCreated&&l.password){const O=`Email: ${r.email}
Senha: ${l.password}`;m({title:"Usuário Criado",message:`Usuário criado com sucesso!

Email: ${r.email}
Senha: ${l.password}

IMPORTANTE: Anote esta senha, ela não será exibida novamente.`,copyText:O})}u()}else{const l=t;a(O=>O.map(b=>b.id===l.id?l:b)),u()}}catch(t){f.error("Error saving organization user",{error:t,isNew:o,userId:r.id,organizationId:i.id,email:r.email});const l=t instanceof Error?t.message:"Falha ao salvar o usuário da organização.";m({title:"Erro",message:l})}},T=r=>{const o=r._original||e.find(t=>t.id===r.id);!o||!i||g({title:"Confirmar Remoção",message:`Tem certeza que deseja remover o usuário ${o.email} desta organização? Esta ação não pode ser desfeita.`,onConfirm:async()=>{try{await j.removeOrganizationUser(o.id,i.id),a(e.filter(t=>t.id!==o.id))}catch(t){f.error("Error removing user from organization",{error:t,userId:o.id,organizationId:i.id,email:o.email}),m({title:"Erro",message:"Falha ao remover usuário da organização. Por favor, tente novamente mais tarde."})}}})};return d.jsx(x,{title:`Gerenciador de Usuários - ${i.name}`,children:d.jsx(J,{title:"Usuários da Organização",rows:$,columns:N,loading:n,error:y,initialValues:{id:"",name:"",email:"",role:"user",inactivationDate:null},dialogTitle:"Usuário da Organização",onSave:L,onDelete:T,onRefresh:u,onValidate:Y,hideAddButton:!1,actions:I,children:X()})})};export{oe as default};
