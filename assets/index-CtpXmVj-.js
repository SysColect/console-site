const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/dateUtils-BvssmbZU.js","assets/index-CpxBzFV8.js","assets/index-xsX0E5NS.css"])))=>i.map(i=>d[i]);
import{c as oe,j as i,b as J,H as F,X as se,r as t,d as B,D as G,C as U,h as c,B as _,T as L,Y as Z,K as le,M as de,N as ce,P as ue,_ as ge,a0 as me,a1 as fe,R as he,a2 as pe,e as ye,a3 as be,a4 as ve,q as xe,a as ze,t as De,a5 as Te,a6 as we,a7 as Q,a8 as Oe,g as je,a9 as Se,i as K,aa as Ce,V as Ee,Z as Me}from"./index-CpxBzFV8.js";import{T as Fe}from"./ToolPageLayout-BQ_XzRme.js";import{f as q}from"./dateUtils-BvssmbZU.js";const Re=oe(i.jsx("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"})),Ae=({organizationsMap:g})=>i.jsxs(i.Fragment,{children:[i.jsx(F,{name:"name",label:"Nome",formField:!0,required:!0}),i.jsx(F,{name:"abbreviation",label:"Abreviação",formField:!0,required:!0}),i.jsx(se,{name:"holding",label:"Holding",optionsMap:g,formField:!0}),i.jsx(F,{name:"inactivationDate",label:"Data de Inativação",type:"date",formField:!0}),i.jsx(F,{name:"inclusionDate",label:"Data de Inclusão",type:"date",formField:!0,disabled:!0})]}),Ie=g=>i.jsx(Ae,{organizationsMap:g}),Pe=g=>{const s={};return s.name=J.required("O nome da organização é obrigatório")(g.name),s.abbreviation=J.required("A abreviação é obrigatória")(g.abbreviation),Object.entries(s).reduce((n,[m,d])=>(d&&(n[m]=d),n),{})},Ne=({open:g,onClose:s,organizationId:n,organizationName:m})=>{const[d,f]=t.useState([]),[x,b]=t.useState([]),[D,V]=t.useState({}),[R,A]=t.useState(!0),[I,T]=t.useState(!1),[P,O]=t.useState(null),[k,C]=t.useState(!1),[h,E]=t.useState(null),N=t.useMemo(()=>B.getRepository("tool",G.Firestore,U.InMemory),[]),w=t.useMemo(()=>B.getRepository(`organization/${n}/tools`,G.Firestore,U.InMemory),[n]),r=t.useCallback(async()=>{if(!(!g||!n)){A(!0);try{const e=await N.getAll({sort:{field:"name",direction:"asc"}});f(e);const a={};e.forEach(y=>{a[y.id]=y}),V(a);const l=await w.getAll();b(l)}catch(e){c.error("Error fetching organization tools",{error:e,organizationId:n})}finally{A(!1)}}},[g,n,N,w]);t.useEffect(()=>{r()},[r]);const u=t.useMemo(()=>x.map(e=>{const a=D[e.toolId];return a?{id:e.id,toolId:e.toolId,name:e.name??a.name,description:e.description??a.description,billingType:e.billingType??a.billingType??"free",value:e.value??a.value??null,icon:a.icon,_original:e}:{id:e.id,toolId:e.toolId,name:e.name||"Tool não encontrada",description:e.description||"",billingType:e.billingType||"free",value:e.value||null,icon:void 0,_original:e}}),[x,D]),o=t.useMemo(()=>{const e=new Set(x.map(a=>a.toolId));return d.filter(a=>a.allowMultipleInsertions?!0:!e.has(a.id)).map(a=>({id:a.id,label:a.name,tool:a}))},[d,x]),p=t.useMemo(()=>[{field:"name",headerName:"Nome",width:250},{field:"description",headerName:"Descrição",width:300,flex:1},{field:"billingType",headerName:"Tipo de Cobrança",width:150,valueGetter:e=>({free:"Free",monthly:"Mensal","on-demand":"Por Demanda"})[e]||e},{field:"value",headerName:"Valor",width:120,valueGetter:e=>e==null?"-":e.toFixed(2)}],[]),v=t.useMemo(()=>u.map(e=>({id:e.id,name:e.name,description:e.description,billingType:e.billingType,value:e.value,_original:e})),[u]),j=t.useCallback(e=>{if(!e)return;const a=d.find(y=>y.id===e);if(!a)return;if(!a.allowMultipleInsertions&&x.some(z=>z.toolId===e)){c.warn("Tool já adicionada",{toolId:e,organizationId:n});return}const l={toolId:e};b(y=>[...y,{...l,id:`temp-${Date.now()}`}]),O(null),w.create(l).then(y=>{b(z=>z.map(M=>M.id.startsWith("temp-")?y:M)),c.info("Tool adicionada à organização",{toolId:e,organizationId:n})}).catch(y=>{c.error("Error adding tool to organization",{error:y,toolId:e,organizationId:n}),b(z=>z.filter(M=>!M.id.startsWith("temp-")))})},[d,x,n,w]),S=t.useCallback(e=>{const a=e._original;E(a),C(!0)},[]),W=t.useCallback(async e=>{if(h){T(!0);try{const a={},l=D[h.toolId];l?(e.name!==l.name&&(a.name=e.name),e.description!==l.description&&(a.description=e.description),e.billingType!==l.billingType&&(a.billingType=e.billingType),e.value!==l.value&&(a.value=e.value)):(a.name=e.name,a.description=e.description,a.billingType=e.billingType,a.value=e.value),await w.update(h.id,a),b(y=>y.map(z=>z.id===h.id?{...z,...a}:z)),c.info("Organization tool updated",{organizationId:n,toolId:h.id}),C(!1),E(null)}catch(a){c.error("Error updating organization tool",{error:a,organizationId:n,toolId:h.id})}finally{T(!1)}}},[h,D,n,w]),H=t.useCallback(async e=>{if(e.length===0)return;const a=e.map(l=>l.id);T(!0);try{for(const l of a)await w.delete(l);b(l=>l.filter(y=>!a.includes(y.id))),c.info("Organization tools deleted",{organizationId:n,count:a.length})}catch(l){c.error("Error deleting organization tools",{error:l,organizationId:n})}finally{T(!1)}},[n,w]),$=t.useCallback(e=>{const a={};if(e.name||(a.name="O nome é obrigatório"),e.billingType||(a.billingType="O tipo de cobrança é obrigatório"),e.billingType&&e.billingType!=="free"){const l=e.value;(!l||l===null||l===void 0||isNaN(l)||l<=0)&&(a.value="O valor deve ser maior que zero quando o tipo de cobrança não é Free.")}return a},[]),ee=t.useMemo(()=>[{label:"Excluir Selecionados",icon:i.jsx(Re,{}),onClick:H,disabled:e=>e.length===0,color:"error",variant:"outlined"}],[H]),ae=t.useMemo(()=>{const e=u.length,a=u.filter(z=>z.billingType==="free").length,l=e-a,y=u.reduce((z,M)=>z+(M.value||0),0);return i.jsxs(_,{sx:{display:"flex",gap:2},children:[i.jsxs(L,{variant:"body2",color:"text.secondary",children:["Total: ",i.jsx("strong",{children:e})]}),i.jsxs(L,{variant:"body2",color:"text.secondary",children:["Gratuitas: ",i.jsx("strong",{children:a})]}),i.jsxs(L,{variant:"body2",color:"text.secondary",children:["Pagas: ",i.jsx("strong",{children:l})]}),i.jsxs(L,{variant:"body2",color:"text.secondary",children:["Valor Total: ",i.jsx("strong",{children:y.toFixed(2)})]})]})},[u]),X=Z.useRef(null),[ie,te]=Z.useState(600);Z.useEffect(()=>{const e=()=>{if(X.current){const l=X.current.getBoundingClientRect().height-48;te(Math.max(400,l))}};if(g){const a=setTimeout(e,100);return window.addEventListener("resize",e),()=>{clearTimeout(a),window.removeEventListener("resize",e)}}},[g]);const ne=t.useMemo(()=>h?{name:h.name,description:h.description,billingType:h.billingType,value:h.value}:{},[h]),re=()=>t.useContext(ze)?.values?.billingType==="free"?null:i.jsx(De,{name:"value",label:"Valor",formField:!0,decimals:2});return i.jsxs(i.Fragment,{children:[i.jsxs(le,{open:g,onClose:s,maxWidth:"lg",fullWidth:!0,PaperProps:{sx:{height:"90vh",maxHeight:"90vh"}},children:[i.jsxs(de,{children:["Gerenciar Ferramentas - ",m]}),i.jsx(ce,{ref:X,sx:{flex:1,display:"flex",flexDirection:"column",minHeight:0,overflow:"hidden"},children:R?i.jsx(_,{sx:{display:"flex",justifyContent:"center",p:4},children:i.jsx(ue,{})}):i.jsxs(_,{sx:{flex:1,display:"flex",flexDirection:"column",minHeight:0,width:"100%"},children:[i.jsx(_,{sx:{mb:3},children:i.jsx(ge,{value:P?o.find(e=>e.id===P):null,onChange:(e,a)=>{a&&j(a.id)},options:o,getOptionLabel:e=>e.label,renderInput:e=>i.jsx(me,{...e,label:"Adicionar Ferramenta",placeholder:"Selecione uma ferramenta para adicionar"}),disabled:I})}),i.jsx(_,{sx:{flex:1,minHeight:0},children:i.jsx(fe,{columns:p,rows:v,onEdit:S,globalActions:ee,infoComponent:ae,height:ie-100})})]})}),i.jsx(he,{sx:{px:3,py:2,flexShrink:0},children:i.jsx(pe,{title:"Pressione 'Esc' para cancelar",children:i.jsx("span",{children:i.jsx(ye,{onClick:s,disabled:I,children:"Fechar"})})})})]}),k&&h&&i.jsx(be,{open:k,onClose:()=>{C(!1),E(null)},title:"Editar Ferramenta da Organização",children:i.jsxs(ve,{initialValues:ne,onSubmit:W,onValidate:$,onCancel:()=>{C(!1),E(null)},children:[i.jsx(F,{name:"name",label:"Nome",formField:!0,required:!0}),i.jsx(F,{name:"description",label:"Descrição",multiline:!0,rows:3,formField:!0}),i.jsx(xe,{name:"billingType",label:"Tipo de Cobrança",options:[{value:"free",label:"Free"},{value:"monthly",label:"Mensal"},{value:"on-demand",label:"Por Demanda"}],formField:!0,required:!0}),i.jsx(re,{})]},h.id)})]})};class _e{organizationRepository;constructor(){this.organizationRepository=B.getRepository("organization",G.Firestore,U.InMemory)}async getOrganizationData(s){return Te.getOrganizationData(s)}async getAllOrganizations(){try{return await this.organizationRepository.getAll()}catch(s){throw c.error("Error fetching all organizations",{error:s}),s}}async createOrganizationData(s,n,m){try{const d=await this.organizationRepository.create({...n,id:s});if(c.info("Organization created",{orgId:s,data:n}),m)try{const f=await we.getUserData(m);if(f&&f.email){await Q.saveOrganizationUser({userData:{id:m,name:f.name||"",email:f.email,role:"admin"},organizationId:d.id},!0),c.info("User added to organization as admin",{userId:m,orgId:d.id});try{const x=B.getRepository(`organization/${d.id}/profile`,G.Firestore,U.InMemory);let b;try{const D=await x.getById("ADM");if(D)b=D.id;else throw new Error("Profile not found")}catch{const D={id:"ADM",name:"Administrador",abbreviation:"ADM"};await x.create(D),b="ADM",c.info("Admin profile created",{orgId:d.id,profileId:b})}await Oe.setUserProfiles(d.id,m,[b]),await Q.setUserCurrentProfile(d.id,m,b),c.info("Admin profile associated to user",{userId:m,orgId:d.id,profileId:b})}catch(x){c.error("Error creating admin profile for user",{userId:m,orgId:d.id,error:x})}}else c.warn("Could not add user to organization: user data not found or missing email",{userId:m,orgId:d.id})}catch(f){c.error("Error adding user to organization during creation",{userId:m,orgId:d.id,error:f})}return d}catch(d){throw c.error("Error creating organization data",{data:n,error:d}),d}}async updateOrganizationData(s,n){try{await this.organizationRepository.update(s,n)}catch(m){throw c.error("Error updating organization data",{orgId:s,error:m}),m}}async deleteOrganizationData(s){try{await this.organizationRepository.delete(s)}catch(n){throw c.error("Error deleting organization data",{orgId:s,error:n}),n}}async clearOrganizationCache(s){try{await this.organizationRepository.invalidateCache(s)}catch(n){throw c.error("Error clearing organization cache",{orgId:s,error:n}),n}}async getOrganizationsByIds(s){const n=s.map(f=>this.getOrganizationData(f)),m=await Promise.allSettled(n),d=[];return m.forEach(f=>{f.status==="fulfilled"&&f.value?d.push(f.value):f.status==="rejected"&&c.warn("Failed to fetch an organization, it might be invalid or deleted.",{reason:f.reason})}),d}}const Y=new _e,Le=()=>{const[g,s]=t.useState([]),[n,m]=t.useState({}),[d,f]=t.useState(!0),[x,b]=t.useState(null),[D,V]=t.useState(!1),[R,A]=t.useState(null),{showConfirmation:I,showAlert:T}=je(),{currentUserData:P}=Se(),O=t.useCallback(async()=>{f(!0),b(null);try{const u=(await Y.getAllOrganizations()).sort((p,v)=>(p.name||"").localeCompare(v.name||""));s(u);const o=u.reduce((p,v)=>(p[v.id]=v.name,p),{});m(o)}catch(r){c.error("Error fetching organizations",{error:r}),b("Falha ao carregar as organizações. Por favor, tente novamente mais tarde.")}finally{f(!1)}},[]);t.useEffect(()=>{O()},[O]);const k=t.useMemo(()=>[{field:"name",headerName:"Nome",width:250},{field:"abbreviation",headerName:"Abreviação",width:120},{field:"holding",headerName:"Holding",width:250,valueGetter:r=>n[r]||"-"},{field:"inclusionDate",headerName:"Data de Inclusão",width:180,valueGetter:r=>q(r)?.toLocaleDateString("pt-BR")||"-"},{field:"inactivationDate",headerName:"Data de Inativação",width:180,valueGetter:r=>r?q(r)?.toLocaleDateString("pt-BR"):"-"},{field:"id",headerName:"ID",flex:1}],[n]),C=t.useMemo(()=>g.map(r=>{const u=r.inclusionDate&&q(r.inclusionDate)?.toISOString().split("T")[0]||null,o=r.inactivationDate&&q(r.inactivationDate)?.toISOString().split("T")[0]||null;return{id:r.id,name:r.name||"",abbreviation:r.abbreviation||"",holding:r.holding||"",inclusionDate:u,inactivationDate:o,_original:r}}),[g]),h=t.useCallback(async(r,u)=>{try{const o={...r},p=o.id;if((o.holding===""||o.holding===void 0)&&(o.holding=null),o.inactivationDate){const v=o.inactivationDate instanceof K?o.inactivationDate.toDate():new Date(o.inactivationDate);o.inactivationDate=K.fromDate(v)}else o.inactivationDate=null;if(u){o.inclusionDate=K.now();const v=P?.id,j=await Y.createOrganizationData(p||"",o,v);s(S=>[...S,j]),c.info("Organização criada",{organizationId:j.id,name:r.name,abbreviation:r.abbreviation,userId:v||"não fornecido"})}else{if(!p){T({title:"Erro",message:"ID da organização não encontrado."});return}delete o.inclusionDate,await Y.updateOrganizationData(p,o),s(v=>v.map(j=>j.id===p?{...j,...o,id:p}:j)),c.info("Organização alterada",{organizationId:p,name:r.name,abbreviation:r.abbreviation})}O()}catch(o){c.error("Error saving organization",{error:o,isNew:u,organizationId:r.id,name:r.name});const p=o instanceof Error?o.message:"Falha ao salvar a organização.";T({title:"Erro",message:p})}},[T,O,P]),E=t.useCallback(r=>{const u=r._original||g.find(o=>o.id===r.id);u&&I({title:"Confirmar Remoção",message:`Tem certeza que deseja remover a organização "${u.name}"? Esta ação não pode ser desfeita.`,onConfirm:async()=>{try{const{repositoryFactory:o,DataSourceStrategy:p,CacheStrategy:v}=await Ce(async()=>{const{repositoryFactory:S,DataSourceStrategy:W,CacheStrategy:H}=await import("./dateUtils-BvssmbZU.js").then($=>$.i);return{repositoryFactory:S,DataSourceStrategy:W,CacheStrategy:H}},__vite__mapDeps([0,1,2]));await o.getRepository("organization",p.Firestore,v.NoCache).delete(u.id),s(g.filter(S=>S.id!==u.id)),c.info("Organização removida",{organizationId:u.id,name:u.name}),O()}catch(o){c.error("Error removing organization",{error:o,organizationId:u.id,name:u.name}),T({title:"Erro",message:"Falha ao remover organização. Por favor, tente novamente mais tarde."})}}})},[g,I,T,O]),N=t.useCallback(r=>{const u=r._original||g.find(o=>o.id===r.id);u&&(A(u),V(!0))},[g]),w=t.useMemo(()=>[{description:"Gerenciar Ferramentas",icon:i.jsx(Ee,{}),onClick:N}],[N]);return i.jsxs(Fe,{title:"Gerenciador de Organizações",children:[i.jsx(Me,{title:"Organizações",rows:C,columns:k,loading:d,error:x,initialValues:{id:"",name:"",abbreviation:"",holding:null,inactivationDate:null,inclusionDate:null},dialogTitle:"Organização",onSave:h,onDelete:E,onRefresh:O,onValidate:Pe,hideAddButton:!1,actions:w,children:Ie(n)}),R&&i.jsx(Ne,{open:D,onClose:()=>{V(!1),A(null)},organizationId:R.id,organizationName:R.name})]})};export{Le as default};
