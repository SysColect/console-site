import{j as n,d as B,L as w,v as V,r as t,b as L,D as k,C as N,g as h,m as M,n as _,o as W,p as $,B as H,s as J,t as K,w as Q,x as P,c as q,f as U,T as A,z as X,q as Y}from"./index-uAI7Wxyl.js";import{T as Z}from"./ToolPageLayout-CZQyGkns.js";import{f as E}from"./dateUtils-DAhjZAap.js";const ee=({organizationsMap:o})=>n.jsxs(n.Fragment,{children:[n.jsx(w,{name:"name",label:"Nome",formField:!0,required:!0}),n.jsx(w,{name:"abbreviation",label:"Abreviação",formField:!0,required:!0}),n.jsx(V,{name:"holding",label:"Holding",optionsMap:o,formField:!0}),n.jsx(w,{name:"inactivationDate",label:"Data de Inativação",type:"date",formField:!0}),n.jsx(w,{name:"inclusionDate",label:"Data de Inclusão",type:"date",formField:!0,disabled:!0})]}),ae=o=>n.jsx(ee,{organizationsMap:o}),te=o=>{const c={};return c.name=B.required("O nome da organização é obrigatório")(o.name),c.abbreviation=B.required("A abreviação é obrigatória")(o.abbreviation),Object.entries(c).reduce((s,[b,g])=>(g&&(s[b]=g),s),{})},ie=({open:o,onClose:c,organizationId:s,organizationName:b})=>{const[g,T]=t.useState([]),[m,x]=t.useState([]),[j,D]=t.useState(!0),[v,z]=t.useState(!1),S=t.useMemo(()=>L.getRepository("consoleTool",k.Firestore,N.NoCache),[]),d=t.useMemo(()=>L.getRepository(`organization/${s}/tools`,k.Firestore,N.NoCache),[s]),u=t.useCallback(async()=>{if(!(!o||!s)){D(!0);try{const e=await S.getAll({sort:{field:"name",direction:"asc"}});T(e);const a=(await d.getAll()).map(l=>l.toolId);x(a)}catch(e){h.error("Error fetching organization tools",{error:e,organizationId:s})}finally{D(!1)}}},[o,s,S,d]);t.useEffect(()=>{u()},[u]);const f=t.useMemo(()=>g.filter(e=>!m.includes(e.id)).map(e=>({id:e.id,label:e.name||"",description:e.description||"",icon:e.icon})),[g,m]),I=t.useMemo(()=>g.filter(e=>m.includes(e.id)).map(e=>({id:e.id,label:e.name||"",description:e.description||"",icon:e.icon})),[g,m]),F=t.useCallback(e=>{const i=e.map(a=>a.id);x(i)},[]),C=t.useCallback(async()=>{z(!0);try{const e=await d.getAll(),i=e.map(r=>r.toolId),a=m.filter(r=>!i.includes(r)),l=i.filter(r=>!m.includes(r));for(const r of l){const p=e.find(G=>G.toolId===r);p&&await d.delete(p.id)}for(const r of a)await d.create({toolId:r});h.info("Organization tools updated",{organizationId:s,added:a.length,removed:l.length}),c()}catch(e){h.error("Error saving organization tools",{error:e,organizationId:s})}finally{z(!1)}},[m,s,d,c]),y=M.useRef(null),[O,R]=M.useState(600);return M.useEffect(()=>{const e=()=>{if(y.current){const i=y.current.getBoundingClientRect();R(i.height-48)}};return o&&(setTimeout(e,100),window.addEventListener("resize",e)),()=>{window.removeEventListener("resize",e)}},[o]),n.jsxs(_,{open:o,onClose:c,maxWidth:"lg",fullWidth:!0,PaperProps:{sx:{height:"90vh",maxHeight:"90vh"}},children:[n.jsxs(W,{children:["Gerenciar Ferramentas - ",b]}),n.jsx($,{ref:y,sx:{flex:1,display:"flex",flexDirection:"column",minHeight:0,overflow:"hidden"},children:j?n.jsx(H,{sx:{display:"flex",justifyContent:"center",p:4},children:n.jsx(J,{})}):n.jsx(H,{sx:{flex:1,display:"flex",flexDirection:"column",minHeight:0},children:n.jsx(K,{availableItems:f,selectedItems:I,onSelectionChange:F,availableTitle:"Ferramentas Disponíveis",selectedTitle:"Ferramentas da Organização",searchPlaceholder:"Buscar ferramentas...",loading:v,onSave:C,onCancel:c,containerHeight:O})})}),n.jsxs(Q,{sx:{px:3,py:2,flexShrink:0},children:[n.jsx(P,{title:"Pressione 'Esc' para cancelar",children:n.jsx("span",{children:n.jsx(q,{onClick:c,disabled:v,children:"Cancelar"})})}),n.jsx(P,{title:"Pressione 'Ctrl+Enter' para salvar",children:n.jsx("span",{children:n.jsx(q,{onClick:C,variant:"contained",disabled:v||j,children:v?"Salvando...":"Salvar"})})})]})]})},se=()=>{const[o,c]=t.useState([]),[s,b]=t.useState({}),[g,T]=t.useState(!0),[m,x]=t.useState(null),[j,D]=t.useState(!1),[v,z]=t.useState(null),{showConfirmation:S,showAlert:d}=U(),u=t.useMemo(()=>L.getRepository("organization",k.Firestore,N.NoCache),[]),f=t.useCallback(async()=>{T(!0),x(null);try{const e=await u.getAll({sort:{field:"name",direction:"asc"}});c(e);const i=e.reduce((a,l)=>(a[l.id]=l.name,a),{});b(i)}catch(e){h.error("Error fetching organizations",{error:e}),x("Falha ao carregar as organizações. Por favor, tente novamente mais tarde.")}finally{T(!1)}},[u]);t.useEffect(()=>{f()},[f]);const I=t.useMemo(()=>[{field:"name",headerName:"Nome",width:250},{field:"abbreviation",headerName:"Abreviação",width:120},{field:"holding",headerName:"Holding",width:250,valueGetter:e=>s[e]||"-"},{field:"inclusionDate",headerName:"Data de Inclusão",width:180,valueGetter:e=>E(e)?.toLocaleDateString("pt-BR")||"-"},{field:"inactivationDate",headerName:"Data de Inativação",width:180,valueGetter:e=>e?E(e)?.toLocaleDateString("pt-BR"):"-"},{field:"id",headerName:"ID",flex:1}],[s]),F=t.useMemo(()=>o.map(e=>{const i=e.inclusionDate&&E(e.inclusionDate)?.toISOString().split("T")[0]||null,a=e.inactivationDate&&E(e.inactivationDate)?.toISOString().split("T")[0]||null;return{id:e.id,name:e.name||"",abbreviation:e.abbreviation||"",holding:e.holding||"",inclusionDate:i,inactivationDate:a,_original:e}}),[o]),C=t.useCallback(async(e,i)=>{try{const a={...e},l=a.id;if((a.holding===""||a.holding===void 0)&&(a.holding=null),a.inactivationDate){const r=a.inactivationDate instanceof A?a.inactivationDate.toDate():new Date(a.inactivationDate);a.inactivationDate=A.fromDate(r)}else a.inactivationDate=null;if(i){a.inclusionDate=A.now();const r=await u.create(a);c(p=>[...p,r]),h.info("Organização criada",{organizationId:r.id,name:e.name,abbreviation:e.abbreviation})}else{if(!l){d({title:"Erro",message:"ID da organização não encontrado."});return}delete a.inclusionDate,await u.update(l,a),c(r=>r.map(p=>p.id===l?{...p,...a,id:l}:p)),h.info("Organização alterada",{organizationId:l,name:e.name,abbreviation:e.abbreviation})}f()}catch(a){h.error("Error saving organization",{error:a,isNew:i,organizationId:e.id,name:e.name});const l=a instanceof Error?a.message:"Falha ao salvar a organização.";d({title:"Erro",message:l})}},[u,d,f]),y=t.useCallback(e=>{const i=e._original||o.find(a=>a.id===e.id);!i||!u||S({title:"Confirmar Remoção",message:`Tem certeza que deseja remover a organização "${i.name}"? Esta ação não pode ser desfeita.`,onConfirm:async()=>{try{await u.delete(i.id),c(o.filter(a=>a.id!==i.id)),h.info("Organização removida",{organizationId:i.id,name:i.name}),f()}catch(a){h.error("Error removing organization",{error:a,organizationId:i.id,name:i.name}),d({title:"Erro",message:"Falha ao remover organização. Por favor, tente novamente mais tarde."})}}})},[o,u,S,d,f]),O=t.useCallback(e=>{const i=e._original||o.find(a=>a.id===e.id);i&&(z(i),D(!0))},[o]),R=t.useMemo(()=>[{description:"Gerenciar Ferramentas",icon:n.jsx(X,{}),onClick:O}],[O]);return n.jsxs(Z,{title:"Gerenciador de Organizações",children:[n.jsx(Y,{title:"Organizações",rows:F,columns:I,loading:g,error:m,initialValues:{id:"",name:"",abbreviation:"",holding:null,inactivationDate:null,inclusionDate:null},dialogTitle:"Organização",onSave:C,onDelete:y,onRefresh:f,onValidate:te,hideAddButton:!1,actions:R,children:ae(s)}),v&&n.jsx(ie,{open:j,onClose:()=>{D(!1),z(null)},organizationId:v.id,organizationName:v.name})]})};export{se as default};
