import{j as e,r as i,a as oe,z as T,U as te,G as ne,J as le,M as de,B as F,l as J,n as X,o as Y,A as q,p as R,s as ce,v as K,e as N,V as L,g as v,H as V,w as ue,q as me,b as W,d as H,C as _,P as $,X as fe,Y as ge,Q as he}from"./index-DLja3hGy.js";import{T as B}from"./ToolPageLayout-BXICLrQ5.js";import{f as Q}from"./dateUtils-Lijm-n4x.js";import{M as xe}from"./ManageAccounts-CMaSYY88.js";const pe=[{label:"User",value:"user"},{label:"Supervisor",value:"supervisor"},{label:"Admin",value:"admin"}],ve=()=>{const d=!i.useContext(oe)?.values?.id;return e.jsxs(e.Fragment,{children:[e.jsx(T,{name:"id",label:"ID do Usuário",formField:!0,disabled:!0,required:!1}),e.jsx(T,{name:"name",label:"Nome",formField:!0}),e.jsx(T,{name:"email",label:"Email",formField:!0,disabled:!d,required:d}),e.jsx(te,{name:"role",label:"Role",options:pe,formField:!0,required:!0}),e.jsx(T,{name:"inactivationDate",label:"Data de Inativação",type:"date",formField:!0}),e.jsx(ne,{name:"allowOwnProfile",label:"Permitir Perfil Próprio",formField:!0})]})},De=()=>e.jsx(ve,{}),Pe=r=>{const d={};return r.name||(d.name="O nome é obrigatório"),r.email?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r.email)||(d.email="Email inválido"):d.email="O email é obrigatório",r.role?["user","supervisor","admin"].includes(r.role)||(d.role="Role inválido. Deve ser: user, supervisor ou admin"):d.role="O role é obrigatório",d},be=({open:r,onClose:d,onSave:n})=>{const[l,D]=i.useState(!1),P=async m=>{const c=m.email?.trim();if(c){D(!0);try{await n(c),d()}finally{D(!1)}}},b=m=>{const c={},p=m.email?.trim();return p?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(p)||(c.email="E-mail inválido"):c.email="O e-mail é obrigatório",c};return e.jsx(le,{open:r,onClose:d,title:"Adicionar Usuário Existente",children:e.jsx(de,{initialValues:{email:""},onSubmit:P,onCancel:d,onValidate:b,submitLabel:"Adicionar",disabled:l,skipCancelConfirmation:!0,children:e.jsx(F,{sx:{mt:2},children:e.jsx(T,{name:"email",label:"E-mail",formField:!0,required:!0,type:"email",helperText:"Digite o e-mail do usuário existente para adicioná-lo à organização"})})})})},Ue=({open:r,onClose:d,organizationId:n,userId:l,userName:D})=>{const[P,b]=i.useState([]),[m,c]=i.useState([]),[p,w]=i.useState(!0),[U,j]=i.useState(!1),[O,h]=i.useState(null);i.useEffect(()=>{if(!r||!n||!l)return;(async()=>{w(!0),h(null);try{const u=await L.getProfilesByOrganization(n),A=u.filter(E=>!E.userId||E.userId!==l),S=await L.getUserProfileIds(n,l),k=u.filter(E=>S.includes(E.id));b(A.filter(E=>!S.includes(E.id))),c(k)}catch(u){v.error("Error loading user profiles",{organizationId:n,userId:l,error:u}),h("Erro ao carregar perfis. Tente novamente.")}finally{w(!1)}})()},[r,n,l]);const x=async()=>{j(!0),h(null);try{const s=m.map(u=>u.id);await L.setUserProfiles(n,l,s),v.info("User profiles saved",{organizationId:n,userId:l,profileIds:s}),d()}catch(s){v.error("Error saving user profiles",{organizationId:n,userId:l,error:s}),h("Erro ao salvar perfis. Tente novamente.")}finally{j(!1)}},z=()=>{d()},f=i.useMemo(()=>P.map(s=>({id:s.id,label:s.name,description:s.abbreviation})),[P]),y=i.useMemo(()=>m.map(s=>({id:s.id,label:s.name,description:s.abbreviation})),[m]),C=s=>{const u=s.map(S=>S.id),A=P.concat(m).filter(S=>u.includes(S.id));c(A)};return e.jsxs(J,{open:r,onClose:z,maxWidth:"lg",fullWidth:!0,PaperProps:{sx:{height:"90vh",maxHeight:"90vh"}},children:[e.jsxs(X,{children:["Gerenciar Perfis - ",D]}),e.jsxs(Y,{sx:{display:"flex",flexDirection:"column",minHeight:0,p:2},children:[O&&e.jsx(q,{severity:"error",sx:{mb:2},children:O}),p?e.jsx(F,{sx:{display:"flex",justifyContent:"center",alignItems:"center",flex:1},children:e.jsx(R,{})}):e.jsx(F,{sx:{flex:1,minHeight:0,display:"flex",flexDirection:"column"},children:e.jsx(ce,{availableItems:f,selectedItems:y,onSelectionChange:C,searchPlaceholder:"Buscar perfis...",availableTitle:"Perfis Disponíveis",selectedTitle:"Perfis do Usuário",loading:U,onSave:x,onCancel:z,containerHeight:600})})]}),e.jsxs(K,{sx:{p:2},children:[e.jsx(N,{onClick:z,disabled:U,children:"Cancelar"}),e.jsx(N,{onClick:x,variant:"contained",disabled:U||p,startIcon:U?e.jsx(R,{size:16}):null,children:"Salvar"})]})]})},je=({open:r,onClose:d,organizationId:n,userId:l,userName:D,onSave:P})=>{const[b,m]=i.useState(""),[c,p]=i.useState(""),[w,U]=i.useState(!0),[j,O]=i.useState(!1),[h,x]=i.useState(null),[z,f]=i.useState(null);i.useEffect(()=>{if(!r||!n||!l)return;(async()=>{U(!0),x(null);try{const u=await L.getUserOwnProfile(n,l);u?(f(u),m(u.name),p(u.abbreviation)):(m(`${D} - Perfil Próprio`),p(D.substring(0,3).toUpperCase()))}catch(u){v.error("Error loading user own profile",{organizationId:n,userId:l,error:u}),x("Erro ao carregar perfil. Tente novamente.")}finally{U(!1)}})()},[r,n,l,D]);const y=async()=>{if(!b.trim()||!c.trim()){x("Nome e abreviação são obrigatórios.");return}O(!0),x(null);try{await L.saveUserOwnProfile(n,l,{name:b.trim(),abbreviation:c.trim()}),v.info("User own profile saved",{organizationId:n,userId:l,name:b,abbreviation:c}),P?.(),d()}catch(s){v.error("Error saving user own profile",{organizationId:n,userId:l,error:s}),x("Erro ao salvar perfil. Tente novamente.")}finally{O(!1)}},C=()=>{d()};return e.jsxs(J,{open:r,onClose:C,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(X,{children:[z?"Editar Perfil Próprio":"Criar Perfil Próprio"," - ",D]}),e.jsxs(Y,{children:[h&&e.jsx(q,{severity:"error",sx:{mb:2},children:h}),w?e.jsx(F,{sx:{display:"flex",justifyContent:"center",p:4},children:e.jsx(R,{})}):e.jsxs(F,{sx:{display:"flex",flexDirection:"column",gap:2,pt:2},children:[e.jsx(V,{label:"Nome",value:b,onChange:s=>m(s.target.value),fullWidth:!0,required:!0,disabled:j}),e.jsx(V,{label:"Abreviação",value:c,onChange:s=>p(s.target.value),fullWidth:!0,required:!0,disabled:j,inputProps:{maxLength:10}})]})]}),e.jsxs(K,{children:[e.jsx(N,{onClick:C,disabled:j||w,children:"Cancelar"}),e.jsx(N,{onClick:y,variant:"contained",disabled:j||w||!b.trim()||!c.trim(),startIcon:j?e.jsx(R,{size:16}):null,children:"Salvar"})]})]})},Oe=()=>{const{organizationData:r,isLoading:d}=ue(),[n,l]=i.useState([]),[D,P]=i.useState(!0),[b,m]=i.useState(null),[c,p]=i.useState(!1),[w,U]=i.useState(!1),[j,O]=i.useState(!1),[h,x]=i.useState(null),{showConfirmation:z,showAlert:f}=me(),y=i.useMemo(()=>r?.id?W.getRepository(`organization/${r.id}/users`,H.Firestore,_.NoCache):null,[r?.id]),C=i.useMemo(()=>W.getRepository("user",H.Firestore,_.NoCache),[]),s=i.useCallback(async()=>{if(!r?.id||!y){P(!1);return}P(!0),m(null);try{const a=await y.getAll({}),t=[];for(const o of a)try{const g=await C.getById(o.id);g&&t.push({userData:g,orgUserData:o})}catch{v.warn("User data not found for organization user",{userId:o.id,organizationId:r.id})}t.sort((o,g)=>(o.userData.name||"").localeCompare(g.userData.name||"")),l(t)}catch(a){v.error("Error fetching organization users",{error:a,organizationId:r.id}),m("Falha ao carregar usuários da organização. Por favor, tente novamente mais tarde.")}finally{P(!1)}},[y,C,r?.id]);i.useEffect(()=>{s()},[s]);const u=i.useCallback(async a=>{if(!r?.id){f({title:"Erro",message:"Organização não encontrada."});return}try{const t=await C.getAll({filters:[{field:"email",operator:"==",value:a}]});if(t.length===0){f({title:"Usuário não encontrado",message:`Nenhum usuário encontrado com o e-mail ${a}. Verifique o e-mail e tente novamente.`});return}const o=t[0];if((await y?.getAll({}))?.some(M=>M.id===o.id)){f({title:"Usuário já adicionado",message:`O usuário ${o.email} já está nesta organização.`});return}if(!o.email){f({title:"Erro",message:"O usuário encontrado não possui e-mail válido."});return}await $.saveOrganizationUser({userData:{id:o.id,name:o.name||"",email:o.email,role:"user"},organizationId:r.id},!0),v.info("Usuário adicionado à organização por e-mail",{userId:o.id,email:o.email,organizationId:r.id}),f({title:"Usuário Adicionado",message:`O usuário ${o.email} foi adicionado à organização com sucesso.`}),s()}catch(t){v.error("Error adding user to organization by email",{error:t,email:a,organizationId:r.id});const o=t instanceof Error?t.message:"Falha ao adicionar usuário à organização.";throw f({title:"Erro",message:o}),t}},[r,C,y,f,s]),A=i.useCallback(()=>{p(!0)},[]),S=i.useCallback(a=>{const t=a._original||n.find(o=>o.userData.id===a.id);t&&r&&(x(t),U(!0))},[n,r]),k=i.useCallback(a=>{const t=a._original||n.find(o=>o.userData.id===a.id);t&&r&&(x(t),O(!0))},[n,r]),E=i.useCallback(()=>{U(!1),x(null),s()},[s]),G=i.useCallback(()=>{O(!1),x(null),s()},[s]),Z=i.useMemo(()=>[{icon:e.jsx(xe,{}),description:"Gerenciar Perfis",onClick:S},{icon:e.jsx(fe,{}),description:"Perfil Próprio",onClick:k}],[S,k]),ee=i.useMemo(()=>[{icon:e.jsx(ge,{}),description:"Adicionar Usuário Existente",onClick:A,tooltip:"Adicionar usuário existente a partir do e-mail"}],[A]);if(d)return e.jsx(B,{title:"Gerenciador de Usuários da Organização",children:e.jsx(F,{sx:{display:"flex",justifyContent:"center",p:4},children:"Carregando organização..."})});if(!r)return e.jsx(B,{title:"Gerenciador de Usuários da Organização",children:e.jsx(q,{severity:"warning",children:"Nenhuma organização selecionada. Por favor, selecione uma organização para gerenciar os usuários."})});const re=[{field:"id",headerName:"ID do Usuário",width:200},{field:"name",headerName:"Nome",width:250},{field:"email",headerName:"Email",width:250},{field:"role",headerName:"Role",width:150,valueGetter:a=>a||"user"},{field:"inactivationDate",headerName:"Data de Inativação",width:180,valueGetter:a=>a?Q(a)?.toLocaleDateString("pt-BR"):"-"}],ae=n.map(a=>{const t=a.orgUserData.inactivationDate&&Q(a.orgUserData.inactivationDate)?.toISOString().split("T")[0]||null;return{id:a.userData.id,name:a.userData.name||"",email:a.userData.email||"",role:a.orgUserData.role||"user",inactivationDate:t,allowOwnProfile:a.orgUserData.allowOwnProfile||!1,_original:a}}),ie=async(a,t)=>{if(!r?.id){f({title:"Erro",message:"Organização não encontrada."});return}try{const o=await $.saveOrganizationUser({userData:{id:a.id,name:a.name,email:a.email,role:a.role,inactivationDate:a.inactivationDate,allowOwnProfile:a.allowOwnProfile||!1},organizationId:r.id},t);if(t){const g=o;if(g.userCreated&&g.password){const I=`Email: ${a.email}
Senha: ${g.password}`;f({title:"Usuário Criado",message:`Usuário criado com sucesso!

Email: ${a.email}
Senha: ${g.password}

IMPORTANTE: Anote esta senha, ela não será exibida novamente.`,copyText:I})}s()}else{const g=o;l(I=>I.map(M=>M.userData.id===g.userData.id?g:M)),s()}}catch(o){v.error("Error saving organization user",{error:o,isNew:t,userId:a.id,organizationId:r.id,email:a.email});const g=o instanceof Error?o.message:"Falha ao salvar o usuário da organização.";f({title:"Erro",message:g})}},se=a=>{const t=a._original||n.find(o=>o.userData.id===a.id);!t||!r||z({title:"Confirmar Remoção",message:`Tem certeza que deseja remover o usuário ${t.userData.email} desta organização? Esta ação não pode ser desfeita.`,onConfirm:async()=>{try{await $.removeOrganizationUser(t.userData.id,r.id),l(n.filter(o=>o.userData.id!==t.userData.id))}catch(o){v.error("Error removing user from organization",{error:o,userId:t.userData.id,organizationId:r.id,email:t.userData.email}),f({title:"Erro",message:"Falha ao remover usuário da organização. Por favor, tente novamente mais tarde."})}}})};return e.jsxs(B,{title:`Gerenciador de Usuários - ${r.name}`,children:[e.jsx(he,{title:"Usuários da Organização",rows:ae,columns:re,loading:D,error:b,initialValues:{id:"",name:"",email:"",role:"user",inactivationDate:null,allowOwnProfile:!1},dialogTitle:"Usuário da Organização",onSave:ie,onDelete:se,onRefresh:s,onValidate:Pe,hideAddButton:!1,globalActions:ee,actions:Z,children:De()}),e.jsx(be,{open:c,onClose:()=>p(!1),onSave:u}),h&&r&&e.jsxs(e.Fragment,{children:[e.jsx(Ue,{open:w,onClose:E,organizationId:r.id,userId:h.userData.id,userName:h.userData.name||""}),e.jsx(je,{open:j,onClose:G,organizationId:r.id,userId:h.userData.id,userName:h.userData.name||"",onSave:G})]})]})};export{Oe as default};
