import{j as o,r as n,a as B,z as U,U as M,ap as k,aq as P,B as w,as as V,q as G,b as C,c as A,C as I,f,at as E,au as Q,A as _,Q as H}from"./index-B5W6PHBy.js";import{T as b}from"./ToolPageLayout-DClDsmcM.js";import{f as S}from"./dateUtils-BBQ9qMZq.js";const J=[{label:"User",value:"user"},{label:"Supervisor",value:"supervisor"},{label:"Admin",value:"admin"}],K=()=>{const s=!n.useContext(B)?.values?.id;return o.jsxs(o.Fragment,{children:[o.jsx(U,{name:"id",label:"ID do Usuário",formField:!0,disabled:!0,required:!1}),o.jsx(U,{name:"name",label:"Nome",formField:!0}),o.jsx(U,{name:"email",label:"Email",formField:!0,disabled:!s,required:s}),o.jsx(M,{name:"role",label:"Role",options:J,formField:!0,required:!0}),o.jsx(U,{name:"inactivationDate",label:"Data de Inativação",type:"date",formField:!0})]})},W=()=>o.jsx(K,{}),X=r=>{const s={};return r.name||(s.name="O nome é obrigatório"),r.email?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r.email)||(s.email="Email inválido"):s.email="O email é obrigatório",r.role?["user","supervisor","admin"].includes(r.role)||(s.role="Role inválido. Deve ser: user, supervisor ou admin"):s.role="O role é obrigatório",s},Y=({open:r,onClose:s,onSave:c})=>{const[h,v]=n.useState(!1),p=async g=>{const d=g.email?.trim();if(d){v(!0);try{await c(d),s()}catch(u){throw u}finally{v(!1)}}},O=g=>{const d={},u=g.email?.trim();return u?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(u)||(d.email="E-mail inválido"):d.email="O e-mail é obrigatório",d};return o.jsx(k,{open:r,onClose:s,title:"Adicionar Usuário Existente",children:o.jsx(P,{initialValues:{email:""},onSubmit:p,onCancel:s,onValidate:O,submitLabel:"Adicionar",disabled:h,skipCancelConfirmation:!0,children:o.jsx(w,{sx:{mt:2},children:o.jsx(U,{name:"email",label:"E-mail",formField:!0,required:!0,type:"email",helperText:"Digite o e-mail do usuário existente para adicioná-lo à organização"})})})})},re=()=>{const{organizationData:r,isLoading:s}=V(),[c,h]=n.useState([]),[v,p]=n.useState(!0),[O,g]=n.useState(null),[d,u]=n.useState(!1),{showConfirmation:F,showAlert:l}=G(),z=n.useMemo(()=>r?.id?C.getRepository(`organization/${r.id}/users`,A.Firestore,I.NoCache):null,[r?.id]),D=n.useMemo(()=>C.getRepository("user",A.Firestore,I.NoCache),[]),m=n.useCallback(async()=>{if(!r?.id||!z){p(!1);return}p(!0),g(null);try{const e=await z.getAll({}),i=[];for(const a of e)try{const t=await D.getById(a.id);t&&i.push({userData:t,orgUserData:a})}catch{f.warn("User data not found for organization user",{userId:a.id,organizationId:r.id})}i.sort((a,t)=>(a.userData.name||"").localeCompare(t.userData.name||"")),h(i)}catch(e){f.error("Error fetching organization users",{error:e,organizationId:r.id}),g("Falha ao carregar usuários da organização. Por favor, tente novamente mais tarde.")}finally{p(!1)}},[z,D,r?.id]);n.useEffect(()=>{m()},[m]);const R=n.useCallback(async e=>{if(!r?.id){l({title:"Erro",message:"Organização não encontrada."});return}try{const i=await D.getAll({filters:[{field:"email",operator:"==",value:e}]});if(i.length===0){l({title:"Usuário não encontrado",message:`Nenhum usuário encontrado com o e-mail ${e}. Verifique o e-mail e tente novamente.`});return}const a=i[0];if((await z?.getAll({}))?.some(y=>y.id===a.id)){l({title:"Usuário já adicionado",message:`O usuário ${a.email} já está nesta organização.`});return}if(!a.email){l({title:"Erro",message:"O usuário encontrado não possui e-mail válido."});return}await E.saveOrganizationUser({userData:{id:a.id,name:a.name||"",email:a.email,role:"user"},organizationId:r.id},!0),f.info("Usuário adicionado à organização por e-mail",{userId:a.id,email:a.email,organizationId:r.id}),l({title:"Usuário Adicionado",message:`O usuário ${a.email} foi adicionado à organização com sucesso.`}),m()}catch(i){f.error("Error adding user to organization by email",{error:i,email:e,organizationId:r.id});const a=i instanceof Error?i.message:"Falha ao adicionar usuário à organização.";throw l({title:"Erro",message:a}),i}},[r,D,z,l,m]),j=n.useCallback(()=>{u(!0)},[]),L=n.useMemo(()=>[{icon:o.jsx(Q,{}),description:"Adicionar Usuário Existente",onClick:j,tooltip:"Adicionar usuário existente a partir do e-mail"}],[j]);if(s)return o.jsx(b,{title:"Gerenciador de Usuários da Organização",children:o.jsx(w,{sx:{display:"flex",justifyContent:"center",p:4},children:"Carregando organização..."})});if(!r)return o.jsx(b,{title:"Gerenciador de Usuários da Organização",children:o.jsx(_,{severity:"warning",children:"Nenhuma organização selecionada. Por favor, selecione uma organização para gerenciar os usuários."})});const $=[{field:"id",headerName:"ID do Usuário",width:200},{field:"name",headerName:"Nome",width:250},{field:"email",headerName:"Email",width:250},{field:"role",headerName:"Role",width:150,valueGetter:e=>e||"user"},{field:"inactivationDate",headerName:"Data de Inativação",width:180,valueGetter:e=>e?S(e)?.toLocaleDateString("pt-BR"):"-"}],N=c.map(e=>{const i=e.orgUserData.inactivationDate&&S(e.orgUserData.inactivationDate)?.toISOString().split("T")[0]||null;return{id:e.userData.id,name:e.userData.name||"",email:e.userData.email||"",role:e.orgUserData.role||"user",inactivationDate:i,_original:e}}),T=async(e,i)=>{if(!r?.id){l({title:"Erro",message:"Organização não encontrada."});return}try{const a=await E.saveOrganizationUser({userData:{id:e.id,name:e.name,email:e.email,role:e.role,inactivationDate:e.inactivationDate},organizationId:r.id},i);if(i){const t=a;if(t.userCreated&&t.password){const x=`Email: ${e.email}
Senha: ${t.password}`;l({title:"Usuário Criado",message:`Usuário criado com sucesso!

Email: ${e.email}
Senha: ${t.password}

IMPORTANTE: Anote esta senha, ela não será exibida novamente.`,copyText:x})}m()}else{const t=a;h(x=>x.map(y=>y.userData.id===t.userData.id?t:y)),m()}}catch(a){f.error("Error saving organization user",{error:a,isNew:i,userId:e.id,organizationId:r.id,email:e.email});const t=a instanceof Error?a.message:"Falha ao salvar o usuário da organização.";l({title:"Erro",message:t})}},q=e=>{const i=e._original||c.find(a=>a.userData.id===e.id);!i||!r||F({title:"Confirmar Remoção",message:`Tem certeza que deseja remover o usuário ${i.userData.email} desta organização? Esta ação não pode ser desfeita.`,onConfirm:async()=>{try{await E.removeOrganizationUser(i.userData.id,r.id),h(c.filter(a=>a.userData.id!==i.userData.id))}catch(a){f.error("Error removing user from organization",{error:a,userId:i.userData.id,organizationId:r.id,email:i.userData.email}),l({title:"Erro",message:"Falha ao remover usuário da organização. Por favor, tente novamente mais tarde."})}}})};return o.jsxs(b,{title:`Gerenciador de Usuários - ${r.name}`,children:[o.jsx(H,{title:"Usuários da Organização",rows:N,columns:$,loading:v,error:O,initialValues:{id:"",name:"",email:"",role:"user",inactivationDate:null},dialogTitle:"Usuário da Organização",onSave:T,onDelete:q,onRefresh:m,onValidate:X,hideAddButton:!1,globalActions:L,children:W()}),o.jsx(Y,{open:d,onClose:()=>u(!1),onSave:R})]})};export{re as default};
