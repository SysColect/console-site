import{j as o,r as n,b as k,z as U,U as B,l as M,p as P,B as w,k as V,q as G,c as C,d as A,C as I,n as Q,g as h,o as E,P as _,A as H,Q as J}from"./index-bI3XmyBS.js";import{T as D}from"./ToolPageLayout-DgX-VRl9.js";import{f as S}from"./dateUtils-D90gJyXt.js";const K=[{label:"User",value:"user"},{label:"Supervisor",value:"supervisor"},{label:"Admin",value:"admin"}],W=()=>{const s=!n.useContext(k)?.values?.id;return o.jsxs(o.Fragment,{children:[o.jsx(U,{name:"id",label:"ID do Usuário",formField:!0,disabled:!0,required:!1}),o.jsx(U,{name:"name",label:"Nome",formField:!0}),o.jsx(U,{name:"email",label:"Email",formField:!0,disabled:!s,required:s}),o.jsx(B,{name:"role",label:"Role",options:K,formField:!0,required:!0}),o.jsx(U,{name:"inactivationDate",label:"Data de Inativação",type:"date",formField:!0})]})},X=()=>o.jsx(W,{}),Y=i=>{const s={};return i.name||(s.name="O nome é obrigatório"),i.email?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i.email)||(s.email="Email inválido"):s.email="O email é obrigatório",i.role?["user","supervisor","admin"].includes(i.role)||(s.role="Role inválido. Deve ser: user, supervisor ou admin"):s.role="O role é obrigatório",s},Z=({open:i,onClose:s,onSave:c})=>{const[p,x]=n.useState(!1),z=async g=>{const d=g.email?.trim();if(d){x(!0);try{await c(d),s()}catch(m){throw m}finally{x(!1)}}},O=g=>{const d={},m=g.email?.trim();return m?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(m)||(d.email="E-mail inválido"):d.email="O e-mail é obrigatório",d};return o.jsx(M,{open:i,onClose:s,title:"Adicionar Usuário Existente",children:o.jsx(P,{initialValues:{email:""},onSubmit:z,onCancel:s,onValidate:O,submitLabel:"Adicionar",disabled:p,skipCancelConfirmation:!0,children:o.jsx(w,{sx:{mt:2},children:o.jsx(U,{name:"email",label:"E-mail",formField:!0,required:!0,type:"email",helperText:"Digite o e-mail do usuário existente para adicioná-lo à organização"})})})})},re=()=>{const{organizationData:i,isLoading:s}=V(),[c,p]=n.useState([]),[x,z]=n.useState(!0),[O,g]=n.useState(null),[d,m]=n.useState(!1),{showConfirmation:F,showAlert:l}=G(),v=n.useMemo(()=>i?.id?C.getRepository(`organization/${i.id}/users`,A.Firestore,I.NoCache):null,[i?.id]),y=n.useMemo(()=>C.getRepository("user",A.Firestore,I.NoCache),[]),u=n.useCallback(async()=>{if(!i?.id||!v){z(!1);return}z(!0),g(null);try{const e=await v.getAll({}),r=[];for(const a of e)try{const t=await y.getById(a.id);if(t){const f=Q(t,a);r.push(f)}}catch{h.warn("User data not found for organization user",{userId:a.id,organizationId:i.id})}r.sort((a,t)=>(a.name||"").localeCompare(t.name||"")),p(r)}catch(e){h.error("Error fetching organization users",{error:e,organizationId:i.id}),g("Falha ao carregar usuários da organização. Por favor, tente novamente mais tarde.")}finally{z(!1)}},[v,y,i?.id]);n.useEffect(()=>{u()},[u]);const R=n.useCallback(async e=>{if(!i?.id){l({title:"Erro",message:"Organização não encontrada."});return}try{const r=await y.getAll({filters:[{field:"email",operator:"==",value:e}]});if(r.length===0){l({title:"Usuário não encontrado",message:`Nenhum usuário encontrado com o e-mail ${e}. Verifique o e-mail e tente novamente.`});return}const a=r[0];if((await v?.getAll({}))?.some(b=>b.id===a.id)){l({title:"Usuário já adicionado",message:`O usuário ${a.email} já está nesta organização.`});return}if(!a.email){l({title:"Erro",message:"O usuário encontrado não possui e-mail válido."});return}await E.saveOrganizationUser({userData:{id:a.id,name:a.name||"",email:a.email,role:"user"},organizationId:i.id},!0),h.info("Usuário adicionado à organização por e-mail",{userId:a.id,email:a.email,organizationId:i.id}),l({title:"Usuário Adicionado",message:`O usuário ${a.email} foi adicionado à organização com sucesso.`}),u()}catch(r){h.error("Error adding user to organization by email",{error:r,email:e,organizationId:i.id});const a=r instanceof Error?r.message:"Falha ao adicionar usuário à organização.";throw l({title:"Erro",message:a}),r}},[i,y,v,l,u]),j=n.useCallback(()=>{m(!0)},[]),$=n.useMemo(()=>[{icon:o.jsx(_,{}),description:"Adicionar Usuário Existente",onClick:j,tooltip:"Adicionar usuário existente a partir do e-mail"}],[j]);if(s)return o.jsx(D,{title:"Gerenciador de Usuários da Organização",children:o.jsx(w,{sx:{display:"flex",justifyContent:"center",p:4},children:"Carregando organização..."})});if(!i)return o.jsx(D,{title:"Gerenciador de Usuários da Organização",children:o.jsx(H,{severity:"warning",children:"Nenhuma organização selecionada. Por favor, selecione uma organização para gerenciar os usuários."})});const L=[{field:"id",headerName:"ID do Usuário",width:200},{field:"name",headerName:"Nome",width:250},{field:"email",headerName:"Email",width:250},{field:"role",headerName:"Role",width:150,valueGetter:e=>e||"user"},{field:"inactivationDate",headerName:"Data de Inativação",width:180,valueGetter:e=>e?S(e)?.toLocaleDateString("pt-BR"):"-"}],N=c.map(e=>{const r=e.inactivationDate&&S(e.inactivationDate)?.toISOString().split("T")[0]||null;return{id:e.id,name:e.name||"",email:e.email||"",role:e.role||"user",inactivationDate:r,_original:e}}),T=async(e,r)=>{if(!i?.id){l({title:"Erro",message:"Organização não encontrada."});return}try{const a=await E.saveOrganizationUser({userData:{id:e.id,name:e.name,email:e.email,role:e.role,inactivationDate:e.inactivationDate},organizationId:i.id},r);if(r){const t=a;if(t.userCreated&&t.password){const f=`Email: ${e.email}
Senha: ${t.password}`;l({title:"Usuário Criado",message:`Usuário criado com sucesso!

Email: ${e.email}
Senha: ${t.password}

IMPORTANTE: Anote esta senha, ela não será exibida novamente.`,copyText:f})}u()}else{const t=a;p(f=>f.map(b=>b.id===t.id?t:b)),u()}}catch(a){h.error("Error saving organization user",{error:a,isNew:r,userId:e.id,organizationId:i.id,email:e.email});const t=a instanceof Error?a.message:"Falha ao salvar o usuário da organização.";l({title:"Erro",message:t})}},q=e=>{const r=e._original||c.find(a=>a.id===e.id);!r||!i||F({title:"Confirmar Remoção",message:`Tem certeza que deseja remover o usuário ${r.email} desta organização? Esta ação não pode ser desfeita.`,onConfirm:async()=>{try{await E.removeOrganizationUser(r.id,i.id),p(c.filter(a=>a.id!==r.id))}catch(a){h.error("Error removing user from organization",{error:a,userId:r.id,organizationId:i.id,email:r.email}),l({title:"Erro",message:"Falha ao remover usuário da organização. Por favor, tente novamente mais tarde."})}}})};return o.jsxs(D,{title:`Gerenciador de Usuários - ${i.name}`,children:[o.jsx(J,{title:"Usuários da Organização",rows:N,columns:L,loading:x,error:O,initialValues:{id:"",name:"",email:"",role:"user",inactivationDate:null},dialogTitle:"Usuário da Organização",onSave:T,onDelete:q,onRefresh:u,onValidate:Y,hideAddButton:!1,globalActions:$,children:X()}),o.jsx(Z,{open:d,onClose:()=>m(!1),onSave:R})]})};export{re as default};
