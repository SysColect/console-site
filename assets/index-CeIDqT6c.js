import{j as r,e as l,f as j,L as u,l as R,g as N,D as L,C as A,r as m,q as M,T as S,n as $,o as O}from"./index-Cw1vh47c.js";import{T as P}from"./ToolPageLayout-B48a5b2y.js";import{f as h}from"./dateUtils-D2aqTT2t.js";const q=()=>{const o=!l.useContext(j)?.values?.id;return r.jsxs(r.Fragment,{children:[r.jsx(u,{name:"id",label:"ID do Usuário",formField:!0,disabled:!0}),r.jsx(u,{name:"name",label:"Nome",formField:!0}),r.jsx(u,{name:"email",label:"Email",formField:!0,disabled:!o,required:o}),r.jsx(u,{name:"inclusionDate",label:"Data de Inclusão",type:"date",formField:!0,disabled:!0}),r.jsx(u,{name:"inactivationDate",label:"Data de Inativação",type:"date",formField:!0})]})},B=()=>r.jsx(q,{}),G=n=>{const o={};return n.name||(o.name="O nome é obrigatório"),n.email?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n.email)||(o.email="Email inválido"):o.email="O email é obrigatório",o},V=()=>Math.floor(1e7+Math.random()*9e7).toString(),H=()=>{const[n,o]=l.useState([]),[D,v]=l.useState(!0),[E,x]=l.useState(null),{showConfirmation:U,showAlert:f}=R(),c=l.useMemo(()=>N.getRepository("user",L.Firestore,A.NoCache),[]),g=l.useCallback(async()=>{v(!0),x(null);try{const a=await c.getAll({sort:{field:"name",direction:"asc"}});o(a)}catch(a){m.error("Error fetching users",{error:a}),x("Falha ao carregar usuários. Por favor, tente novamente mais tarde.")}finally{v(!1)}},[c]);l.useEffect(()=>{g()},[g]);const y=[{field:"id",headerName:"ID do Usuário",width:200},{field:"name",headerName:"Nome",width:250},{field:"email",headerName:"Email",width:250},{field:"inclusionDate",headerName:"Data de Inclusão",width:180,valueGetter:a=>h(a)?.toLocaleDateString("pt-BR")||"-"},{field:"inactivationDate",headerName:"Data de Inativação",width:180,valueGetter:a=>a?h(a)?.toLocaleDateString("pt-BR"):"-"}],w=n.map(a=>{const t=a.inclusionDate&&h(a.inclusionDate)?.toISOString().split("T")[0]||null,e=a.inactivationDate&&h(a.inactivationDate)?.toISOString().split("T")[0]||null;return{id:a.id,name:a.name||"",email:a.email||"",inclusionDate:t,inactivationDate:e,_original:a}}),I=async(a,t)=>{const e={...a},s=e.id;if(delete e.id,e.inactivationDate){const i=new Date(e.inactivationDate);isNaN(i.getTime())?e.inactivationDate=null:e.inactivationDate=S.fromDate(i)}else e.inactivationDate=null;try{if(t){const i=V(),p=(await $.getAuthService(void 0,O).createUser(e.email,i)).user.uid;e.inclusionDate=S.now();const T=await c.create({...e,id:p});o(C=>[...C,T]),m.info("Usuário criado",{userId:p,email:e.email,name:e.name});const b=`Email: ${e.email}
Senha: ${i}`;f({title:"Usuário Criado",message:`Usuário criado com sucesso!

Email: ${e.email}
Senha: ${i}

IMPORTANTE: Anote esta senha, ela não será exibida novamente.`,copyText:b})}else{if(!s){f({title:"Erro",message:"ID do usuário não encontrado."});return}delete e.inclusionDate,await c.update(s,e),o(i=>i.map(d=>d.id===s?{...d,...e,id:s}:d)),m.info("Usuário alterado",{userId:s,email:e.email||n.find(i=>i.id===s)?.email,name:e.name,changes:e}),g()}}catch(i){m.error("Error saving user",{error:i,isNew:t,userId:t?void 0:s,email:e.email});const d=i instanceof Error?i.message:"Falha ao salvar o usuário.";f({title:"Erro",message:d})}},F=a=>{const t=a._original||n.find(e=>e.id===a.id);t&&U({title:"Confirmar Exclusão",message:`Tem certeza que deseja excluir o usuário ${t.email}? Esta ação não pode ser desfeita.`,onConfirm:async()=>{try{await c.delete(t.id),o(n.filter(e=>e.id!==t.id)),m.info("Usuário excluído",{userId:t.id,email:t.email,name:t.name})}catch(e){m.error("Error deleting user",{error:e,userId:t.id,email:t.email}),f({title:"Erro",message:"Falha ao excluir usuário. Por favor, tente novamente mais tarde."})}}})};return r.jsx(P,{title:"Gerenciador de Usuários",children:r.jsx(M,{title:"Usuários",rows:w,columns:y,loading:D,error:E,initialValues:{id:"",name:"",email:"",inclusionDate:null,inactivationDate:null},dialogTitle:"Usuário",onSave:I,onDelete:F,onRefresh:g,onValidate:G,hideAddButton:!1,children:B()})})};export{H as default};
