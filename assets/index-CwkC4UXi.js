import{c as W,j as t,d as re,C as se,r as c,a3 as J,a4 as B,W as N,a as ne,H as v,q as $,D as w,ad as ie,g as ce,h as D,f as L,ae as le,af as de,ag as b,a0 as T,ah as ue,e as M,Z as he,ai as me}from"./index-CpxBzFV8.js";import{T as pe}from"./ToolPageLayout-BQ_XzRme.js";import{S as z}from"./Stack-BSaZAOx9.js";const ge=W(t.jsx("path",{d:"M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"})),fe=W(t.jsx("path",{d:"M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm-1 4 6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2zm-1 7h5.5L14 6.5z"})),xe=W(t.jsx("path",{d:"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5"})),ye=a=>{if(!a.collectionPath)throw new Error("Informe o caminho da coleção.")},C=a=>(ye(a),re.getRepository(a.collectionPath,a.dataSource,se.NoCache)),j=a=>{const{id:s,...r}=a;return{id:s,data:r}},k=a=>JSON.parse(JSON.stringify(a??{})),De=async a=>(await C(a).getAll()).map(j),be=async(a,s,r)=>{const m=C(a),l=k(s.data);if(r||!s.id){const y=await m.create(s.id?{id:s.id,...l}:l);return j(y)}const d=await m.update(s.id,l);return j(d)},Ce=async(a,s)=>{if(!s)throw new Error("O ID do documento é obrigatório para exclusão.");await C(a).delete(s)},je=async(a,s,r)=>{const m=C(a),l=k(s.data),d=await m.create(r?{id:r,...l}:l);return j(d)},Se=a=>(a??[]).map(s=>s.trim()).filter(s=>!!s),Pe=async({source:a,target:s,documentIds:r,overwriteExisting:m=!1,preserveIds:l=!0})=>{const d=C(a),y=C(s),x=Se(r),i=[],u=[];if(x.length>0)for(const h of x)try{const p=await d.getById(h);p&&u.push(j(p))}catch(p){i.push({id:h,message:p instanceof Error?p.message:"Documento não encontrado na origem."})}else{const h=await d.getAll();u.push(...h.map(j))}const f={copied:0,skipped:0,totalSource:x.length>0?x.length:u.length,errors:i};for(const h of u){if(l&&!m)try{if(await y.getById(h.id)){f.skipped+=1;continue}}catch{}try{const p=l?{id:h.id,...k(h.data)}:k(h.data);await y.create(p),f.copied+=1}catch(p){f.errors.push({id:h.id,message:p instanceof Error?p.message:"Erro ao copiar documento."})}}return f},q=({open:a,originalId:s,onClose:r,onConfirm:m})=>{const l=c.useMemo(()=>({generateId:!s,targetId:s?`${s}-copy`:""}),[s]),d=i=>{m({generateId:i.generateId,targetId:i.generateId?void 0:i.targetId?.trim()})},y=i=>{const u={};return!i.generateId&&!i.targetId&&(u.targetId="Informe o novo ID ou habilite a geração automática."),u},x=()=>{const u=c.useContext(ne)?.values.generateId;return t.jsx(v,{name:"targetId",label:"Novo ID",placeholder:"ex: documento-clone",disabled:u,helperText:"Quando vazio, o Firestore irá gerar automaticamente.",formField:!0})};return t.jsx(J,{open:a,onClose:r,title:"Duplicar Registro",children:t.jsxs(B,{initialValues:l,onSubmit:i=>d(i),onValidate:i=>y(i),onCancel:r,submitLabel:"Duplicar",children:[t.jsx(N,{name:"generateId",label:"Gerar ID automaticamente",formField:!0}),t.jsx(x,{})]},s??"duplicate-new")})};q.displayName="DuplicateRecordDialog";const H=[{label:"Firestore",value:w.Firestore}],A=({open:a,defaultSource:s,onClose:r,onSubmit:m,loading:l=!1})=>{const d=c.useMemo(()=>({sourcePath:s.collectionPath,sourceDataSource:s.dataSource,targetPath:"",targetDataSource:s.dataSource,documentIds:"",overwriteExisting:!1,preserveIds:!0}),[s]),y=i=>{const u={};return i.sourcePath||(u.sourcePath="Informe a coleção de origem."),i.targetPath||(u.targetPath="Informe a coleção de destino."),u},x=i=>{m(i)};return t.jsx(J,{open:a,onClose:r,title:"Copiar Registros",children:t.jsxs(B,{initialValues:d,onSubmit:i=>x(i),onValidate:i=>y(i),onCancel:r,disabled:l,submitLabel:"Copiar",children:[t.jsx($,{name:"sourceDataSource",label:"Data Source de Origem",options:H,formField:!0}),t.jsx(v,{name:"sourcePath",label:"Coleção de Origem",placeholder:"ex: tenants/{tenantId}/orders",formField:!0}),t.jsx($,{name:"targetDataSource",label:"Data Source de Destino",options:H,formField:!0}),t.jsx(v,{name:"targetPath",label:"Coleção de Destino",placeholder:"ex: sandbox/orders_backup",formField:!0}),t.jsx(ie,{name:"documentIds",label:"IDs específicos (opcional)",placeholder:"Informe um ID por linha ou separado por vírgula",minRows:4,formField:!0}),t.jsx(N,{name:"preserveIds",label:"Preservar IDs originais",formField:!0}),t.jsx(N,{name:"overwriteExisting",label:"Sobrescrever registros existentes",formField:!0})]},`${s.collectionPath}-${s.dataSource}`)})};A.displayName="CopyRecordsDialog";const Ie=a=>JSON.stringify(a??{},null,2),ve=a=>{const s=JSON.stringify(a??{});return s.length<=140?s:`${s.slice(0,140)}…`},we={[w.Firestore]:"Firestore"},ke={id:"",jsonPayload:`{
}`},We=()=>{const{showAlert:a,showConfirmation:s}=ce(),[r,m]=c.useState({collectionPath:"",dataSource:w.Firestore}),[l,d]=c.useState([]),[y,x]=c.useState(!1),[i,u]=c.useState(null),[f,h]=c.useState({open:!1,record:null}),[p,F]=c.useState(!1),[_,O]=c.useState(!1),R=o=>e=>{const n=e.target.value;m(g=>({...g,[o]:o==="dataSource"?Number(n):n}))},P=c.useCallback(async()=>{if(!r.collectionPath){a({title:"Configuração incompleta",message:"Informe o caminho da coleção que deseja consultar."});return}x(!0),u(null);try{const o=await De(r);d(o),D.info("DataWorkbench carregou documentos",{collectionPath:r.collectionPath,count:o.length})}catch(o){D.error("DataWorkbench falhou ao carregar documentos",{collectionPath:r.collectionPath,error:o}),u("Falha ao carregar documentos. Verifique o caminho e tente novamente.")}finally{x(!1)}},[r,a]),G=c.useMemo(()=>l.map(e=>{const n=Ie(e.data),g=new TextEncoder().encode(n).length;return{id:e.id,preview:ve(e.data),keyCount:Object.keys(e.data??{}).length,size:g,_original:{id:e.id,jsonPayload:n,dataObject:e}}}),[l]),Z=c.useMemo(()=>[{field:"id",headerName:"ID",width:260},{field:"keyCount",headerName:"Campos",width:110},{field:"size",headerName:"Bytes",width:110},{field:"preview",headerName:"Prévia",flex:1}],[]),K=c.useCallback(o=>{const e={};if(!o.jsonPayload||!o.jsonPayload.trim())e.jsonPayload="Conteúdo JSON é obrigatório.";else try{JSON.parse(o.jsonPayload)}catch{e.jsonPayload="JSON inválido. Verifique a sintaxe."}return e},[]),Q=c.useCallback(async(o,e)=>{if(!r.collectionPath){a({title:"Configuração incompleta",message:"Defina uma coleção antes de salvar registros."});return}try{const n=JSON.parse(o.jsonPayload??"{}"),g={id:o.id?.trim()??"",data:n},S=await be(r,g,e);d(E=>E.some(I=>I.id===S.id)?E.map(I=>I.id===S.id?S:I):[...E,S]),D.info("DataWorkbench registro persistido",{collectionPath:r.collectionPath,isNew:e,documentId:S.id})}catch(n){const g=n instanceof Error?n.message:"Falha ao salvar registro.";D.error("DataWorkbench falhou ao persistir registro",{collectionPath:r.collectionPath,error:n}),a({title:"Erro ao salvar",message:g})}},[r,a]),U=c.useCallback(o=>{const e=o.id;s({title:"Remover registro",message:`Deseja remover o registro "${e}"? Esta ação não pode ser desfeita.`,onConfirm:async()=>{try{await Ce(r,e),d(n=>n.filter(g=>g.id!==e)),D.info("DataWorkbench removeu registro",{collectionPath:r.collectionPath,documentId:e})}catch(n){D.error("DataWorkbench falhou ao remover registro",{collectionPath:r.collectionPath,documentId:e,error:n}),a({title:"Erro ao remover",message:n instanceof Error?n.message:"Não foi possível remover o registro."})}}})},[r,a,s]),V=c.useCallback(o=>{m(e=>{const n=e.collectionPath.trim().replace(/\/$/,""),g=n?`${n}/${o}`:o;return{...e,collectionPath:g}})},[]),X=c.useMemo(()=>[{description:"Duplicar registro",icon:t.jsx(fe,{fontSize:"small"}),onClick:o=>{const e=o._original?.dataObject;e&&h({open:!0,record:e})}},{description:"Encadear ID no caminho",icon:t.jsx(xe,{fontSize:"small"}),onClick:o=>{o?.id&&V(o.id)}}],[V]),Y=c.useMemo(()=>[{description:"Copiar registros entre coleções",icon:t.jsx(ge,{fontSize:"small"}),onClick:()=>F(!0),tooltip:"Copiar registros avançado"}],[]),ee=c.useCallback(async({generateId:o,targetId:e})=>{if(f.record)try{const n=await je(r,f.record,o?void 0:e);d(g=>[...g,n]),D.info("DataWorkbench duplicou registro",{collectionPath:r.collectionPath,originalId:f.record.id,newId:n.id}),h({open:!1,record:null})}catch(n){D.error("DataWorkbench falhou ao duplicar registro",{collectionPath:r.collectionPath,originalId:f.record.id,error:n}),a({title:"Erro ao duplicar",message:n instanceof Error?n.message:"Não foi possível duplicar o registro."})}},[r,f,a]),te=o=>o.split(/\r?\n|,/).map(e=>e.trim()).filter(e=>!!e),oe=c.useCallback(async o=>{O(!0);try{const e=await Pe({source:{collectionPath:o.sourcePath.trim(),dataSource:o.sourceDataSource},target:{collectionPath:o.targetPath.trim(),dataSource:o.targetDataSource},documentIds:te(o.documentIds),overwriteExisting:o.overwriteExisting,preserveIds:o.preserveIds});a({title:"Cópia concluída",message:`Copiados: ${e.copied}
Ignorados: ${e.skipped}
Total solicitado: ${e.totalSource}
Erros: ${e.errors.length}`}),D.info("DataWorkbench copiou registros entre coleções",{source:o.sourcePath,target:o.targetPath,copied:e.copied,skipped:e.skipped}),F(!1),o.sourcePath.trim()===r.collectionPath&&o.sourceDataSource===r.dataSource&&P()}catch(e){D.error("DataWorkbench falhou ao copiar registros",{error:e,source:o.sourcePath,target:o.targetPath}),a({title:"Erro ao copiar registros",message:e instanceof Error?e.message:"Falha ao copiar registros."})}finally{O(!1)}},[r,P,a]),ae=t.jsxs(z,{direction:"row",spacing:1,children:[t.jsx(L,{size:"small",label:`Data source: ${we[r.dataSource]}`,color:"primary",variant:"outlined"}),t.jsx(L,{size:"small",label:`Registros: ${l.length}`,variant:"outlined"})]});return t.jsxs(pe,{title:"Workbench de Dados",children:[t.jsx(le,{variant:"outlined",sx:{mb:3},children:t.jsx(de,{children:t.jsxs(z,{spacing:2,children:[t.jsxs(b,{container:!0,spacing:2,alignItems:"flex-end",children:[t.jsx(b,{size:{xs:12,md:3,lg:2},children:t.jsx(T,{select:!0,label:"Data Source",value:r.dataSource,onChange:R("dataSource"),fullWidth:!0,children:t.jsx(ue,{value:w.Firestore,children:"Firestore"})})}),t.jsx(b,{size:{xs:12,md:9,lg:7},children:t.jsx(T,{label:"Caminho da coleção",placeholder:"ex: tenants/{tenantId}/entities",value:r.collectionPath,onChange:R("collectionPath"),fullWidth:!0,helperText:"Utilize “/” para navegar entre documentos e subcoleções."})})]}),t.jsxs(b,{container:!0,spacing:2,alignItems:"center",children:[t.jsx(b,{size:{xs:12,md:7},children:ae}),t.jsx(b,{size:{xs:12,md:5},children:t.jsxs(z,{direction:{xs:"column",sm:"row"},spacing:1,justifyContent:"flex-end",children:[t.jsx(M,{variant:"contained",onClick:P,fullWidth:!0,children:"Carregar"}),t.jsx(M,{variant:"outlined",onClick:()=>d([]),color:"inherit",fullWidth:!0,children:"Limpar"})]})})]})]})})}),t.jsxs(he,{title:"Registros",rows:G,columns:Z,loading:y,error:i,initialValues:ke,dialogTitle:"Registro",onSave:Q,onDelete:U,onRefresh:P,onValidate:K,globalActions:Y,actions:X,children:[t.jsx(v,{name:"id",label:"ID",placeholder:"Deixe vazio para gerar automaticamente",formField:!0}),t.jsx(me,{name:"jsonPayload",label:"Documento (JSON)",formField:!0})]}),t.jsx(q,{open:f.open,originalId:f.record?.id,onClose:()=>h({open:!1,record:null}),onConfirm:ee}),t.jsx(A,{open:p,defaultSource:r,onClose:()=>F(!1),onSubmit:oe,loading:_})]})};export{We as default};
