import{j as o,m as F,z as P,D as R,U as E,G as q,r as i,b as I,c as M,d as D,C as L,B as w,e as N,f as O,u as A,F as B,t as V,q as z,g as T,L as G,Q as k}from"./index-bI3XmyBS.js";import{T as U}from"./ToolPageLayout-DgX-VRl9.js";const Q=()=>i.useContext(I)?.values?.action!=="redirect"?null:o.jsx(P,{name:"actionProperties.redirectTo",label:"Caminho do Redirecionamento",placeholder:"some-path",formField:!0}),_=()=>i.useContext(I)?.values?.billingType==="free"?null:o.jsx(V,{name:"value",label:"Valor",formField:!0,decimals:2}),$=()=>{const r=i.useContext(I),{values:t,setFieldValue:a}=r||{},[h,f]=i.useState(!1),[b,x]=i.useState([]),[d,m]=i.useState([]),[u,y]=i.useState(!1),C=i.useMemo(()=>M.getRepository("consoleTool",D.Firestore,L.NoCache),[]);i.useEffect(()=>{y(!0),C.getAll().then(n=>{const c=n.filter(g=>g.action!=="group"&&g.id!==t?.id);m(c),y(!1)})},[C,t?.id]);const j=()=>{x(d),f(!0)},v=n=>{const c=t?.actionProperties?.tools||[];c.includes(n.id)||a?.("actionProperties.tools",[...c,n.id]),f(!1)},e=n=>{const c=t?.actionProperties?.tools||[];a?.("actionProperties.tools",c.filter(g=>g!==n))},l=n=>{if(!n){x(d);return}const c=n.toLowerCase();x(d.filter(g=>g.name.toLowerCase().includes(c)||g.description.toLowerCase().includes(c)))};if(t?.action!=="group")return null;const p=(t?.actionProperties?.tools||[]).map(n=>d.find(c=>c.id===n)||{id:n,name:n}).filter(n=>n.name),S=r?.errors?.["actionProperties.tools"];return o.jsxs(w,{sx:{my:2},children:[o.jsxs(w,{sx:{p:2,border:"1px dashed",borderColor:S?"error.main":"grey",borderRadius:1},children:[o.jsx(N,{variant:"outlined",onClick:j,disabled:u,children:u?"Carregando...":"Adicionar Ferramenta ao Grupo"}),o.jsx(w,{sx:{display:"flex",flexWrap:"wrap",gap:1,mt:2},children:p.map(n=>o.jsx(O,{label:n.name,onDelete:()=>e(n.id)},n.id))}),o.jsx(A,{open:h,loading:u,onClose:()=>f(!1),onSelect:v,headerText:"Selecionar Ferramenta",searchLabel:"Buscar por nome ou descrição",items:b,itemKey:"id",displayFields:{primary:"name",secondary:"description"},onSearchChange:l})]}),S&&o.jsx(B,{error:!0,sx:{mt:.5,mx:1.75},children:S})]})},H=()=>o.jsxs(o.Fragment,{children:[o.jsx(P,{name:"name",label:"Nome",formField:!0,required:!0}),o.jsx(P,{name:"description",label:"Descrição",multiline:!0,rows:3,formField:!0}),o.jsx(R,{name:"icon",label:"Ícone",formField:!0}),o.jsx(E,{name:"action",label:"Ação",options:[{value:"redirect",label:"Redirecionar"},{value:"group",label:"Grupo"}],formField:!0}),o.jsx(Q,{}),o.jsx($,{}),o.jsx(q,{name:"allowMultipleInsertions",label:"Permitir múltiplas inserções na organização",formField:!0}),o.jsx(E,{name:"billingType",label:"Tipo de Cobrança",options:[{value:"free",label:"Free"},{value:"monthly",label:"Mensal"},{value:"on-demand",label:"Por Demanda"}],formField:!0}),o.jsx(_,{})]}),K=()=>o.jsx(H,{}),W=r=>{const t={};if(t.name=F.required("O nome da ferramenta é obrigatório")(r.name),t.icon=F.required("Você deve selecionar um ícone")(r.icon),r.action==="redirect"){const a=r.actionProperties?.redirectTo;t["actionProperties.redirectTo"]=F.required("O caminho para o redirecionamento é obrigatório")(a)}if(r.action==="group"){const a=r.actionProperties?.tools;(!a||a.length===0)&&(t["actionProperties.tools"]="Um grupo deve conter pelo menos uma ferramenta.")}if(r.billingType||(t.billingType=F.required("O tipo de cobrança é obrigatório")(r.billingType)),r.billingType==="free")delete t.value;else if(r.billingType&&r.billingType!=="free"){const a=r.value;(!a||a===null||a===void 0||isNaN(a)||a<=0)&&(t.value="O valor deve ser maior que zero quando o tipo de cobrança não é Free.")}return Object.entries(t).reduce((a,[h,f])=>(f&&(a[h]=f),a),{})},Y=()=>{const[r,t]=i.useState([]),[a,h]=i.useState(!0),[f,b]=i.useState(null),{showConfirmation:x,showAlert:d}=z(),m=i.useMemo(()=>M.getRepository("consoleTool",D.Firestore,L.NoCache),[]),u=i.useCallback(async()=>{h(!0),b(null);try{const e=await m.getAll({sort:{field:"name",direction:"asc"}});t(e)}catch(e){T.error("Error fetching tools",{error:e}),b("Falha ao carregar os dados. Por favor, tente novamente mais tarde.")}finally{h(!1)}},[m]);i.useEffect(()=>{u()},[u]);const y=i.useMemo(()=>[{field:"icon",headerName:"Ícone",width:80,renderCell:e=>o.jsx(G,{children:o.jsx("i",{className:`fa-solid fa-${e.value}`,style:{fontSize:20}})})},{field:"name",headerName:"Nome",width:250},{field:"description",headerName:"Descrição",flex:1},{field:"action",headerName:"Ação",width:150}],[]),C=i.useMemo(()=>r.map(e=>({id:e.id,icon:e.icon||"",name:e.name||"",description:e.description||"",action:e.action||"",_original:e})),[r]),j=i.useCallback(async(e,l)=>{try{if(l){const s=await m.create({name:e.name,description:e.description,icon:e.icon,action:e.action,actionProperties:e.actionProperties,allowMultipleInsertions:e.allowMultipleInsertions||!1,billingType:e.billingType||"free",value:e.value??null});t(p=>[...p,s]),T.info("Ferramenta criada",{toolId:s.id,name:e.name,action:e.action})}else{if(!e.id){d({title:"Erro",message:"ID da ferramenta não encontrado."});return}await m.update(e.id,{name:e.name,description:e.description,icon:e.icon,action:e.action,actionProperties:e.actionProperties,allowMultipleInsertions:e.allowMultipleInsertions||!1,billingType:e.billingType||"free",value:e.value??null}),t(s=>s.map(p=>p.id===e.id?{...p,...e}:p)),T.info("Ferramenta alterada",{toolId:e.id,name:e.name,action:e.action})}u()}catch(s){T.error("Error saving tool",{error:s,isNew:l,toolId:e.id,name:e.name});const p=s instanceof Error?s.message:"Falha ao salvar a ferramenta.";d({title:"Erro",message:p})}},[m,d,u]),v=i.useCallback(e=>{const l=e._original||r.find(s=>s.id===e.id);!l||!m||x({title:"Confirmar Remoção",message:`Tem certeza que deseja remover a ferramenta "${l.name}"? Esta ação não pode ser desfeita.`,onConfirm:async()=>{try{await m.delete(l.id),t(r.filter(s=>s.id!==l.id)),T.info("Ferramenta removida",{toolId:l.id,name:l.name})}catch(s){T.error("Error removing tool",{error:s,toolId:l.id,name:l.name}),d({title:"Erro",message:"Falha ao remover ferramenta. Por favor, tente novamente mais tarde."})}}})},[r,m,x,d]);return o.jsx(U,{title:"Gerenciador de Ferramentas",children:o.jsx(k,{title:"Ferramentas",rows:C,columns:y,loading:a,error:f,initialValues:{id:"",name:"",description:"",icon:"",action:"redirect",actionProperties:{redirectTo:""},allowMultipleInsertions:!1,billingType:"free",value:null},dialogTitle:"Ferramenta",onSave:j,onDelete:v,onRefresh:u,onValidate:W,hideAddButton:!1,children:K()})})};export{Y as default};
