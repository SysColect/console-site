import{j as r,d as b,L as P,y as R,_ as D,e as t,f as w,g as I,D as E,C as L,B as v,h as A,i as N,k as q,l as B,r as C,m as O,q as M}from"./index-Cw1vh47c.js";import{T as k}from"./ToolPageLayout-B48a5b2y.js";const V=()=>t.useContext(w)?.values?.action!=="redirect"?null:r.jsx(P,{name:"actionProperties.redirectTo",label:"Caminho do Redirecionamento",placeholder:"some-path",formField:!0}),_=()=>{const i=t.useContext(w),{values:n,setFieldValue:c}=i||{},[g,p]=t.useState(!1),[T,x]=t.useState([]),[d,m]=t.useState([]),[u,y]=t.useState(!1),F=t.useMemo(()=>I.getRepository("consoleTool",E.Firestore,L.NoCache),[]);t.useEffect(()=>{y(!0),F.getAll().then(o=>{const l=o.filter(h=>h.action!=="group"&&h.id!==n?.id);m(l),y(!1)})},[F,n?.id]);const S=()=>{x(d),p(!0)},j=o=>{const l=n?.actionProperties?.tools||[];l.includes(o.id)||c?.("actionProperties.tools",[...l,o.id]),p(!1)},e=o=>{const l=n?.actionProperties?.tools||[];c?.("actionProperties.tools",l.filter(h=>h!==o))},s=o=>{if(!o){x(d);return}const l=o.toLowerCase();x(d.filter(h=>h.name.toLowerCase().includes(l)||h.description.toLowerCase().includes(l)))};if(n?.action!=="group")return null;const f=(n?.actionProperties?.tools||[]).map(o=>d.find(l=>l.id===o)||{id:o,name:o}).filter(o=>o.name);return r.jsxs(v,{sx:{my:2,p:2,border:"1px dashed grey",borderRadius:1},children:[r.jsx(A,{variant:"outlined",onClick:S,disabled:u,children:u?"Carregando...":"Adicionar Ferramenta ao Grupo"}),r.jsx(v,{sx:{display:"flex",flexWrap:"wrap",gap:1,mt:2},children:f.map(o=>r.jsx(N,{label:o.name,onDelete:()=>e(o.id)},o.id))}),r.jsx(q,{open:g,loading:u,onClose:()=>p(!1),onSelect:j,headerText:"Selecionar Ferramenta",searchLabel:"Buscar por nome ou descrição",items:T,itemKey:"id",displayFields:{primary:"name",secondary:"description"},onSearchChange:s})]})},G=()=>r.jsxs(r.Fragment,{children:[r.jsx(P,{name:"name",label:"Nome",formField:!0,required:!0}),r.jsx(P,{name:"description",label:"Descrição",multiline:!0,rows:3,formField:!0}),r.jsx(R,{name:"icon",label:"Ícone",formField:!0}),r.jsx(D,{name:"action",label:"Ação",options:[{value:"redirect",label:"Redirecionar"},{value:"group",label:"Grupo"}],formField:!0}),r.jsx(V,{}),r.jsx(_,{})]}),z=()=>r.jsx(G,{}),$=i=>{const n={};if(n.name=b.required("O nome da ferramenta é obrigatório")(i.name),n.icon=b.required("Você deve selecionar um ícone")(i.icon),i.action==="redirect"){const c=i.actionProperties?.redirectTo;n["actionProperties.redirectTo"]=b.required("O caminho para o redirecionamento é obrigatório")(c)}if(i.action==="group"){const c=i.actionProperties?.tools;(!c||c.length===0)&&(n.actionProperties="Um grupo deve conter pelo menos uma ferramenta.")}return Object.entries(n).reduce((c,[g,p])=>(p&&(c[g]=p),c),{})},W=()=>{const[i,n]=t.useState([]),[c,g]=t.useState(!0),[p,T]=t.useState(null),{showConfirmation:x,showAlert:d}=B(),m=t.useMemo(()=>I.getRepository("consoleTool",E.Firestore,L.NoCache),[]),u=t.useCallback(async()=>{g(!0),T(null);try{const e=await m.getAll({sort:{field:"name",direction:"asc"}});n(e)}catch(e){C.error("Error fetching tools",{error:e}),T("Falha ao carregar os dados. Por favor, tente novamente mais tarde.")}finally{g(!1)}},[m]);t.useEffect(()=>{u()},[u]);const y=t.useMemo(()=>[{field:"icon",headerName:"Ícone",width:80,renderCell:e=>r.jsx(O,{children:r.jsx("i",{className:`fa-solid fa-${e.value}`,style:{fontSize:20}})})},{field:"name",headerName:"Nome",width:250},{field:"description",headerName:"Descrição",flex:1},{field:"action",headerName:"Ação",width:150}],[]),F=t.useMemo(()=>i.map(e=>({id:e.id,icon:e.icon||"",name:e.name||"",description:e.description||"",action:e.action||"",_original:e})),[i]),S=t.useCallback(async(e,s)=>{try{if(s){const a=await m.create({name:e.name,description:e.description,icon:e.icon,action:e.action,actionProperties:e.actionProperties});n(f=>[...f,a]),C.info("Ferramenta criada",{toolId:a.id,name:e.name,action:e.action})}else{if(!e.id){d({title:"Erro",message:"ID da ferramenta não encontrado."});return}await m.update(e.id,{name:e.name,description:e.description,icon:e.icon,action:e.action,actionProperties:e.actionProperties}),n(a=>a.map(f=>f.id===e.id?{...f,...e}:f)),C.info("Ferramenta alterada",{toolId:e.id,name:e.name,action:e.action})}u()}catch(a){C.error("Error saving tool",{error:a,isNew:s,toolId:e.id,name:e.name});const f=a instanceof Error?a.message:"Falha ao salvar a ferramenta.";d({title:"Erro",message:f})}},[m,d,u]),j=t.useCallback(e=>{const s=e._original||i.find(a=>a.id===e.id);!s||!m||x({title:"Confirmar Remoção",message:`Tem certeza que deseja remover a ferramenta "${s.name}"? Esta ação não pode ser desfeita.`,onConfirm:async()=>{try{await m.delete(s.id),n(i.filter(a=>a.id!==s.id)),C.info("Ferramenta removida",{toolId:s.id,name:s.name})}catch(a){C.error("Error removing tool",{error:a,toolId:s.id,name:s.name}),d({title:"Erro",message:"Falha ao remover ferramenta. Por favor, tente novamente mais tarde."})}}})},[i,m,x,d]);return r.jsx(k,{title:"Gerenciador de Ferramentas",children:r.jsx(M,{title:"Ferramentas",rows:F,columns:y,loading:c,error:p,initialValues:{id:"",name:"",description:"",icon:"",action:"redirect",actionProperties:{redirectTo:""}},dialogTitle:"Ferramenta",onSave:S,onDelete:j,onRefresh:u,onValidate:$,hideAddButton:!1,children:z()})})};export{W as default};
