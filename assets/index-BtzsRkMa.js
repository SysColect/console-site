import{c as de,j as e,r as a,o as P,D as N,p as q,s as B,A as R,t as w,v as $,l as O,w as W,x as ue,y as he,z as H,E as ge,G as me,H as fe,I as xe,J as pe,n as G,e as Q,f as Y,L as Z,K as ee,h as se,M as z,O as L,i as je,B as V,P as Se,Q as Ce,S as ye,U as M,V as ve,W as Te,X,Y as J}from"./index-CMTZ79cl.js";import{T as De}from"./ToolPageLayout-b2zAKi_p.js";import{T as Ee,a as be,b as we,c as K,d as U,e as Oe}from"./TableRow-B2HN4bPL.js";const Ue=de(e.jsx("path",{d:"M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2m0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2"})),Ae=({open:u,onClose:h,user:n})=>{const[m,j]=a.useState(""),[S,y]=a.useState(""),[g,t]=a.useState(null),[f,T]=a.useState(null),v=P();a.useEffect(()=>{if(n){const r=n.name||(n.email?n.email.split("@")[0].replace(/[._]/g," ").replace(/\b\w/g,c=>c.toUpperCase()):"");j(r),y(n.email||""),t(n.inactivationDate?n.inactivationDate.toDate():null)}else j(""),y(""),t(null)},[n]);const x=async()=>{if(T(null),!!n)try{const r=W(v,"user",n.id),c=await ue(r),D={name:m,email:S,inactivationDate:g};(!c.exists()||!c.data()?.inclusionDate)&&(D.inclusionDate=new Date),await he(r,D,{merge:!0}),h({...n,...D,inclusionDate:D.inclusionDate?H.fromDate(D.inclusionDate):n.inclusionDate,inactivationDate:g?H.fromDate(g):void 0})}catch(r){r instanceof Error?T(r.message):T("An unexpected error occurred."),console.error("Error updating user:",r)}},p=(r,c)=>{h()};return e.jsxs(N,{open:u,onClose:p,children:[e.jsx(q,{children:n?"Edit User":"Add User"}),e.jsxs(B,{children:[f&&e.jsx(R,{severity:"error",sx:{mb:2},children:f}),e.jsx(w,{autoFocus:!0,margin:"dense",id:"id",label:"User ID",type:"text",fullWidth:!0,disabled:!0,value:n?.id||""}),e.jsx(w,{margin:"dense",id:"name",label:"Name",type:"text",fullWidth:!0,value:m,onChange:r=>j(r.target.value)}),e.jsx(w,{margin:"dense",id:"email",label:"Email Address",type:"email",fullWidth:!0,disabled:!0,value:S}),e.jsx(w,{margin:"dense",id:"inclusionDate",label:"Inclusion Date",type:"text",fullWidth:!0,disabled:!0,value:n?.inclusionDate?n.inclusionDate instanceof Date?n.inclusionDate.toLocaleDateString():new Date(n.inclusionDate.seconds*1e3).toLocaleDateString():new Date().toLocaleDateString()}),e.jsx(w,{margin:"dense",id:"inactivationDate",label:"Inactivation Date",type:"date",fullWidth:!0,value:g?g.toISOString().split("T")[0]:"",onChange:r=>t(new Date(r.target.value)),InputLabelProps:{shrink:!0}})]}),e.jsxs($,{children:[e.jsx(O,{onClick:()=>h(),children:"Cancel"}),e.jsx(O,{onClick:x,children:"Save"})]})]})},ke=({open:u,onClose:h,onUserAdded:n})=>{const[m,j]=a.useState(""),[S,y]=a.useState(""),[g,t]=a.useState(null),f=a.useRef(null);a.useEffect(()=>{u&&setTimeout(()=>{f.current?.focus()},100)},[u]);const T=async()=>{if(t(null),!m||!S){t("Please fill in both email and password.");return}const x=`temp-app-${Date.now()}`,p=ge(me,x),r=fe(p);try{const c=await xe(r,m,S);n(c.user.uid,m),h()}catch(c){c instanceof Error?t(c.message):t("An unexpected error occurred."),console.error("Error creating user:",c)}finally{pe(p)}},v=()=>{j(""),y(""),t(null),h()};return e.jsxs(N,{open:u,onClose:v,children:[e.jsx(q,{children:"Incluir Novo Usuário"}),e.jsxs(B,{children:[g&&e.jsx(R,{severity:"error",sx:{mb:2},children:g}),e.jsx(w,{inputRef:f,autoFocus:!0,margin:"dense",id:"email",label:"Endereço de E-mail",type:"email",fullWidth:!0,variant:"standard",value:m,onChange:x=>j(x.target.value)}),e.jsx(w,{margin:"dense",id:"password",label:"Senha",type:"password",fullWidth:!0,variant:"standard",value:S,onChange:x=>y(x.target.value)})]}),e.jsxs($,{children:[e.jsx(O,{onClick:v,children:"Cancelar"}),e.jsx(O,{onClick:T,children:"Salvar"})]})]})},ze=({open:u,onClose:h,onSave:n,userId:m})=>{const[j,S]=a.useState([]),[y,g]=a.useState(!0),[t,f]=a.useState(null),[T,v]=a.useState(""),[x,p]=a.useState([]),r=P();a.useEffect(()=>{const s=async()=>{try{const l=z(r,"user",m,"consoleTools"),E=(await L(l)).docs.map(C=>C.id);p(E)}catch(l){console.error("Error fetching user tools:",l),f("Failed to load user tools. Please try again later.")}},d=async()=>{g(!0),f(null);try{const l=z(r,"consoleTool"),E=(await L(l)).docs.map(C=>({id:C.id,name:C.data().name,description:C.data().description}));S(E)}catch(l){console.error("Error fetching tools:",l),f("Failed to load tools. Please try again later.")}finally{g(!1)}};u&&(p([]),d(),s())},[u,r,m]);const c=s=>{p(d=>d.includes(s)?d.filter(l=>l!==s):[...d,s])},D=j.filter(s=>s.name.toLowerCase().includes(T.toLowerCase()));return e.jsxs(N,{open:u,onClose:h,fullWidth:!0,maxWidth:"md",children:[e.jsx(q,{children:"Manage User Tools"}),e.jsxs(B,{children:[e.jsx(w,{autoFocus:!0,margin:"dense",id:"search",label:"Search Tools",type:"text",fullWidth:!0,variant:"standard",onChange:s=>v(s.target.value)}),y?e.jsx(G,{}):t?e.jsx(R,{severity:"error",children:t}):e.jsx(Q,{children:D.map(s=>e.jsxs(Y,{onClick:()=>c(s.id),children:[e.jsx(Z,{children:e.jsx(ee,{edge:"start",checked:x.includes(s.id),tabIndex:-1,disableRipple:!0})}),e.jsx(se,{primary:s.name,secondary:s.description})]},s.id))})]}),e.jsxs($,{children:[e.jsx(O,{onClick:h,children:"Cancel"}),e.jsx(O,{onClick:()=>n(x),children:"Save"})]})]})},Le=({open:u,onClose:h,onSave:n,userId:m})=>{const[j,S]=a.useState([]),[y,g]=a.useState(!0),[t,f]=a.useState(null),[T,v]=a.useState(""),[x,p]=a.useState([]),r=P();a.useEffect(()=>{const s=async()=>{try{const l=z(r,"user",m,"organizations"),E=(await L(l)).docs.map(C=>C.id);p(E)}catch(l){console.error("Error fetching user organizations:",l),f("Failed to load user organizations. Please try again later.")}},d=async()=>{g(!0),f(null);try{const l=z(r,"organization"),E=(await L(l)).docs.map(C=>({id:C.id,name:C.data().name,abbreviation:C.data().abbreviation}));S(E)}catch(l){console.error("Error fetching organizations:",l),f("Failed to load organizations. Please try again later.")}finally{g(!1)}};u&&(p([]),d(),s())},[u,r,m]);const c=s=>{p(d=>d.includes(s)?d.filter(l=>l!==s):[...d,s])},D=j.filter(s=>s.name.toLowerCase().includes(T.toLowerCase()));return e.jsxs(N,{open:u,onClose:h,fullWidth:!0,maxWidth:"md",children:[e.jsx(q,{children:"Manage User Organizations"}),e.jsxs(B,{children:[e.jsx(w,{autoFocus:!0,margin:"dense",id:"search",label:"Search Organizations",type:"text",fullWidth:!0,variant:"standard",onChange:s=>v(s.target.value)}),y?e.jsx(G,{}):t?e.jsx(R,{severity:"error",children:t}):e.jsx(Q,{children:D.map(s=>e.jsxs(Y,{onClick:()=>c(s.id),children:[e.jsx(Z,{children:e.jsx(ee,{edge:"start",checked:x.includes(s.id),tabIndex:-1,disableRipple:!0})}),e.jsx(se,{primary:s.name,secondary:s.abbreviation})]},s.id))})]}),e.jsxs($,{children:[e.jsx(O,{onClick:h,children:"Cancel"}),e.jsx(O,{onClick:()=>n(x),children:"Save"})]})]})},Me=()=>{const[u,h]=a.useState([]),[n,m]=a.useState(!0),[j,S]=a.useState(null),[y,g]=a.useState(null),[t,f]=a.useState(null),[T,v]=a.useState(!1),[x,p]=a.useState(!1),[r,c]=a.useState(!1),[D,s]=a.useState(!1),d=P(),{showConfirmation:l,showAlert:A}=je(),E=a.useCallback(async()=>{m(!0),S(null);try{const o=z(d,"user"),b=(await L(o)).docs.map(F=>({id:F.id,...F.data()}));h(b)}catch(o){console.error("Error fetching users:",o),S("Falha ao carregar usuários. Tente novamente mais tarde.")}finally{m(!1)}},[d]);a.useEffect(()=>{E()},[E]);const C=(o,i)=>{g(o.currentTarget),f(i)},I=()=>{g(null)},te=()=>{v(!0),I()},ae=()=>{I(),t&&l({title:"Confirmar Exclusão",message:`Tem certeza que deseja excluir o usuário ${t.email}? Esta ação não pode ser desfeita.`,onConfirm:async()=>{try{if(!t)return;const o=W(d,"user",t.id);await ve(o),await Te.deleteUser(t.id),h(u.filter(i=>i.id!==t.id))}catch(o){console.error("Error deleting user:",o),A({title:"Erro",message:"Falha ao excluir usuário. Tente novamente mais tarde."})}}})},ne=()=>{c(!0),I()},re=()=>{s(!0),I()},oe=()=>{p(!0)},ie=(o,i)=>{const b={id:o,email:i};h([b,...u]),f(b),v(!0)},le=async o=>{if(t)try{const i=X(d),b=z(d,"user",t.id,"consoleTools");(await L(b)).forEach(k=>{i.delete(k.ref)}),o.forEach(k=>{const _=W(b,k);i.set(_,{})}),await i.commit()}catch(i){console.error("Error saving tools:",i),A({title:"Erro",message:"Falha ao salvar ferramentas. Tente novamente mais tarde."})}finally{c(!1)}},ce=async o=>{if(t)try{const i=X(d),b=z(d,"user",t.id,"organizations");(await L(b)).forEach(k=>{i.delete(k.ref)}),o.forEach(k=>{const _=W(b,k);i.set(_,{})}),await i.commit(),J.remove(`user-organizations-${t.id}`),J.remove(`current-organization-${t.id}`)}catch(i){console.error("Error saving organizations:",i),A({title:"Erro",message:"Falha ao salvar organizações. Tente novamente mais tarde."})}finally{s(!1)}};return e.jsx(De,{title:"Gerenciador de Usuários",actions:e.jsx(O,{variant:"contained",color:"secondary",onClick:oe,children:"Incluir Usuário"}),children:n?e.jsx(V,{sx:{display:"flex",justifyContent:"center",mt:4},children:e.jsx(G,{})}):j?e.jsx(R,{severity:"error",children:j}):e.jsxs(V,{sx:{width:"100%",overflowX:"auto"},children:[e.jsx(Ee,{component:Se,children:e.jsxs(be,{sx:{minWidth:650},"aria-label":"simple table",children:[e.jsx(we,{children:e.jsxs(K,{children:[e.jsx(U,{children:"ID do Usuário"}),e.jsx(U,{children:"Name"}),e.jsx(U,{children:"Email"}),e.jsx(U,{children:"Ações"})]})}),e.jsx(Oe,{children:u.map(o=>e.jsxs(K,{sx:{"&:last-child td, &:last-child th":{border:0}},children:[e.jsx(U,{component:"th",scope:"row",children:o.id}),e.jsx(U,{children:o.name||"N/A"}),e.jsx(U,{children:o.email||"N/A"}),e.jsx(U,{children:e.jsx(Ce,{"aria-label":"more","aria-controls":"long-menu","aria-haspopup":"true",onClick:i=>C(i,o),children:e.jsx(Ue,{})})})]},o.id))})]})}),e.jsxs(ye,{id:"long-menu",anchorEl:y,open:!!y,onClose:I,children:[e.jsx(M,{onClick:te,children:"Editar"}),e.jsx(M,{onClick:ne,children:"Tools"}),e.jsx(M,{onClick:re,children:"Organizations"}),e.jsx(M,{onClick:ae,children:"Excluir"})]}),e.jsx(Ae,{open:T,onClose:o=>{o&&h(u.map(i=>i.id===o.id?o:i)),v(!1)},user:t}),e.jsx(ke,{open:x,onClose:()=>p(!1),onUserAdded:ie}),t&&e.jsx(ze,{open:r,onClose:()=>c(!1),onSave:le,userId:t.id}),t&&e.jsx(Le,{open:D,onClose:()=>s(!1),onSave:ce,userId:t.id})]})})};export{Me as default};
